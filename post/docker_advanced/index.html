<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="referrer" content="no-referrer-when-downgrade">
    

    <title>Docker进阶指南 | 魏奇的博客</title>
    <meta property="og:title" content="Docker进阶指南 - 魏奇的博客">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2022-06-25T13:39:22&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2022-06-25T13:39:22&#43;08:00'>
        
    <meta name="Keywords" content="golang,go语言,go语言笔记,java,android,博客,项目管理,python,软件架构,公众号,小程序">
    <meta name="description" content="Docker进阶指南">
        
    <meta name="author" content="魏奇">
    <meta property="og:url" content="https://blog.imw7.com/post/docker_advanced/">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    
    
        <link href="https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" rel="stylesheet">
    
    
    
    
        <link rel="stylesheet" href='/css/douban.css'>
    
        <link rel="stylesheet" href='/css/other.css'>
    
</head>

<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://blog.imw7.com/">
                        魏奇的博客
                    </a>
                
                <p class="description">海阔凭鱼跃，天高任鸟飞</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="https://blog.imw7.com/">首页</a>
                    
                    <a  href="https://blog.imw7.com/archives/" title="归档">归档</a>
                    
                    <a  href="https://blog.imw7.com/about/" title="关于">关于</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    <style type="text/css">
    .post-toc {
        position: absolute;
        top: 0;
        right: 0;
        width: 200px;
        margin-right: 0px;
        padding: 5px 10px;
        font-family: Athelas, STHeiti, Microsoft Yahei, serif;
        font-size: 12px;
        border: 1px solid rgba(0, 0, 0, .07);
        border-radius: 5px;
        background-color: rgba(255, 255, 255, 0.98);
        background-clip: padding-box;
        -webkit-box-shadow: 1px 1px 2px rgba(0, 0, 0, .125);
        box-shadow: 1px 1px 2px rgba(0, 0, 0, .125);
        word-wrap: break-word;
        white-space: nowrap;
        -webkit-box-sizing: border-box;
        box-sizing: border-box;
        z-index: 999;
        cursor: pointer;
        max-height: 45%;
        overflow-y: auto;
        overflow-x: hidden;
        float: right;
    }

    .post-toc .post-toc-title {
        width: 100%;
        margin: 0 auto;
        font-size: 18px;
        font-weight: 400;
        text-transform: uppercase;
        text-align: center;
    }

    .post-toc .post-toc-content {
        font-size: 12px;
    }

    .post-toc .post-toc-content>nav>ul {
        margin: 8px 0;
    }

    .post-toc .post-toc-content ul {
        padding-left: 10px;
        list-style: none;
        margin: 0.5em;
        line-height: 1.8em;
    }

    .post-toc .post-toc-content ul ul ul ul ul {
        margin-right: 10px;
        display: none;
    }

    @media print,
    screen and (max-width:1057px) {
        .post-toc {
            display: none;
        }
    }
</style>
<div class="post-toc" style="top: 280px; right: 0px; float: right;">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#docker复杂安装详说">Docker复杂安装详说</a>
      <ul>
        <li><a href="#安装mysql主从复制">安装MySQL主从复制</a></li>
        <li><a href="#安装redis集群">安装Redis集群</a></li>
        <li><a href="#3主3从redis集群扩缩容配置案例架构说明">3主3从Redis集群扩缩容配置案例架构说明</a></li>
        <li><a href="#步骤">步骤</a></li>
      </ul>
    </li>
    <li><a href="#dockerfile解析">Dockerfile解析</a>
      <ul>
        <li><a href="#是什么">是什么</a></li>
        <li><a href="#dockerfile构建过程解析">Dockerfile构建过程解析</a></li>
        <li><a href="#dockerfile常用保留字指令">Dockerfile常用保留字指令</a></li>
        <li><a href="#案例">案例</a></li>
        <li><a href="#小总结-2">小总结</a></li>
      </ul>
    </li>
    <li><a href="#docker微服务实战">Docker微服务实战</a>
      <ul>
        <li><a href="#通过idea新建一个普通微服务模块">通过IDEA新建一个普通微服务模块</a></li>
        <li><a href="#通过dockerfile发布微服务部署到docker容器">通过Dockerfile发布微服务部署到docker容器</a></li>
      </ul>
    </li>
    <li><a href="#docker网络">Docker网络</a>
      <ul>
        <li><a href="#是什么-2">是什么</a></li>
        <li><a href="#常用基础命令">常用基础命令</a></li>
        <li><a href="#能干嘛">能干嘛</a></li>
        <li><a href="#网络模式">网络模式</a></li>
        <li><a href="#docker平台架构图解">Docker平台架构图解</a></li>
      </ul>
    </li>
    <li><a href="#docker-compose容器编排">Docker-compose容器编排</a>
      <ul>
        <li><a href="#简介">简介</a></li>
        <li><a href="#compose核心概念">Compose核心概念</a></li>
        <li><a href="#compose使用的三步骤">Compose使用的三步骤</a></li>
        <li><a href="#compose常用命令">Compose常用命令</a></li>
        <li><a href="#compose编排微服务">Compose编排微服务</a></li>
      </ul>
    </li>
    <li><a href="#docker轻量级可视化工具portainer">Docker轻量级可视化工具Portainer</a>
      <ul>
        <li><a href="#是什么-3">是什么</a></li>
        <li><a href="#安装-1">安装</a></li>
        <li><a href="#登陆并演示介绍常用操作案例">登陆并演示介绍常用操作案例</a></li>
      </ul>
    </li>
    <li><a href="#docker容器监控之cadvisorinfluxdbgrafana">Docker容器监控之cAdvisor+InfluxDB+Grafana</a>
      <ul>
        <li><a href="#原生命令">原生命令</a></li>
        <li><a href="#是什么-4">是什么</a></li>
        <li><a href="#compose容器编排">compose容器编排</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
</div>
<script type="text/javascript">
    $(document).ready(function () {
        var postToc = $(".post-toc");
        if (postToc.length) {
            var rightPos = window.screenX+$("#main").offset().left;
            if(rightPos<220){
                postToc.css({"width":rightPos+10,"margin-right":0})
            }

            var t = postToc.offset().top - 20,
                a = {
                    start: {
                        position: "absolute",
                        top: t
                    },
                    process: {
                        position: "fixed",
                        top: 20
                    },
                };
            $(window).scroll(function () {
                var e = $(window).scrollTop();
                e < t ? postToc.css(a.start) : postToc.css(a.process)
            })
        }
    })
</script>
    <article class="post">
        <header>
            <h1 class="post-title">Docker进阶指南</h1>
        </header>
        <date class="post-meta meta-date">
            2022年6月25日
        </date>
        
        <div class="post-meta">
            <span>|</span>
            
            <span class="meta-category"><a href='/categories/Docker'>Docker</a></span>
            
        </div>
        
        
        <div class="post-meta">
            <span id="busuanzi_container_page_pv">| 本文阅读量 <span id="busuanzi_value_page_pv"></span><span> 次</span></span>
                     
        </div>
        
        
        <div class="clear" style="display: none;">
            <div class="toc-article" style="float: right;">
                <div class="toc-title">文章目录</div>
            </div>
        </div>
        
        <div class="post-content">
            <p>本文是 <code>Docker</code> 的进阶篇，通过本文能够更好的对 <code>Docker</code> 的高级功能有一个清楚的认识。</p>
<h2 id="docker复杂安装详说">Docker复杂安装详说</h2>
<h3 id="安装mysql主从复制">安装MySQL主从复制</h3>
<h4 id="主从复制">主从复制</h4>
<h5 id="主从复制的含义">主从复制的含义</h5>
<p>在 <code>MySQL</code> 多服务器的架构中，至少要有一个主节点「<code>master</code>」，跟主节点相对的，我们把它叫做从节点「<code>slave</code>」。主从复制，就是把主节点的数据复制到一个或者多个从节点。主服务器和从服务器可以在不同的 <code>IP</code> 上，通过远程连接来同步数据，这个是异步的过程。</p>
<h5 id="主从复制的形式">主从复制的形式</h5>
<p>1、一主一从/一主多从</p>
<p>​       
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/mysql1.png">
            <img class="mx-auto" alt="mysql1" src="https://blog.imw7.com/images/docker/mysql1.png" />
        </a>
    </p>
<p>2、多主一从</p>
<p>​        
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/mysql2.png">
            <img class="mx-auto" alt="mysql2" src="https://blog.imw7.com/images/docker/mysql2.png" />
        </a>
    </p>
<p>3、双主复制</p>
<p>​      
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/mysql3.png">
            <img class="mx-auto" alt="mysql3" src="https://blog.imw7.com/images/docker/mysql3.png" />
        </a>
    </p>
<p>4、级联复制</p>
<p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/mysql4.png">
            <img class="mx-auto" alt="mysql4" src="https://blog.imw7.com/images/docker/mysql4.png" />
        </a>
    </p>
<h5 id="主从复制的用途">主从复制的用途</h5>
<p>数据备份：把数据复制到不同的机器上，以免单台服务器发生故障时数据丢失。</p>
<p>读写分离：让主库负责写，从库负责读，从而提高读写的并发度。</p>
<p>高可用 <code>HA</code>：当节点故障时，自动转移到其他节点，提高可用性。</p>
<p>扩展：结合负载的机制，均摊所有的应用访问请求，降低单机 <code>IO</code>。</p>
<p>主从复制是怎么实现的呢？</p>
<ul>
<li><strong>binlog</strong></li>
</ul>
<p>客户端对 <code>MySQL</code> 数据库进行操作的时候，包括 <code>DDL</code> 和 <code>DML</code> 语句，服务端会在日志文件中用事件的形式记录所有的操作记录，这个文件就是 <code>binlog</code> 文件（属于逻辑日志，跟 <code>Redis</code> 的 <code>AOF</code> 文件类似）。</p>
<p>基于 <code>binlog</code>，我们可以实现主从复制和数据恢复。</p>
<p><code>Binlog</code> 默认是不开启的，需要在服务端手动配置。注意有一定的性能损耗。</p>
<ul>
<li><strong>binlog 配置</strong></li>
</ul>
<p>编辑 <code>/etc/my.cnf</code>：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>log-bin=<span style="color:#666;font-style:italic">/var/lib/mysql/mysql-bin</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>server-id=<span style="color:#666;font-style:italic">1</span>
</span></span></code></pre></div><p>重启 <code>MySQL</code> 服务 ：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ service mysqld stop
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>$ service mysqld start
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span><span style="color:#888;font-style:italic">## 如果出错查看日志 3</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>$ vi /var/log/mysqld.log
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>$ <span style="font-weight:bold;font-style:italic">cd</span> /var/lib/mysql
</span></span></code></pre></div><p>是否开启</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>mysql&gt; binlog <span style="font-weight:bold">show</span> variables <span style="font-weight:bold">like</span> <span style="color:#666;font-style:italic">&#39;log_bin%&#39;</span>;
</span></span></code></pre></div><p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/binlog1.png">
            <img class="mx-auto" alt="binlog1" src="https://blog.imw7.com/images/docker/binlog1.png" />
        </a>
    </p>
<ul>
<li><strong>binlog 格式</strong></li>
</ul>
<p><code>STATEMENT</code>：记录每一条修改数据的 <code>SQL</code> 语句（减少日志量，节约 <code>IO</code>）。</p>
<p><code>ROW</code>：记录哪条数据被修改了，修改成什么样子了（<code>5.7</code> 以后默认）。</p>
<p><code>MIXED</code>：结合两种方式，一般的语句用 <code>STATEMENT</code>，函数之类的用 <code>ROW</code>。</p>
<ul>
<li><strong>查看 binlog 格式：</strong></li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>mysql&gt; <span style="font-weight:bold">show</span> global variables <span style="font-weight:bold">like</span> <span style="color:#666;font-style:italic">&#39;%binlog_format%&#39;</span><span style="">；</span>
</span></span></code></pre></div><p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/binlog2.png">
            <img class="mx-auto" alt="binlog2" src="https://blog.imw7.com/images/docker/binlog2.png" />
        </a>
    </p>
<ul>
<li><strong>查看 binlog 列表：</strong></li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>mysql&gt; <span style="font-weight:bold">show</span> <span style="font-weight:bold">binary</span> logs;
</span></span></code></pre></div><p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/binlog3.png">
            <img class="mx-auto" alt="binlog3" src="https://blog.imw7.com/images/docker/binlog3.png" />
        </a>
    </p>
<ul>
<li><strong>查看binlog内容：</strong></li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>mysql&gt; <span style="font-weight:bold">show</span> binlog events <span style="font-weight:bold">in</span> <span style="color:#666;font-style:italic">&#39;mysql-bin.000001&#39;</span>;
</span></span></code></pre></div><p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/binlog4.png">
            <img class="mx-auto" alt="binlog4" src="https://blog.imw7.com/images/docker/binlog4.png" />
        </a>
    </p>
<p>用 <code>mysqlbinlog</code> 工具，基于时间查看 <code>binlog</code>，注意这个是 <code>Linux</code> 命令，不是 <code>SQL</code> 语句：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ /usr/bin/mysqlbinlog --start-datetime=<span style="color:#666;font-style:italic">&#39;2019-08-2213:30:00&#39;</span> --stop-datetime=<span style="color:#666;font-style:italic">&#39;2019-08-2214:01:01&#39;</span>-d <span style="font-weight:bold;font-style:italic">test</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>$ /var/lib/mysql/mysql-bin.000001
</span></span></code></pre></div><p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/binlog5.png">
            <img class="mx-auto" alt="binlog5" src="https://blog.imw7.com/images/docker/binlog5.png" />
        </a>
    </p>
<h5 id="主从复制原理">主从复制原理</h5>
<ul>
<li><strong>主从复制配置</strong></li>
</ul>
<p>1、主库开启 <code>binlog</code>，设置 <code>server-id</code></p>
<p>2、在主库创建具有复制权限的用户，允许从库连接</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>mysql&gt; <span style="font-weight:bold">GRANT</span> REPLICATION SLAVE, REPLICATION CLIENT <span style="font-weight:bold">ON</span> *.* <span style="font-weight:bold">TO</span> <span style="color:#666;font-style:italic">&#39;repl&#39;</span>@<span style="color:#666;font-style:italic">&#39;192.168.8.147&#39;</span> <span style="font-weight:bold">IDENTIFIED</span> <span style="font-weight:bold">BY</span> <span style="color:#666;font-style:italic">&#39;123456&#39;</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>mysql&gt; <span style="font-weight:bold">FLUSH</span> <span style="font-weight:bold">PRIVILEGES</span>;
</span></span></code></pre></div><p>3、从库 <code>/etc/my.cnf</code> 配置，重启数据库</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>server-id=<span style="color:#666;font-style:italic">2 </span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>log-bin=<span style="color:#666;font-style:italic">mysql-bin </span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>relay-log=<span style="color:#666;font-style:italic">mysql-relay-bin </span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>read-only=<span style="color:#666;font-style:italic">1 </span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>log-slave-updates=<span style="color:#666;font-style:italic">1</span>
</span></span></code></pre></div><p><code>log-slave-updates</code> 决定了在从 <code>binlog</code> 读取数据时，是否记录 <code>binlog</code>，实现双主和级联的关键。</p>
<p>4、在从库执行</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>mysql&gt; stop slave; 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>mysql&gt; <span style="font-weight:bold">change</span> master <span style="font-weight:bold">to</span> master_host=<span style="color:#666;font-style:italic">&#39;192.168.8.146&#39;</span>, master_user=<span style="color:#666;font-style:italic">&#39;repl&#39;</span>, master_password=<span style="color:#666;font-style:italic">&#39;123456&#39;</span>, master_log_file=<span style="color:#666;font-style:italic">&#39;mysql-bin.000001&#39;</span>, 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>master_log_pos=4; 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>mysql&gt; start slave;
</span></span></code></pre></div><p>5、查看同步状态</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>mysql&gt; <span style="font-weight:bold">SHOW</span> SLAVE STATUS <span style="">\</span>G;
</span></span></code></pre></div><p>以下为正常：</p>
<p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/binlog6.png">
            <img class="mx-auto" alt="binlog6" src="https://blog.imw7.com/images/docker/binlog6.png" />
        </a>
    </p>
<p>主从复制原理这里面涉及到几个线程：</p>
<p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/binlog7.png">
            <img class="mx-auto" alt="binlog7" src="https://blog.imw7.com/images/docker/binlog7.png" />
        </a>
    </p>
<ul>
<li>1、<code>slave</code> 服务器执行 <code>start slave</code>，开启主从复制开关， <code>slave</code> 服务器的 <code>IO</code> 线程请求从 <code>master</code> 服务器读取 <code>binlog</code>（如果该线程追赶上了主库，会进入睡眠状态）。</li>
<li>2、<code>master</code> 服务器创建 <code>Log Dump</code> 线程，把 <code>binlog</code> 发送给 <code>slave</code> 服务器。<code>slave</code> 服务器把读取到的 <code>binlog</code> 日志内容写入中继日志 <code>relay log</code>（会记录位置信息，以便下次继续读取）。</li>
<li>3、<code>slave</code> 服务器的 <code>SQL</code> 线程会实时检测 <code>relay log</code> 中新增的日志内容，把 <code>relay log</code> 解析成 <code>SQL</code> 语句，并执行。</li>
</ul>
<h4 id="主从搭建步骤">主从搭建步骤</h4>
<p>1、新建主服务器容器实例 <code>3307</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker run -p 3307:3306 --name master --restart always <span style="color:#666;font-style:italic">\
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span><span style="color:#666;font-style:italic"></span>-v /data/mysql/master/log:/var/log/mysql <span style="color:#666;font-style:italic">\
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span><span style="color:#666;font-style:italic"></span>-v /data/mysql/master/data:/var/lib/mysql <span style="color:#666;font-style:italic">\
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span><span style="color:#666;font-style:italic"></span>-v /data/mysql/master/conf:/etc/mysql <span style="color:#666;font-style:italic">\
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span><span style="color:#666;font-style:italic"></span>-e <span style="color:#666;font-weight:bold;font-style:italic">MYSQL_ROOT_PASSWORD</span>=root <span style="color:#666;font-style:italic">\
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span><span><span style="color:#666;font-style:italic"></span>-d mysql:5.7
</span></span></code></pre></div><p>2、进入 <code>/data/mysql/master/conf</code> 目录下新建 <code>my.cnf</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ <span style="font-weight:bold;font-style:italic">cd</span> /data/mysql/master/conf
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>$ vim my.cnf
</span></span></code></pre></div><p>将以下内容写入<code>my.cnf</code>文件中：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="font-weight:bold">[client]</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span><span style="color:#888;font-style:italic">## 设置默认编码为utf8</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>default_character_set=<span style="color:#666;font-style:italic">utf8</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span><span style="font-weight:bold">[mysqld]</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span><span style="color:#888;font-style:italic">####collation_server和character_set_server两个变量只用来为create database命令提供默认值####</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span><span style="color:#888;font-style:italic">## 服务器字符集</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>collation_server=<span style="color:#666;font-style:italic">utf8_general_ci</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span><span style="color:#888;font-style:italic">## 服务器指定的默认编码格式</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>character_set_server=<span style="color:#666;font-style:italic">utf8</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span><span style="color:#888;font-style:italic">## 设置server_id，同一局域网中需要唯一</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>server_id=<span style="color:#666;font-style:italic">101</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span><span style="color:#888;font-style:italic">## 指定不需要同步的数据库名称</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>binlog-ignore-db=<span style="color:#666;font-style:italic">mysql</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span><span style="color:#888;font-style:italic">## 开启二进制日志功能</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>log-bin=<span style="color:#666;font-style:italic">mysql-bin</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span><span style="color:#888;font-style:italic">## 设置二进制日志使用内存大小（事务）</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>binlog_cache_size=<span style="color:#666;font-style:italic">1M</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span><span style="color:#888;font-style:italic">## 设置使用的二进制日志格式（mixed,statement,row）</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>binlog_format=<span style="color:#666;font-style:italic">mixed</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span><span style="color:#888;font-style:italic">## 二进制日志过期清理时间。默认值为0，表示不自动清理。</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>expire_logs_days=<span style="color:#666;font-style:italic">7</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span><span style="color:#888;font-style:italic">## 跳过主从复制中遇到的所有错误或指定类型的错误，避免slave端复制终端。</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span><span style="color:#888;font-style:italic">## 如：1062错误是指一些主键重复，1032错误是因为主从数据库数据不一致</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>slave_skip_errors=<span style="color:#666;font-style:italic">1062</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span><span style="color:#888;font-style:italic">####mysql8.0必须添加以下内容，否则docker启动mysql8.0后会秒退####</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span><span style="color:#888;font-style:italic">## secure_file_priv 为 NULL 时，表示限制mysqld不允许导入或导出。</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span><span style="color:#888;font-style:italic">## secure_file_priv 为 /tmp 时，表示限制mysqld只能在/tmp目录中执行导入导出，其他目录不能执行。</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span><span style="color:#888;font-style:italic">## secure_file_priv 没有值时，表示不限制mysqld在任意目录的导入导出。</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span>secure_file_priv=<span style="color:#666;font-style:italic">&#39;&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span><span style="color:#888;font-style:italic">## 身份验证插件</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span>default_authentication_plugin=<span style="color:#666;font-style:italic">mysql_native_password</span>
</span></span></code></pre></div><p><strong>注</strong>：使用 <code>vim</code> 粘贴时，需要先按 <code>i</code> 进入插入模式，然后再粘贴，否则会有粘贴不全的情况。<strong>不能有错误</strong>，否则重启会失败。</p>
<p>3、修改完配置后重启 <code>master</code> 实例</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker restart master
</span></span></code></pre></div><p>4、进入 <code>master</code> 容器</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker <span style="font-weight:bold;font-style:italic">exec</span> -it master /bin/bash
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>$ mysql -uroot -proot
</span></span></code></pre></div><p><strong>注意</strong>：<code>mysql8.0 </code>以后的版本进入 <code>master</code> 容器之后，直接输入以下命令：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ mysql
</span></span></code></pre></div><p>即可进入容器内的 <code>MySQL</code> 数据库。连接数据库后需要进行以下操作已修改密码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span><span style="color:#888;font-style:italic">#使用mysql库
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span><span style="color:#888;font-style:italic"></span>mysql&gt; <span style="font-weight:bold">use</span> mysql;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span><span style="color:#888;font-style:italic">#清空密码
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span><span style="color:#888;font-style:italic"></span>mysql&gt; <span style="font-weight:bold">UPDATE</span> <span style="font-weight:bold">user</span> <span style="font-weight:bold">SET</span> authentication_string=<span style="color:#666;font-style:italic">&#39;&#39;</span> <span style="font-weight:bold">WHERE</span> <span style="font-weight:bold">user</span>=<span style="color:#666;font-style:italic">&#39;root&#39;</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span><span style="color:#888;font-style:italic">#修改访问主机以及密码等，设置为所有主机可访问
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span><span><span style="color:#888;font-style:italic"></span>mysql&gt; <span style="font-weight:bold">ALTER</span> <span style="font-weight:bold">USER</span> <span style="color:#666;font-style:italic">&#39;root&#39;</span>@<span style="color:#666;font-style:italic">&#39;%&#39;</span> <span style="font-weight:bold">IDENTIFIED</span> <span style="font-weight:bold">WITH</span> mysql_native_password <span style="font-weight:bold">BY</span> <span style="color:#666;font-style:italic">&#39;root&#39;</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span><span><span style="color:#888;font-style:italic">#刷新权限
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8</span><span><span style="color:#888;font-style:italic"></span>mysql&gt; <span style="font-weight:bold">flush</span> <span style="font-weight:bold">privileges</span>;
</span></span></code></pre></div><p>如果修改密码失败，出现了类似以下的错误：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>ERROR 1396 (HY000): Operation ALTER USER failed <span style="font-weight:bold">for</span> <span style="color:#666;font-style:italic">&#39;root&#39;</span>@<span style="color:#666;font-style:italic">&#39;%&#39;</span>
</span></span></code></pre></div><p>可以通过：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>mysql&gt; <span style="font-weight:bold">select</span> <span style="font-weight:bold">user</span>, host <span style="font-weight:bold">from</span> <span style="font-weight:bold">user</span>;
</span></span></code></pre></div><p>查看具体的 <code>root</code> 用户对应的 <code>host</code>，再根据响应的值做出调整。</p>
<p>5、<code>master</code> 容器实例内创建数据同步用户</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>mysql&gt; <span style="font-weight:bold">CREATE</span> <span style="font-weight:bold">USER</span> <span style="color:#666;font-style:italic">&#39;slave&#39;</span>@<span style="color:#666;font-style:italic">&#39;%&#39;</span> <span style="font-weight:bold">IDENTIFIED</span> <span style="font-weight:bold">WITH</span> mysql_native_password <span style="font-weight:bold">BY</span> <span style="color:#666;font-style:italic">&#39;Root@123456&#39;</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>mysql&gt; <span style="font-weight:bold">GRANT</span> REPLICATION SLAVE, REPLICATION CLIENT <span style="font-weight:bold">ON</span> *.* <span style="font-weight:bold">to</span> <span style="color:#666;font-style:italic">&#39;slave&#39;</span>@<span style="color:#666;font-style:italic">&#39;%&#39;</span>;
</span></span></code></pre></div><p>6、新建从服务器容器实例 <code>3308</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker run -p 3308:3306 --name slave --restart always <span style="color:#666;font-style:italic">\
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span><span style="color:#666;font-style:italic"></span>-v /data/mysql/slave/log:/var/log/mysql <span style="color:#666;font-style:italic">\
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span><span style="color:#666;font-style:italic"></span>-v /data/mysql/slave/data:/var/lib/mysql <span style="color:#666;font-style:italic">\
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span><span style="color:#666;font-style:italic"></span>-v /data/mysql/slave/conf:/etc/mysql <span style="color:#666;font-style:italic">\
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span><span style="color:#666;font-style:italic"></span>-e <span style="color:#666;font-weight:bold;font-style:italic">MYSQL_ROOT_PASSWORD</span>=root <span style="color:#666;font-style:italic">\
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span><span><span style="color:#666;font-style:italic"></span>-d mysql:5.7
</span></span></code></pre></div><p>7、进入 <code>/data/mysql/slave/conf</code> 目录下新建 <code>my.cnf</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>$ cd /data/mysql/slave/conf
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>$ vim my.cnf
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>$ cat my.cnf
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span><span style="font-weight:bold">[client]</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span><span style="color:#888;font-style:italic">## 设置默认编码为utf8</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>default_character_set=<span style="color:#666;font-style:italic">utf8</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span><span style="font-weight:bold">[mysqld]</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span><span style="color:#888;font-style:italic">####collation_server和character_set_server两个变量只用来为create database命令提供默认值####</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span><span style="color:#888;font-style:italic">## 服务器字符集</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>collation_server=<span style="color:#666;font-style:italic">utf8_general_ci</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span><span style="color:#888;font-style:italic">## 服务器指定的默认编码格式</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>character_set_server=<span style="color:#666;font-style:italic">utf8</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span><span style="color:#888;font-style:italic">## 设置server_id，同一局域网中需要唯一</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>server_id=<span style="color:#666;font-style:italic">102</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span><span style="color:#888;font-style:italic">## 指定不需要同步的数据库名称</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>binlog-ignore-db=<span style="color:#666;font-style:italic">mysql</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span><span style="color:#888;font-style:italic">## 开启二进制日志功能，以备Slave作为其它数据库实例的Master时使用</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>log-bin=<span style="color:#666;font-style:italic">mysql-slave1-bin</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span><span style="color:#888;font-style:italic">## 设置二进制日志使用内存大小（事务）</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>binlog_cache_size=<span style="color:#666;font-style:italic">1M</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span><span style="color:#888;font-style:italic">## 设置使用的二进制日志格式（mixed,statement,row）</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>binlog_format=<span style="color:#666;font-style:italic">mixed</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span><span style="color:#888;font-style:italic">## 二进制日志过期清理时间。默认值为0，表示不自动清理。</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>expire_logs_days=<span style="color:#666;font-style:italic">7</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span><span style="color:#888;font-style:italic">## 跳过主从复制中遇到的所有错误或指定类型的错误，避免slave端复制终端。</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span><span style="color:#888;font-style:italic">## 如：1062错误是指一些主键重复，1032错误是因为主从数据库数据不一致</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>slave_skip_errors=<span style="color:#666;font-style:italic">1062</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span><span style="color:#888;font-style:italic">## relay_log配置中继日志</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span>relay_log=<span style="color:#666;font-style:italic">mysql-relay-bin</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span><span style="color:#888;font-style:italic">## log_slave_updates表示slave将复制事件写进自己的二进制日志</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span>log_slave_updates=<span style="color:#666;font-style:italic">1</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span><span style="color:#888;font-style:italic">## slave设置为只读（具有super权限的用户除外）</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span><span>read_only=<span style="color:#666;font-style:italic">1</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span><span><span style="color:#888;font-style:italic">####mysql8.0必须添加以下内容，否则docker启动mysql8.0后会秒退####</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span><span><span style="color:#888;font-style:italic">## secure_file_priv 为 NULL 时，表示限制mysqld不允许导入或导出。</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span><span><span style="color:#888;font-style:italic">## secure_file_priv 为 /tmp 时，表示限制mysqld只能在/tmp目录中执行导入导出，其他目录不能执行。</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span><span><span style="color:#888;font-style:italic">## secure_file_priv 没有值时，表示不限制mysqld在任意目录的导入导出。</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span><span>secure_file_priv=<span style="color:#666;font-style:italic">&#39;&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span><span><span style="color:#888;font-style:italic">## 身份验证插件</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span><span>default_authentication_plugin=<span style="color:#666;font-style:italic">mysql_native_password</span>
</span></span></code></pre></div><p>8、修改完配置后重启 <code>slave</code> 实例</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker restart slave
</span></span></code></pre></div><p>9、在主数据库中查看主从同步状态</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>mysql&gt; <span style="font-weight:bold">show</span> master status;
</span></span></code></pre></div><p>10、进入 <code>slave</code> 容器</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker <span style="font-weight:bold;font-style:italic">exec</span> -it slave /bin/bash
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>$ mysql -uroot -proot
</span></span></code></pre></div><p>11、在从数据库中配置主从复制</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>mysql&gt; <span style="font-weight:bold">CHANGE</span> REPLICATION SOURCE <span style="font-weight:bold">TO</span> SOURCE_HOST=<span style="color:#666;font-style:italic">&#39;172.30.108.127&#39;</span>, SOURCE_USER=<span style="color:#666;font-style:italic">&#39;slave&#39;</span>, SOURCE_PASSWORD=<span style="color:#666;font-style:italic">&#39;Root@123456&#39;</span>, SOURCE_PORT=3307, SOURCE_LOG_FILE=<span style="color:#666;font-style:italic">&#39;mysql-bin.000001&#39;</span>, SOURCE_LOG_POS=617, SOURCE_CONNECT_RETRY=30;
</span></span></code></pre></div><p>上述是 <code>8.0.23</code> 之后的语法。如果 <code>mysql</code> 是 <code>8.0.23</code> 之前的版本，执行如下 <code>SQL</code>：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>mysql&gt; <span style="font-weight:bold">CHANGE</span> MASTER <span style="font-weight:bold">TO</span> MASTER_HOST=<span style="color:#666;font-style:italic">&#39;172.30.108.127&#39;</span>, MASTER_USER=<span style="color:#666;font-style:italic">&#39;slave&#39;</span>, MASTER_PASSWORD=<span style="color:#666;font-style:italic">&#39;Root@123456&#39;</span>, MASTER_PORT=3307, MASTER_LOG_FILE=<span style="color:#666;font-style:italic">&#39;mysql-bin.000001&#39;</span>, MASTER_LOG_POS=617, MASTER_CONNECT_RETRY=30;
</span></span></code></pre></div><p>主从复制命令参数说明：</p>
<p><code>master_host</code>：主数据库的 <code>IP</code> 地址；</p>
<p><code>master_port</code>：主数据库的运行端口；</p>
<p><code>master_user</code>：在主数据库创建的用于同步数据的用户账号；</p>
<p><code>master_password</code>：在主数据库创建的用于同步数据的用户密码；</p>
<p><code>master_log_file</code>：指定从数据库要复制数据的日志文件，通过查看主数据的状态，获取 <code>File</code> 参数；</p>
<p><code>master_log_pos</code>：指定从数据库从哪个位置开始复制数据，通过查看主数据的状态，获取 <code>Position</code> 参数；</p>
<p><code>master_connect_retry</code>：连接失败重试的时间间隔，单位为秒。</p>
<p>12、在从数据库中查看主从同步状态</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>mysql&gt; <span style="font-weight:bold">show</span> slave status <span style="">\</span>G;
</span></span></code></pre></div><p>主要看 <code>Slave_IO_Running</code> 和 <code>Slave_SQL_Running</code>，结果均为 <code>No</code>，说明还没开始。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>mysql&gt; <span style="font-weight:bold">show</span> slave status <span style="">\</span>G;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>*************************** 1. row ***************************
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>               Slave_IO_State: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>                  Master_Host: 172.30.108.127
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>                  Master_User: slave
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>                  Master_Port: 3307
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>                Connect_Retry: 30
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>              Master_Log_File: mall-mysql-bin.000001
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>          Read_Master_Log_Pos: 617
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>               Relay_Log_File: mall-mysql-relay-bin.000001
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>                Relay_Log_Pos: 4
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>        Relay_Master_Log_File: mall-mysql-bin.000001
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>             Slave_IO_Running: No
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>            Slave_SQL_Running: No
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>              Replicate_Do_DB: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>          Replicate_Ignore_DB: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>           Replicate_Do_Table: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>       Replicate_Ignore_Table: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>      Replicate_Wild_Do_Table: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>  Replicate_Wild_Ignore_Table: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>                   Last_Errno: 0
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>                   Last_Error: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>                 Skip_Counter: 0
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>          Exec_Master_Log_Pos: 617
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>              Relay_Log_Space: 154
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>              Until_Condition: None
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>               Until_Log_File: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span>                Until_Log_Pos: 0
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span>           Master_SSL_Allowed: No
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span>           Master_SSL_CA_File: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span>           Master_SSL_CA_Path: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span>              Master_SSL_Cert: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span><span>            Master_SSL_Cipher: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span><span>               Master_SSL_Key: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span><span>        Seconds_Behind_Master: <span style="color:#666;font-weight:bold;font-style:italic">NULL</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span><span>Master_SSL_Verify_Server_Cert: No
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span><span>                Last_IO_Errno: 0
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span><span>                Last_IO_Error: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span><span>               Last_SQL_Errno: 0
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span><span>               Last_SQL_Error: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span><span>  Replicate_Ignore_Server_Ids: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span><span>             Master_Server_Id: 0
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span><span>                  Master_UUID: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span><span>             Master_Info_File: /var/lib/mysql/master.info
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span><span>                    SQL_Delay: 0
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span><span>          SQL_Remaining_Delay: <span style="color:#666;font-weight:bold;font-style:italic">NULL</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span><span>      Slave_SQL_Running_State: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48</span><span>           Master_Retry_Count: 86400
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49</span><span>                  Master_Bind: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50</span><span>      Last_IO_Error_Timestamp: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51</span><span>     Last_SQL_Error_Timestamp: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52</span><span>               Master_SSL_Crl: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53</span><span>           Master_SSL_Crlpath: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54</span><span>           Retrieved_Gtid_Set: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55</span><span>            Executed_Gtid_Set: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56</span><span>                Auto_Position: 0
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57</span><span>         Replicate_Rewrite_DB: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58</span><span>                 Channel_Name: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59</span><span>           Master_TLS_Version: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60</span><span>1 row <span style="font-weight:bold">in</span> <span style="font-weight:bold">set</span> (0.00 sec)
</span></span></code></pre></div><p><strong>注意</strong>：如果是 <code>MySQL8.0</code> 以上版本，出现类似 <code>Last_IO_Error: error connecting to master 'slave@192.168.3.6:3309' - retry-time: 30  retries: 3 message: Authentication plugin 'caching_sha2_password'  reported error: Authentication requires secure connection.</code> 错误的解决办法：</p>
<p>查看主库：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>mysql&gt; <span style="font-weight:bold">SELECT</span> plugin <span style="font-weight:bold">FROM</span> `<span style="font-weight:bold">user</span>` <span style="font-weight:bold">where</span> <span style="font-weight:bold">user</span>=<span style="color:#666;font-style:italic">&#39;root&#39;</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>+-----------------------+
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>| plugin                |
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>+-----------------------+
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>| mysql_native_password |
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span><span>| caching_sha2_password |
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span><span>+-----------------------+
</span></span></code></pre></div><p>原来是主库 <code>root</code> 的 <code>plugin</code> 是 <code>caching_sha2_password</code> 导致连接不上，修改为 <code>mysql_native_password</code> 即可解决。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>mysql&gt; <span style="font-weight:bold">ALTER</span> <span style="font-weight:bold">USER</span> <span style="color:#666;font-style:italic">&#39;root&#39;</span>@<span style="color:#666;font-style:italic">&#39;%&#39;</span> <span style="font-weight:bold">IDENTIFIED</span> <span style="font-weight:bold">WITH</span> mysql_native_password <span style="font-weight:bold">BY</span> <span style="color:#666;font-style:italic">&#39;root&#39;</span>; 
</span></span></code></pre></div><p>其中，<code>root</code> 可以改为<code>slave</code>， <code>%</code> 可以改为 <code>localhost</code>，根据实际情况而定。</p>
<p>13、在从数据库中开启主从同步</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>mysql&gt; start replica; <span style="color:#888;font-style:italic">#8.0.22之后
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span><span style="color:#888;font-style:italic"></span>mysql&gt; start slave; <span style="color:#888;font-style:italic">#8.0.22之前
</span></span></span></code></pre></div><p>14、查看从数据库状态发现已经同步</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>mysql&gt; <span style="font-weight:bold">show</span> slave status <span style="">\</span>G;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>*************************** 1. row ***************************
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>               Slave_IO_State: Waiting <span style="font-weight:bold">for</span> master <span style="font-weight:bold">to</span> send event
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>                  Master_Host: 172.30.108.127
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>                  Master_User: slave
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>                  Master_Port: 3307
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>                Connect_Retry: 30
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>              Master_Log_File: mall-mysql-bin.000001
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>          Read_Master_Log_Pos: 617
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>               Relay_Log_File: mall-mysql-relay-bin.000002
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>                Relay_Log_Pos: 325
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>        Relay_Master_Log_File: mall-mysql-bin.000001
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>             Slave_IO_Running: Yes
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>            Slave_SQL_Running: Yes
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>              Replicate_Do_DB: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>          Replicate_Ignore_DB: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>           Replicate_Do_Table: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>       Replicate_Ignore_Table: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>      Replicate_Wild_Do_Table: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>  Replicate_Wild_Ignore_Table: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>                   Last_Errno: 0
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>                   Last_Error: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>                 Skip_Counter: 0
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>          Exec_Master_Log_Pos: 617
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>              Relay_Log_Space: 537
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>              Until_Condition: None
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>               Until_Log_File: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span>                Until_Log_Pos: 0
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span>           Master_SSL_Allowed: No
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span>           Master_SSL_CA_File: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span>           Master_SSL_CA_Path: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span>              Master_SSL_Cert: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span><span>            Master_SSL_Cipher: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span><span>               Master_SSL_Key: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span><span>        Seconds_Behind_Master: 0
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span><span>Master_SSL_Verify_Server_Cert: No
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span><span>                Last_IO_Errno: 0
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span><span>                Last_IO_Error: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span><span>               Last_SQL_Errno: 0
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span><span>               Last_SQL_Error: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span><span>  Replicate_Ignore_Server_Ids: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span><span>             Master_Server_Id: 101
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span><span>                  Master_UUID: 9fac5357-f698-11ec-8dca-0242ac110002
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span><span>             Master_Info_File: /var/lib/mysql/master.info
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span><span>                    SQL_Delay: 0
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span><span>          SQL_Remaining_Delay: <span style="color:#666;font-weight:bold;font-style:italic">NULL</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span><span>      Slave_SQL_Running_State: Slave has <span style="font-weight:bold">read</span> <span style="font-weight:bold">all</span> relay log; waiting <span style="font-weight:bold">for</span> more updates
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48</span><span>           Master_Retry_Count: 86400
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49</span><span>                  Master_Bind: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50</span><span>      Last_IO_Error_Timestamp: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51</span><span>     Last_SQL_Error_Timestamp: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52</span><span>               Master_SSL_Crl: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53</span><span>           Master_SSL_Crlpath: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54</span><span>           Retrieved_Gtid_Set: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55</span><span>            Executed_Gtid_Set: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56</span><span>                Auto_Position: 0
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57</span><span>         Replicate_Rewrite_DB: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58</span><span>                 Channel_Name: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59</span><span>           Master_TLS_Version: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60</span><span>1 row <span style="font-weight:bold">in</span> <span style="font-weight:bold">set</span> (0.00 sec)
</span></span></code></pre></div><p>再次查看 <code>Slave_IO_Running</code> 和 <code>Slave_SQL_Running</code> 的状态，均为 <code>Yes</code>。说明已经同步完成。</p>
<p>15、主从复制测试</p>
<p>① 主机新建库-使用库-新建表-插入数据，OK</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>mysql&gt; <span style="font-weight:bold">create</span> <span style="font-weight:bold">database</span> db01;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>Query OK, 1 row <span style="color:#666;font-weight:bold;font-style:italic">affected</span> (0.00 sec)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>mysql&gt; <span style="font-weight:bold">use</span> db01;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span><span style="font-weight:bold">Database</span> changed
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>mysql&gt; <span style="font-weight:bold">create</span> <span style="font-weight:bold">table</span> <span style="color:#666;font-weight:bold;font-style:italic">t1</span> (id <span style="font-weight:bold">int</span>, name <span style="font-weight:bold">varchar</span>(20));
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>Query OK, 0 rows <span style="color:#666;font-weight:bold;font-style:italic">affected</span> (0.04 sec)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>mysql&gt; <span style="font-weight:bold">insert</span> <span style="font-weight:bold">into</span> t1 <span style="font-weight:bold">values</span>(1, <span style="color:#666;font-style:italic">&#39;z3&#39;</span>);
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>Query OK, 1 row <span style="color:#666;font-weight:bold;font-style:italic">affected</span> (0.02 sec)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>mysql&gt; <span style="font-weight:bold">select</span> * <span style="font-weight:bold">from</span> t1;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>+------+------+
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>| id   | name |
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>+------+------+
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>|    1 | z3   |
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>+------+------+
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>1 row <span style="font-weight:bold">in</span> <span style="font-weight:bold">set</span> (0.00 sec)
</span></span></code></pre></div><p>② 从机使用库-查看记录，OK</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>mysql&gt; <span style="font-weight:bold">use</span> db01;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>Reading <span style="font-weight:bold">table</span> information <span style="font-weight:bold">for</span> completion of <span style="font-weight:bold">table</span> <span style="font-weight:bold">and</span> <span style="font-weight:bold">column</span> names
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>You can turn off this feature <span style="font-weight:bold">to</span> get a quicker startup <span style="font-weight:bold">with</span> -A
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span><span style="font-weight:bold">Database</span> changed
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>mysql&gt; <span style="font-weight:bold">select</span> * <span style="font-weight:bold">from</span> t1;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>+------+------+
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>| id   | name |
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>+------+------+
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>|    1 | z3   |
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>+------+------+
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>1 row <span style="font-weight:bold">in</span> <span style="font-weight:bold">set</span> (0.00 sec)
</span></span></code></pre></div><p><strong>扩展</strong>：如果使用 <code>Navicat</code> 连接 <code>mysql </code> 时出现 <code>1045 - Access denied for user ‘root‘@‘localhost‘ (using password: YES)</code> 错误，可以通过以下方法解决：</p>
<ul>
<li>通过命令行修改用户的密码和加密方式解决</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>mysql&gt; <span style="font-weight:bold">ALTER</span> <span style="font-weight:bold">USER</span> <span style="color:#666;font-style:italic">&#39;root&#39;</span>@<span style="color:#666;font-style:italic">&#39;%&#39;</span> <span style="font-weight:bold">IDENTIFIED</span> <span style="font-weight:bold">WITH</span> mysql_native_password <span style="font-weight:bold">BY</span> <span style="color:#666;font-style:italic">&#39;root&#39;</span>;
</span></span></code></pre></div><p><code>mysql8.0</code>的新特性，<code>caching_sha2_password</code> 密码加密方式。</p>
<ul>
<li>通过修改配置文件解决</li>
</ul>
<p>以前版本的 <code>mysql</code> 密码加密使用的是 <code>mysql_native_password</code>，新添加的用户密码默认使用的 <code>caching_sha2_password</code>。如果在以前 <code>mysql</code> 基础上升级的，就必须确保用户使用的密码加密使用的是 <code>mysql_native_password</code>。</p>
<p>如果还要使用以前的密码加密方式，就修改文件配置文件 <code>my.cnf</code> 即可，如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span><span style="font-weight:bold">[mysqld]</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>default_authentication_plugin=<span style="color:#666;font-style:italic">mysql_native_password</span>
</span></span></code></pre></div><h3 id="安装redis集群">安装Redis集群</h3>
<blockquote>
<p>cluster(集群)模式-docker版</p>
<p>哈希槽分区进行亿级数据存储</p>
</blockquote>
<h4 id="面试题">面试题</h4>
<p>1~2亿条数据需要缓存，请问如何设计这个存储案例？</p>
<p><strong>回答</strong>：单机单台100%不可能，肯定是分布式存储，用 <code>redis</code> 如何落地？</p>
<p>上述问题阿里P6~P7工程案例和场景设计类必考题目，一般业界有3种解决方案：</p>
<h5 id="哈希取余分区">哈希取余分区</h5>
<p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/hash_partitioning.jpg">
            <img class="mx-auto" alt="hash_partitioning" src="https://blog.imw7.com/images/docker/hash_partitioning.jpg" />
        </a>
    </p>
<p>2亿条记录就是2亿个 <code>k-v</code>，单机不行必须要分布式多机，假设有3台机器构成一个集群，用户每次读写操作都是根据公式：<code>hash(key) % N个机器台数</code>，计算出哈希值，用来决定数据映射到哪一个节点上。</p>
<p><strong>优点</strong>：简单粗暴，直接有效，只需要预估好数据规划好节点，例如3台、8台、10台，就能保证一段时间的数据支撑。使用Hash算法让固定的一部分请求落到同一台服务器上，这样每台服务器固定处理一部分请求（并维护这些请求的信息），起到负载均衡+分而治之的作用。</p>
<p><strong>缺点</strong>：原来规划好的节点，进行扩容或者缩容就比较麻烦了。不管扩容、每次数据变动导致节点有变动，映射关系需要重新进行计算，在服务器个数固定不变时没有问题，如果需要弹性扩容或故障停机的情况下，原来的取模公式就会发生变化：<code>Hash(key)/3</code>会变成<code>Hash(key)/?</code>。此时地址经过取余运算的结果将发生很大变化，根据公式获取的服务器也会变得不可控。</p>
<p>某个 <code>redis</code> 机器宕机了，由于台数数量变化，会导致hash取余全部数据重新洗牌。</p>
<h5 id="一致性哈希算法分区">一致性哈希算法分区</h5>
<p>1、是什么</p>
<p>一致性哈希算法在1997年由麻省理工学院提出，设计目标是解决分布式缓存数据<strong>变动和映射问题</strong>。某个机器宕机了，分母数量改变了，自然取余数就不行了。</p>
<p>2、能干嘛</p>
<p>提出一致性 <code>Hash</code> 解决方案。目的是当服务器个数发生变动时，尽量减少影响客户端到服务端的映射关系。</p>
<p>3、<strong>三步骤</strong></p>
<p>step 1：算法构建一致性哈希环</p>
<p>一致性哈希算法必然有一个 <code>hash</code> 函数并按照算法产生 <code>hash</code> 值，这个算法的所有可能哈希值会构成一个全量集，这个集合可以成为一个 <code>hash</code> 空间 [0,$2^{32}−1$]，这个是一个线性空间，但是在算法钟，我们通过适当的逻辑控制将它首尾相连(0=$2^{32}$)，这样让它逻辑上形成了一个环形空间。</p>
<p>它也是按照使用取模的方法，前面介绍的节点取模法是对节点（服务器）的数量进行取模。而一致性 <code>Hash</code> 算法是对$2^{32}$取模，简单来说，<strong>一致性 <code>Hash</code> 算法将整个哈希值空间组织成一个虚拟的圆环</strong>，如假设某哈希函数H的值空间为$[0,2^{32}−1]$（即哈希值是一个32位无符号整形），整个哈希环如下图：整个空间<strong>按顺时针方向组织</strong>，圆环的正上方的点代表0，0点右侧的第一个点代表1，以此类推，2、3、4.……直到 $2^{32}−1$，也就是说0点左侧的第一个点代表 $2^{32}−1$，0 和 $2^{32}−1$ 在零点钟方向重合，我们把这个由 $2^{32}$ 个点组成的圆环称为 <code>Hash</code> 环。</p>
<p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/hash_ring1.jpg">
            <img class="mx-auto" alt="hash_ring1" src="https://blog.imw7.com/images/docker/hash_ring1.jpg" />
        </a>
    </p>
<p>step 2：服务器 <code>IP</code> 节点映射</p>
<p>将集群中各个 <code>IP</code> 节点映射到环上的某一个位置。</p>
<p>将各个服务器使用 <code>Hash</code> 进行一个哈希，具体可以选择服务器的 <code>IP</code> 或主机名作为关键字进行哈希，这样每台机器就能确定其在哈希环上的位置。假如4个节点<code>Node A</code>、<code>Node B</code>、<code>Node C</code>、<code>Node D</code>，经过 <code>IP</code> 地址的<strong>哈希函数</strong>计算「<code>hash(ip)</code>」，使用 <code>IP</code> 地址哈希后在环空间的位置如下：</p>
<p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/hash_ring2.jpg">
            <img class="mx-auto" alt="hash_ring2" src="https://blog.imw7.com/images/docker/hash_ring2.jpg" />
        </a>
    </p>
<p>step 3：<code>key</code> 落到服务器的落键规则</p>
<p>当需要存储一个 <code>k-v</code> 键值对时，首先计算 <code>key</code> 的 <code>hash</code> 值，<code>hash(key)</code>，将这个 <code>key</code> 使用相同的函数 <code>Hash</code> 计算出哈希值并确定此数据在环上的位置，<strong>从此位置沿环顺时针”行走”</strong>，第一台遇到的服务器就是其应该定位到的服务器，并将该键值对存储在该节点上。</p>
<p>如有 <code>Object A</code>、<code>Object B</code>、<code>Object C</code>、<code>Object D</code> 四个数据对象，经过哈希计算后，在环空间上的位置如下：根据一致性 <code>Hash</code> 算法，数据A会被定位到 <code>Node A</code>上，B被定位到 <code>Node B</code> 上，<code>C</code> 被定位到 <code>Node C</code> 上，<code>D</code> 被定位到 <code>Node D</code> 上。</p>
<p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/hash_ring3.jpg">
            <img class="mx-auto" alt="hash_ring3" src="https://blog.imw7.com/images/docker/hash_ring3.jpg" />
        </a>
    </p>
<p>4、优点</p>
<p>①一致性哈希算法的<strong>容错性</strong></p>
<p>假如 <code>Node C</code> 宕机，可以看出此时对象 <code>A</code>、<code>B</code>、<code>D</code> 不会受到影响，只有 <code>C</code> 对象被重新定位到 <code>Node D</code>。一般的，在一致性 <code>Hash</code> 算法中，如果一台服务器不可用，则<strong>受影响的数据仅仅是此服务器到其环空间中前一台服务器（即沿着逆时针方向行走遇到的第一台服务器）之间的数据</strong>，其它不会受到影响。简单说，就是 <code>C</code> 挂了，受到影响的只是 <code>B</code>、<code>C</code> 之间的数据，并且这些数据会转移到 <code>D</code> 进行存储。</p>
<p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/hash_ring4.jpg">
            <img class="mx-auto" alt="hash_ring4" src="https://blog.imw7.com/images/docker/hash_ring4.jpg" />
        </a>
    </p>
<p>②一致性哈希算法的<strong>扩展性</strong></p>
<p>数据量增加了，需要增加一台节点 <code>Node X</code>，<code>X</code> 的位置在 <code>A</code> 和 <code>B</code> 之间，那收到影响的也就是 <code>A</code> 到 <code>X</code> 之间的数据，重新把 <code>A</code> 到 <code>X</code> 的数据录入到 <code>X</code> 上即可，不会导致 <code>hash</code> 取余全部数据重新洗牌。</p>
<p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/hash_ring5.jpg">
            <img class="mx-auto" alt="hash_ring5" src="https://blog.imw7.com/images/docker/hash_ring5.jpg" />
        </a>
    </p>
<p>5、缺点</p>
<p>一致性哈希算法的<strong>数据倾斜</strong>问题：</p>
<p>一致性 <code>Hash</code> 算法在服务<strong>节点太少时</strong>，容易因为节点分布不均匀而造成<strong>数据倾斜</strong>（被缓存的对象大部分集中缓存在某一台服务器上）问题，例如系统中只有两台服务器：</p>
<p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/hash_ring6.jpg">
            <img class="mx-auto" alt="hash_ring6" src="https://blog.imw7.com/images/docker/hash_ring6.jpg" />
        </a>
    </p>
<p>6、小总结</p>
<p>为了在节点数目发生改变时尽可能少的迁移数据。将所有的存储节点排列在首尾相连的 <code>Hash</code> 环上，每个 <code>key</code> 在计算 <code>Hash</code> 后会顺时针找到临近的存储节点存放。而当有节点加入或退出时仅影响该节点在 <code>Hash</code> 环上<strong>顺时针相邻的后续节点</strong>。</p>
<p><strong>优点</strong>：加入和删除节点只影响哈希环中顺时针方向的相邻的节点，对其他节点无影响。</p>
<p><strong>缺点</strong>：数据的分布和节点的位置有关，因为这些节点不是均匀的分布在哈希环上的，所以数据在进行存储时达不到均匀分布的效果。</p>
<h5 id="哈希槽分区">哈希槽分区</h5>
<p>1、是什么</p>
<p>①为什么会出现</p>
<p>一致性哈希算法的<strong>数据倾斜</strong>问题。</p>
<p>哈希槽实质就是一个数组，数组 $[0,2^{14}−1]$ 形成 <code>hash slot</code> 空间。</p>
<p>②能干什么</p>
<p>解决均匀分配的问题，<strong>在数据和节点之间又加入了一层，把这层称为哈希槽 「<code>slot</code>」，用于管理数据和节点之间的关系</strong>，现在就相当于节点上放的是槽，槽里放的是数据。</p>
<p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/slot1.png">
            <img class="mx-auto" alt="slot1" src="https://blog.imw7.com/images/docker/slot1.png" />
        </a>
    </p>
<p>槽解决的是粒度问题，相当于把粒度变大了，这样便于数据移动。</p>
<p>哈希解决的是映射问题，使用 <code>key</code> 的哈希值来计算所在的槽，便于数据分配。</p>
<p>③多少个 <code>hash</code> 槽</p>
<p>一个集群只能有 <code>16384</code> 个槽，编号<code>0-16383</code> 「$[0,2^{14}−1]$ 」。这些槽会分配给集群中的所有主节点，分配策略没有要求。可以指定哪些编号的槽分配给哪个主节点。集群会记录节点和槽的对应关系。解决了节点和槽的关系后，接下来就需要对 <code>key</code> 求哈希值，然后对 <code>16384</code> 取余，余数是几，<code>key</code> 就落入对应的槽里。<code>slot = CRC16(key) % 16384</code>。以槽为单位移动数据，因为槽的数目是固定的，处理起来比较容易，这样数据移动问题就解决了。</p>
<p>2、哈希槽计算</p>
<p><code>Redis</code> 集群中内置了 <code>16384</code> 个哈希槽，<code>Redis</code> 会根据节点数量大致均等的将哈希槽映射到不同的节点。当需要在 <code>Redis</code> 集群中放置一个 <code>key-value</code> 时，<code>Redis</code> 先对 <code>key</code> 使用 <code>crc16</code> 算法算出一个结果，然后把结果对 <code>16384</code> 求余数，这样每个 <code>key</code> 都会对应一个编号在 <code>0-16383</code> 之间的哈希槽，也就是映射到某个节点上。如下代码，<code>key</code> 之<code>A</code>、<code>B</code> 在 <code>Node2</code>，<code>key</code> 之 <code>C</code> 落在 <code>Node3</code> 上。</p>
<p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/slot2.jpg">
            <img class="mx-auto" alt="slot2" src="https://blog.imw7.com/images/docker/slot2.jpg" />
        </a>
    </p>
<h3 id="3主3从redis集群扩缩容配置案例架构说明">3主3从Redis集群扩缩容配置案例架构说明</h3>
<p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/redis_cluster.png">
            <img class="mx-auto" alt="redis_cluster" src="https://blog.imw7.com/images/docker/redis_cluster.png" />
        </a>
    </p>
<h3 id="步骤">步骤</h3>
<h4 id="3主3从redis集群配置">3主3从Redis集群配置</h4>
<p>1、关闭防火墙+启动 <code>Docker</code> 后台服务</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ systemctl start docker
</span></span></code></pre></div><p>2、新建6个 <code>Docker</code> 容器实例</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker run -d --name redis-node-1 --net host --privileged=<span style="font-weight:bold;font-style:italic">true</span> -v /data/redis/share/redis-node-1:/data redis:6.0.8 --cluster-enabled yes --appendonly yes --port 6381
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>$ docker run -d --name redis-node-2 --net host --privileged=<span style="font-weight:bold;font-style:italic">true</span> -v /data/redis/share/redis-node-2:/data redis:6.0.8 --cluster-enabled yes --appendonly yes --port 6382
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>$ docker run -d --name redis-node-3 --net host --privileged=<span style="font-weight:bold;font-style:italic">true</span> -v /data/redis/share/redis-node-3:/data redis:6.0.8 --cluster-enabled yes --appendonly yes --port 6383
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>$ docker run -d --name redis-node-4 --net host --privileged=<span style="font-weight:bold;font-style:italic">true</span> -v /data/redis/share/redis-node-4:/data redis:6.0.8 --cluster-enabled yes --appendonly yes --port 6384
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>$ docker run -d --name redis-node-5 --net host --privileged=<span style="font-weight:bold;font-style:italic">true</span> -v /data/redis/share/redis-node-5:/data redis:6.0.8 --cluster-enabled yes --appendonly yes --port 6385
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span><span>$ docker run -d --name redis-node-6 --net host --privileged=<span style="font-weight:bold;font-style:italic">true</span> -v /data/redis/share/redis-node-6:/data redis:6.0.8 --cluster-enabled yes --appendonly yes --port 6386
</span></span></code></pre></div><p>如果运行成功，效果如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker ps
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>CONTAINER ID   IMAGE         COMMAND                  CREATED         STATUS         PORTS     NAMES
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>b28d2108811b   redis:6.0.8   <span style="color:#666;font-style:italic">&#34;docker-entrypoint.s…&#34;</span>   4 seconds ago   Up 4 seconds             redis-node-6
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>24c1a37b99a5   redis:6.0.8   <span style="color:#666;font-style:italic">&#34;docker-entrypoint.s…&#34;</span>   7 seconds ago   Up 7 seconds             redis-node-5
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>daa39c009d24   redis:6.0.8   <span style="color:#666;font-style:italic">&#34;docker-entrypoint.s…&#34;</span>   7 seconds ago   Up 7 seconds             redis-node-4
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span><span>e8ed44b0a6c0   redis:6.0.8   <span style="color:#666;font-style:italic">&#34;docker-entrypoint.s…&#34;</span>   8 seconds ago   Up 7 seconds             redis-node-3
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span><span>1525ab8ecfaf   redis:6.0.8   <span style="color:#666;font-style:italic">&#34;docker-entrypoint.s…&#34;</span>   8 seconds ago   Up 8 seconds             redis-node-2
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8</span><span>dcafc91c1562   redis:6.0.8   <span style="color:#666;font-style:italic">&#34;docker-entrypoint.s…&#34;</span>   8 seconds ago   Up 8 seconds             redis-node-1
</span></span></code></pre></div><p>命令分步解释：</p>
<ul>
<li><code>docker run</code>：创建并运行 <code>Docker</code> 容器实例</li>
<li><code>--name redis-node-6</code>：容器名字</li>
<li><code>--net host</code>：使用宿主机的 <code>IP</code> 和端口，默认</li>
<li><code>--privileged=true</code>：获取宿主机 <code>root</code> 用户权限</li>
<li><code>-v /data/redis/share/redis-node-6:/data</code>：容器卷，宿主机地址：<code>Docker</code> 内部地址</li>
<li><code>redis:6.0.8</code>：<code>Redis</code> 镜像和版本号</li>
<li><code>--cluster-enabled yes</code>：开启 <code>Redis</code> 集群</li>
<li><code>--appendonly yes</code>：开启持久化</li>
<li><code>--port 6386</code>：<code>Redis</code> 端口号</li>
</ul>
<p>3、进入容器 <code>redis-node-1</code> 并为6台机器构建集群关系</p>
<p>step 1：进入容器</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker <span style="font-weight:bold;font-style:italic">exec</span> -it redis-node-1 /bin/bash
</span></span></code></pre></div><p>step 2：构建主从关系</p>
<p><strong>注意</strong>：进入 <code>Docker</code> 容器后才能执行下一个命令，且注意自己的真实 <code>IP</code> 地址</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>root@centos:/data# redis-cli --cluster create 172.30.108.127:6381 172.30.108.127:6382 172.30.108.127:6383 172.30.108.127:6384 172.30.108.127:6385 172.30.108.127:6386 --cluster-replicas 1
</span></span></code></pre></div><p>其中 <code>--cluster-replicas 1</code> 表示为每个 <code>master</code> 创建一个 <code>slave</code> 节点。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>&gt;&gt;&gt; Performing <span style="font-weight:bold;font-style:italic">hash</span> slots allocation on 6 nodes...
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>Master[0] -&gt; Slots 0 - 5460
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>Master[1] -&gt; Slots 5461 - 10922
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>Master[2] -&gt; Slots 10923 - 16383
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>Adding replica 172.30.108.127:6385 to 172.30.108.127:6381
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>Adding replica 172.30.108.127:6386 to 172.30.108.127:6382
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>Adding replica 172.30.108.127:6384 to 172.30.108.127:6383
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>&gt;&gt;&gt; Trying to optimize slaves allocation <span style="font-weight:bold">for</span> anti-affinity
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>[WARNING] Some slaves are in the same host as their master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>M: 2e6bd5c5bd1bea86e906931f02ac7f9fffb03ceb 172.30.108.127:6381
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>   slots:[0-5460] (5461 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>M: 806df04787c07b9a7cc12eba80c80b529b03b3b2 172.30.108.127:6382
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>   slots:[5461-10922] (5462 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>M: 8fee34d62a334219c66c151f21aab77ba3b467ee 172.30.108.127:6383
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>   slots:[10923-16383] (5461 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>S: 68549a4f4b658eb7d443629eac61aea4feec1f37 172.30.108.127:6384
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>   replicates 2e6bd5c5bd1bea86e906931f02ac7f9fffb03ceb
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>S: f50ca2949b33d267a3993a41fcae65de8f9370cc 172.30.108.127:6385
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>   replicates 806df04787c07b9a7cc12eba80c80b529b03b3b2
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>S: a81198d45c07dc3580c9de56255aee219b6b7662 172.30.108.127:6386
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>   replicates 8fee34d62a334219c66c151f21aab77ba3b467ee
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>Can I <span style="font-weight:bold;font-style:italic">set</span> the above configuration? (<span style="font-weight:bold;font-style:italic">type</span> <span style="color:#666;font-style:italic">&#39;yes&#39;</span> to accept): yes
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>&gt;&gt;&gt; Nodes configuration updated
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>&gt;&gt;&gt; Assign a different config epoch to each node
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>&gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>Waiting <span style="font-weight:bold">for</span> the cluster to join
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span>&gt;&gt;&gt; Performing Cluster Check (using node 172.30.108.127:6381)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span>M: 2e6bd5c5bd1bea86e906931f02ac7f9fffb03ceb 172.30.108.127:6381
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span>   slots:[0-5460] (5461 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span>   1 additional replica(s)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span>M: 8fee34d62a334219c66c151f21aab77ba3b467ee 172.30.108.127:6383
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span><span>   slots:[10923-16383] (5461 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span><span>   1 additional replica(s)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span><span>S: f50ca2949b33d267a3993a41fcae65de8f9370cc 172.30.108.127:6385
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span><span>   slots: (0 slots) slave
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span><span>   replicates 806df04787c07b9a7cc12eba80c80b529b03b3b2
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span><span>S: 68549a4f4b658eb7d443629eac61aea4feec1f37 172.30.108.127:6384
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span><span>   slots: (0 slots) slave
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span><span>   replicates 2e6bd5c5bd1bea86e906931f02ac7f9fffb03ceb
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span><span>S: a81198d45c07dc3580c9de56255aee219b6b7662 172.30.108.127:6386
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span><span>   slots: (0 slots) slave
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span><span>   replicates 8fee34d62a334219c66c151f21aab77ba3b467ee
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span><span>M: 806df04787c07b9a7cc12eba80c80b529b03b3b2 172.30.108.127:6382
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span><span>   slots:[5461-10922] (5462 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span><span>   1 additional replica(s)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span><span>[OK] All nodes agree about slots configuration.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48</span><span>&gt;&gt;&gt; Check <span style="font-weight:bold">for</span> open slots...
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49</span><span>&gt;&gt;&gt; Check slots coverage...
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50</span><span>[OK] All 16384 slots covered.
</span></span></code></pre></div><p>如果一切OK，3主3从搞定。</p>
<p>4、链接进入 <code>6381</code> 作为切入点，<strong>查看集群状态</strong></p>
<p><code>cluster info</code>：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>root@centos:/data# redis-cli -p 6381
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>127.0.0.1:6381&gt; cluster info
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>cluster_state:ok
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>cluster_slots_assigned:16384
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>cluster_slots_ok:16384
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>cluster_slots_pfail:0
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>cluster_slots_fail:0
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>cluster_known_nodes:6
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>cluster_size:3
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>cluster_current_epoch:6
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>cluster_my_epoch:1
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>cluster_stats_messages_ping_sent:508
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>cluster_stats_messages_pong_sent:514
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>cluster_stats_messages_sent:1022
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>cluster_stats_messages_ping_received:509
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>cluster_stats_messages_pong_received:508
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>cluster_stats_messages_meet_received:5
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>cluster_stats_messages_received:1022
</span></span></code></pre></div><p><code>cluster nodes</code>：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>127.0.0.1:6381&gt; cluster nodes
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>2e6bd5c5bd1bea86e906931f02ac7f9fffb03ceb 172.30.108.127:6381@16381 myself,master - 0 1656663477000 1 connected 0-5460
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>8fee34d62a334219c66c151f21aab77ba3b467ee 172.30.108.127:6383@16383 master - 0 1656663478032 3 connected 10923-16383
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>f50ca2949b33d267a3993a41fcae65de8f9370cc 172.30.108.127:6385@16385 slave 806df04787c07b9a7cc12eba80c80b529b03b3b2 0 1656663479034 2 connected
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>68549a4f4b658eb7d443629eac61aea4feec1f37 172.30.108.127:6384@16384 slave 2e6bd5c5bd1bea86e906931f02ac7f9fffb03ceb 0 1656663481038 1 connected
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span><span>a81198d45c07dc3580c9de56255aee219b6b7662 172.30.108.127:6386@16386 slave 8fee34d62a334219c66c151f21aab77ba3b467ee 0 1656663480036 3 connected
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span><span>806df04787c07b9a7cc12eba80c80b529b03b3b2 172.30.108.127:6382@16382 master - 0 1656663479000 2 connected 5461-10922
</span></span></code></pre></div><h4 id="主从容错切换迁移案例">主从容错切换迁移案例</h4>
<p>1、数据读写存储</p>
<p>step 1：启动6机构成的集群并通过 <code>exec</code> 进入</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker <span style="font-weight:bold;font-style:italic">exec</span> -it redis-node-1 /bin/bash
</span></span></code></pre></div><p>step 2：对 <code>6381</code> 新增两个 <code>key</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>root@centos:/data# redis-cli -p 6381
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>127.0.0.1:6381&gt; keys *
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>(empty array)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>127.0.0.1:6381&gt; <span style="font-weight:bold;font-style:italic">set</span> k1 v1
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>(error) MOVED 12706 172.30.108.127:6383
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span><span>127.0.0.1:6381&gt; <span style="font-weight:bold;font-style:italic">set</span> k2 v2
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span><span>OK
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8</span><span>127.0.0.1:6381&gt;
</span></span></code></pre></div><p>step 3：防止路由失效加参数 <code>-c</code> 并新增两个 <code>key</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>root@centos:/data# redis-cli -p 6381 -c
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>127.0.0.1:6381&gt; FLUSHALL
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>OK
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>127.0.0.1:6381&gt; <span style="font-weight:bold;font-style:italic">set</span> k1 v1
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>-&gt; Redirected to slot [12706] located at 172.30.108.127:6383
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>OK
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>172.30.108.127:6383&gt; <span style="font-weight:bold;font-style:italic">set</span> k2 v2
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>-&gt; Redirected to slot [449] located at 172.30.108.127:6381
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>OK
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>172.30.108.127:6381&gt;
</span></span></code></pre></div><p>step 4：查看集群信息</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>root@centos:/data# redis-cli --cluster check 172.30.108.127:6381
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>172.30.108.127:6381 (2e6bd5c5...) -&gt; 1 keys | 5461 slots | 1 slaves.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>172.30.108.127:6383 (8fee34d6...) -&gt; 1 keys | 5461 slots | 1 slaves.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>172.30.108.127:6382 (806df047...) -&gt; 0 keys | 5462 slots | 1 slaves.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>[OK] 2 keys in 3 masters.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>0.00 keys per slot on average.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>&gt;&gt;&gt; Performing Cluster Check (using node 172.30.108.127:6381)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>M: 2e6bd5c5bd1bea86e906931f02ac7f9fffb03ceb 172.30.108.127:6381
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>   slots:[0-5460] (5461 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>   1 additional replica(s)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>M: 8fee34d62a334219c66c151f21aab77ba3b467ee 172.30.108.127:6383
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>   slots:[10923-16383] (5461 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>   1 additional replica(s)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>S: f50ca2949b33d267a3993a41fcae65de8f9370cc 172.30.108.127:6385
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>   slots: (0 slots) slave
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>   replicates 806df04787c07b9a7cc12eba80c80b529b03b3b2
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>S: 68549a4f4b658eb7d443629eac61aea4feec1f37 172.30.108.127:6384
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>   slots: (0 slots) slave
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>   replicates 2e6bd5c5bd1bea86e906931f02ac7f9fffb03ceb
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>S: a81198d45c07dc3580c9de56255aee219b6b7662 172.30.108.127:6386
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>   slots: (0 slots) slave
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>   replicates 8fee34d62a334219c66c151f21aab77ba3b467ee
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>M: 806df04787c07b9a7cc12eba80c80b529b03b3b2 172.30.108.127:6382
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>   slots:[5461-10922] (5462 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>   1 additional replica(s)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>[OK] All nodes agree about slots configuration.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>&gt;&gt;&gt; Check <span style="font-weight:bold">for</span> open slots...
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span>&gt;&gt;&gt; Check slots coverage...
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span>[OK] All 16384 slots covered.
</span></span></code></pre></div><p>2、容错切换迁移</p>
<p>step 1：主 <code>6381</code> 和从机切换，先停止主机 <code>6381</code></p>
<p>先进入主机 <code>redis-node-1</code> 查看集群信息：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>$ docker <span style="font-weight:bold;font-style:italic">exec</span> -it redis-node-1 /bin/bash
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>root@centos:/data# redis-cli -p 6381 -c
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>127.0.0.1:6381&gt; cluster nodes
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>2e6bd5c5bd1bea86e906931f02ac7f9fffb03ceb 172.30.108.127:6381@16381 myself,master - 0 1656781342000 1 connected 0-5460
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>8fee34d62a334219c66c151f21aab77ba3b467ee 172.30.108.127:6383@16383 master - 0 1656781341000 3 connected 10923-16383
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>f50ca2949b33d267a3993a41fcae65de8f9370cc 172.30.108.127:6385@16385 slave 806df04787c07b9a7cc12eba80c80b529b03b3b2 0 1656781342000 2 connected
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>68549a4f4b658eb7d443629eac61aea4feec1f37 172.30.108.127:6384@16384 slave 2e6bd5c5bd1bea86e906931f02ac7f9fffb03ceb 0 1656781343850 1 connected
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>a81198d45c07dc3580c9de56255aee219b6b7662 172.30.108.127:6386@16386 slave 8fee34d62a334219c66c151f21aab77ba3b467ee 0 1656781343000 3 connected
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>806df04787c07b9a7cc12eba80c80b529b03b3b2 172.30.108.127:6382@16382 master - 0 1656781344853 2 connected 5461-10922
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>127.0.0.1:6381&gt; 
</span></span></code></pre></div><p>然后把主机 <code>redis-node-1</code> 停止：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker stop redis-node-1
</span></span></code></pre></div><p>step 2：再次查看集群信息</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>$ docker <span style="font-weight:bold;font-style:italic">exec</span> -it redis-node-2 /bin/bash
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>root@centos:/data# redis-cli -p 6382 -c
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>127.0.0.1:6382&gt; cluster nodes
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>2e6bd5c5bd1bea86e906931f02ac7f9fffb03ceb 172.30.108.127:6381@16381 master,fail - 1656781408103 1656781405086 1 disconnected
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>f50ca2949b33d267a3993a41fcae65de8f9370cc 172.30.108.127:6385@16385 slave 806df04787c07b9a7cc12eba80c80b529b03b3b2 0 1656781471312 2 connected
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>8fee34d62a334219c66c151f21aab77ba3b467ee 172.30.108.127:6383@16383 master - 0 1656781472314 3 connected 10923-16383
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>806df04787c07b9a7cc12eba80c80b529b03b3b2 172.30.108.127:6382@16382 myself,master - 0 1656781471000 2 connected 5461-10922
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>a81198d45c07dc3580c9de56255aee219b6b7662 172.30.108.127:6386@16386 slave 8fee34d62a334219c66c151f21aab77ba3b467ee 0 1656781473318 3 connected
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>68549a4f4b658eb7d443629eac61aea4feec1f37 172.30.108.127:6384@16384 master - 0 1656781472000 7 connected 0-5460
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>127.0.0.1:6382&gt; 
</span></span></code></pre></div><p><code>6381</code> 宕机了，<code>6384</code> 上位成为了新的 <code>master</code> 节点。</p>
<p><strong>备注</strong>：本次是 <code>6381</code> 为主机下面挂载从机 <code>6384</code>。每次主机挂载的从机可能不同，以实际情况为准。</p>
<p>一台主机宕机，数据不会受到影响：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>127.0.0.1:6382&gt; get k1
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>-&gt; Redirected to slot [12706] located at 172.30.108.127:6383
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span><span style="color:#666;font-style:italic">&#34;v1&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>172.30.108.127:6383&gt; get k2
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>-&gt; Redirected to slot [449] located at 172.30.108.127:6384
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span><span style="color:#666;font-style:italic">&#34;v2&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>172.30.108.127:6384&gt; get k3
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>(nil)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>172.30.108.127:6384&gt; get k4
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>-&gt; Redirected to slot [8455] located at 172.30.108.127:6382
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>(nil)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>172.30.108.127:6382&gt; 
</span></span></code></pre></div><p>step 3：先还原之前的3主3从</p>
<p>①先启动 <code>6381</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker start redis-node-1
</span></span></code></pre></div><p>②再停 <code>6384</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker stop redis-node-4
</span></span></code></pre></div><p>③再启 <code>6384</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker start redis-node-4
</span></span></code></pre></div><p><strong>注意</strong>：主从机分配情况以实际情况为准</p>
<p>step 4：查看集群状态</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>root@centos:/data# redis-cli --cluster check 172.30.108.127:6381
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>172.30.108.127:6381 (2e6bd5c5...) -&gt; 1 keys | 5461 slots | 1 slaves.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>172.30.108.127:6383 (8fee34d6...) -&gt; 1 keys | 5461 slots | 1 slaves.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>172.30.108.127:6382 (806df047...) -&gt; 0 keys | 5462 slots | 1 slaves.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>[OK] 2 keys in 3 masters.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>0.00 keys per slot on average.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>&gt;&gt;&gt; Performing Cluster Check (using node 172.30.108.127:6381)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>M: 2e6bd5c5bd1bea86e906931f02ac7f9fffb03ceb 172.30.108.127:6381
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>   slots:[0-5460] (5461 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>   1 additional replica(s)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>M: 8fee34d62a334219c66c151f21aab77ba3b467ee 172.30.108.127:6383
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>   slots:[10923-16383] (5461 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>   1 additional replica(s)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>S: a81198d45c07dc3580c9de56255aee219b6b7662 172.30.108.127:6386
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>   slots: (0 slots) slave
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>   replicates 8fee34d62a334219c66c151f21aab77ba3b467ee
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>S: 68549a4f4b658eb7d443629eac61aea4feec1f37 172.30.108.127:6384
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>   slots: (0 slots) slave
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>   replicates 2e6bd5c5bd1bea86e906931f02ac7f9fffb03ceb
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>M: 806df04787c07b9a7cc12eba80c80b529b03b3b2 172.30.108.127:6382
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>   slots:[5461-10922] (5462 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>   1 additional replica(s)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>S: f50ca2949b33d267a3993a41fcae65de8f9370cc 172.30.108.127:6385
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>   slots: (0 slots) slave
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>   replicates 806df04787c07b9a7cc12eba80c80b529b03b3b2
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>[OK] All nodes agree about slots configuration.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>&gt;&gt;&gt; Check <span style="font-weight:bold">for</span> open slots...
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span>&gt;&gt;&gt; Check slots coverage...
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span>[OK] All 16384 slots covered.
</span></span></code></pre></div><h4 id="主从扩容案例">主从扩容案例</h4>
<p>1、新建 <code>6387</code>、<code>6388</code> 两个节点+新建后启动+查看是否8节点</p>
<p>新建并启动 <code>6387</code>：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker run -d --name redis-node-7 --net host --privileged=<span style="font-weight:bold;font-style:italic">true</span> -v /data/redis/share/redis-node-7:/data redis:6.0.8 --cluster-enabled yes --appendonly yes --port 6387
</span></span></code></pre></div><p>新建并启动 <code>6388</code>：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker run -d --name redis-node-8 --net host --privileged=<span style="font-weight:bold;font-style:italic">true</span> -v /data/redis/share/redis-node-8:/data redis:6.0.8 --cluster-enabled yes --appendonly yes --port 6388
</span></span></code></pre></div><p>查看是否8节点：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker ps
</span></span></code></pre></div><p>2、进入 <code>6387</code> 容器实例内部</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker <span style="font-weight:bold;font-style:italic">exec</span> -it redis-node-7 /bin/bash
</span></span></code></pre></div><p>3、将新增的 <code>6387</code> 节点(空槽号)作为 <code>master</code> 节点加入原集群</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>redis-cli --cluster add-node 172.30.108.127:6387 172.30.108.127:6381
</span></span></code></pre></div><p><code>6387</code> 就是将要作为 <code>master</code> 的新增节点。</p>
<p><code>6381</code> 就是原来集群节点里面的领路人，相当于 <code>6387</code> 拜拜 <code>6381</code> 的码头从而找到组织加入集群。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>[root@centos ~]<span style="color:#888;font-style:italic"># docker exec -it redis-node-7 /bin/bash</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>root@centos:/data# redis-cli --cluster add-node 172.30.108.127:6387 172.30.108.127:6381
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>&gt;&gt;&gt; Adding node 172.30.108.127:6387 to cluster 172.30.108.127:6381
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>&gt;&gt;&gt; Performing Cluster Check (using node 172.30.108.127:6381)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>M: 2e6bd5c5bd1bea86e906931f02ac7f9fffb03ceb 172.30.108.127:6381
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>   slots:[0-5460] (5461 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>   1 additional replica(s)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>M: 8fee34d62a334219c66c151f21aab77ba3b467ee 172.30.108.127:6383
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>   slots:[10923-16383] (5461 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>   1 additional replica(s)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>S: a81198d45c07dc3580c9de56255aee219b6b7662 172.30.108.127:6386
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>   slots: (0 slots) slave
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>   replicates 8fee34d62a334219c66c151f21aab77ba3b467ee
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>S: 68549a4f4b658eb7d443629eac61aea4feec1f37 172.30.108.127:6384
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>   slots: (0 slots) slave
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>   replicates 2e6bd5c5bd1bea86e906931f02ac7f9fffb03ceb
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>M: 806df04787c07b9a7cc12eba80c80b529b03b3b2 172.30.108.127:6382
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>   slots:[5461-10922] (5462 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>   1 additional replica(s)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>S: f50ca2949b33d267a3993a41fcae65de8f9370cc 172.30.108.127:6385
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>   slots: (0 slots) slave
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>   replicates 806df04787c07b9a7cc12eba80c80b529b03b3b2
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>[OK] All nodes agree about slots configuration.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>&gt;&gt;&gt; Check <span style="font-weight:bold">for</span> open slots...
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>&gt;&gt;&gt; Check slots coverage...
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>[OK] All 16384 slots covered.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>&gt;&gt;&gt; Send CLUSTER MEET to node 172.30.108.127:6387 to make it join the cluster.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span>[OK] New node added correctly.
</span></span></code></pre></div><p>4、检查集群情况第1次</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>root@centos:/data# redis-cli --cluster check 172.30.108.127:6381
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>172.30.108.127:6381 (2e6bd5c5...) -&gt; 1 keys | 5461 slots | 1 slaves.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>172.30.108.127:6383 (8fee34d6...) -&gt; 1 keys | 5461 slots | 1 slaves.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>172.30.108.127:6387 (b8fb6518...) -&gt; 0 keys | 0 slots | 0 slaves.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>172.30.108.127:6382 (806df047...) -&gt; 0 keys | 5462 slots | 1 slaves.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>[OK] 2 keys in 4 masters.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>0.00 keys per slot on average.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>&gt;&gt;&gt; Performing Cluster Check (using node 172.30.108.127:6381)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>M: 2e6bd5c5bd1bea86e906931f02ac7f9fffb03ceb 172.30.108.127:6381
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>   slots:[0-5460] (5461 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>   1 additional replica(s)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>M: 8fee34d62a334219c66c151f21aab77ba3b467ee 172.30.108.127:6383
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>   slots:[10923-16383] (5461 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>   1 additional replica(s)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>S: a81198d45c07dc3580c9de56255aee219b6b7662 172.30.108.127:6386
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>   slots: (0 slots) slave
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>   replicates 8fee34d62a334219c66c151f21aab77ba3b467ee
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>M: b8fb6518d6d9190252a4bece85cf71deeffe406e 172.30.108.127:6387
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>   slots: (0 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>S: 68549a4f4b658eb7d443629eac61aea4feec1f37 172.30.108.127:6384
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>   slots: (0 slots) slave
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>   replicates 2e6bd5c5bd1bea86e906931f02ac7f9fffb03ceb
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>M: 806df04787c07b9a7cc12eba80c80b529b03b3b2 172.30.108.127:6382
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>   slots:[5461-10922] (5462 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>   1 additional replica(s)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>S: f50ca2949b33d267a3993a41fcae65de8f9370cc 172.30.108.127:6385
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>   slots: (0 slots) slave
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span>   replicates 806df04787c07b9a7cc12eba80c80b529b03b3b2
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span>[OK] All nodes agree about slots configuration.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span>&gt;&gt;&gt; Check <span style="font-weight:bold">for</span> open slots...
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span>&gt;&gt;&gt; Check slots coverage...
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span>[OK] All 16384 slots covered.
</span></span></code></pre></div><p>5、重新分派槽号</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ redis-cli --cluster reshard IP:port
</span></span></code></pre></div><p>实际操作：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>root@centos:/data# redis-cli --cluster reshard 172.30.108.127:6381
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>&gt;&gt;&gt; Performing Cluster Check (using node 172.30.108.127:6381)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>M: 2e6bd5c5bd1bea86e906931f02ac7f9fffb03ceb 172.30.108.127:6381
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>   slots:[0-5460] (5461 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>   1 additional replica(s)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>M: 8fee34d62a334219c66c151f21aab77ba3b467ee 172.30.108.127:6383
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>   slots:[10923-16383] (5461 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>   1 additional replica(s)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>S: a81198d45c07dc3580c9de56255aee219b6b7662 172.30.108.127:6386
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>   slots: (0 slots) slave
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>   replicates 8fee34d62a334219c66c151f21aab77ba3b467ee
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>M: b8fb6518d6d9190252a4bece85cf71deeffe406e 172.30.108.127:6387
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>   slots: (0 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>S: 68549a4f4b658eb7d443629eac61aea4feec1f37 172.30.108.127:6384
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>   slots: (0 slots) slave
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>   replicates 2e6bd5c5bd1bea86e906931f02ac7f9fffb03ceb
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>M: 806df04787c07b9a7cc12eba80c80b529b03b3b2 172.30.108.127:6382
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>   slots:[5461-10922] (5462 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>   1 additional replica(s)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>S: f50ca2949b33d267a3993a41fcae65de8f9370cc 172.30.108.127:6385
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>   slots: (0 slots) slave
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>   replicates 806df04787c07b9a7cc12eba80c80b529b03b3b2
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>[OK] All nodes agree about slots configuration.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>&gt;&gt;&gt; Check <span style="font-weight:bold">for</span> open slots...
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>&gt;&gt;&gt; Check slots coverage...
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>[OK] All 16384 slots covered.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>How many slots <span style="font-weight:bold">do</span> you want to move (from 1 to 16384)? 4096
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span>What is the receiving node ID? b8fb6518d6d9190252a4bece85cf71deeffe406e
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span>Please enter all the <span style="font-weight:bold;font-style:italic">source</span> node IDs.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span>  Type <span style="color:#666;font-style:italic">&#39;all&#39;</span> to use all the nodes as <span style="font-weight:bold;font-style:italic">source</span> nodes <span style="font-weight:bold">for</span> the <span style="font-weight:bold;font-style:italic">hash</span> slots.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span>  Type <span style="color:#666;font-style:italic">&#39;done&#39;</span> once you entered all the <span style="font-weight:bold;font-style:italic">source</span> nodes IDs.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span>Source node <span style="color:#888;font-style:italic">#1: all</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span><span>Ready to move 4096 slots.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span><span>  Source nodes:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span><span>    M: 2e6bd5c5bd1bea86e906931f02ac7f9fffb03ceb 172.30.108.127:6381
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span><span>       slots:[0-5460] (5461 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span><span>       1 additional replica(s)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span><span>    M: 8fee34d62a334219c66c151f21aab77ba3b467ee 172.30.108.127:6383
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span><span>       slots:[10923-16383] (5461 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span><span>       1 additional replica(s)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span><span>    M: 806df04787c07b9a7cc12eba80c80b529b03b3b2 172.30.108.127:6382
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span><span>       slots:[5461-10922] (5462 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span><span>       1 additional replica(s)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span><span>  Destination node:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span><span>    M: b8fb6518d6d9190252a4bece85cf71deeffe406e 172.30.108.127:6387
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span><span>       slots: (0 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48</span><span>  Resharding plan:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49</span><span>    Moving slot 5461 from 806df04787c07b9a7cc12eba80c80b529b03b3b2
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50</span><span>    Moving slot 5462 from 806df04787c07b9a7cc12eba80c80b529b03b3b2
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51</span><span>    ...
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52</span><span>Do you want to proceed with the proposed reshard plan (yes/no)? yes
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53</span><span>Moving slot 5461 from 172.30.108.127:6382 to 172.30.108.127:6387: 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54</span><span>...
</span></span></code></pre></div><p>关于<code>How many slots do you want to move (from 1 to 16384)?</code> 这里应该填写的是4096，怎么来的呢？只需要将 <code>16384/master台数</code> 所得到的数字填入即可。</p>
<p>6、检查集群情况第2次</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ redis-cli --cluster check IP:port
</span></span></code></pre></div><p>实际操作：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>root@centos:/data# redis-cli --cluster check 172.30.108.127:6381
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>172.30.108.127:6381 (2e6bd5c5...) -&gt; 0 keys | 4096 slots | 1 slaves.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>172.30.108.127:6383 (8fee34d6...) -&gt; 1 keys | 4096 slots | 1 slaves.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>172.30.108.127:6387 (b8fb6518...) -&gt; 1 keys | 4096 slots | 0 slaves.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>172.30.108.127:6382 (806df047...) -&gt; 0 keys | 4096 slots | 1 slaves.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>[OK] 2 keys in 4 masters.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>0.00 keys per slot on average.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>&gt;&gt;&gt; Performing Cluster Check (using node 172.30.108.127:6381)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>M: 2e6bd5c5bd1bea86e906931f02ac7f9fffb03ceb 172.30.108.127:6381
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>   slots:[1365-5460] (4096 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>   1 additional replica(s)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>M: 8fee34d62a334219c66c151f21aab77ba3b467ee 172.30.108.127:6383
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>   slots:[12288-16383] (4096 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>   1 additional replica(s)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>S: a81198d45c07dc3580c9de56255aee219b6b7662 172.30.108.127:6386
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>   slots: (0 slots) slave
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>   replicates 8fee34d62a334219c66c151f21aab77ba3b467ee
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>M: b8fb6518d6d9190252a4bece85cf71deeffe406e 172.30.108.127:6387
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>   slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>S: 68549a4f4b658eb7d443629eac61aea4feec1f37 172.30.108.127:6384
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>   slots: (0 slots) slave
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>   replicates 2e6bd5c5bd1bea86e906931f02ac7f9fffb03ceb
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>M: 806df04787c07b9a7cc12eba80c80b529b03b3b2 172.30.108.127:6382
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>   slots:[6827-10922] (4096 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>   1 additional replica(s)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>S: f50ca2949b33d267a3993a41fcae65de8f9370cc 172.30.108.127:6385
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>   slots: (0 slots) slave
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span>   replicates 806df04787c07b9a7cc12eba80c80b529b03b3b2
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span>[OK] All nodes agree about slots configuration.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span>&gt;&gt;&gt; Check <span style="font-weight:bold">for</span> open slots...
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span>&gt;&gt;&gt; Check slots coverage...
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span>[OK] All 16384 slots covered.
</span></span></code></pre></div><p><strong>槽号分派说明</strong></p>
<p>为什么 <code>6387</code> 是3个新的区间，以前的还是连续的？</p>
<p>重新分配成本太高，所以前面3家各自匀出来一部分，从 <code>6381/6382/6383</code> 三个旧节点分别匀出 1364 个槽位给新节点 <code>6387</code>。</p>
<p>7、为主节点 <code>6387</code> 分配从节点 <code>6388</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ redis-cli --cluster add-node ip:新slave端口 ip:新master端口 --cluster-slave --cluster-master-id 新主机节点ID
</span></span></code></pre></div><p>实际操作：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>root@centos:/data# redis-cli --cluster add-node 172.30.108.127:6388 172.30.108.127:6387 --cluster-slave --cluster-master-id b8fb6518d6d9190252a4bece85cf71deeffe406e <span style="color:#888;font-style:italic">#真实的6387的id</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>&gt;&gt;&gt; Adding node 172.30.108.127:6388 to cluster 172.30.108.127:6387
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>&gt;&gt;&gt; Performing Cluster Check (using node 172.30.108.127:6387)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>M: b8fb6518d6d9190252a4bece85cf71deeffe406e 172.30.108.127:6387
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>   slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>S: 68549a4f4b658eb7d443629eac61aea4feec1f37 172.30.108.127:6384
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>   slots: (0 slots) slave
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>   replicates 2e6bd5c5bd1bea86e906931f02ac7f9fffb03ceb
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>M: 8fee34d62a334219c66c151f21aab77ba3b467ee 172.30.108.127:6383
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>   slots:[12288-16383] (4096 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>   1 additional replica(s)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>S: a81198d45c07dc3580c9de56255aee219b6b7662 172.30.108.127:6386
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>   slots: (0 slots) slave
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>   replicates 8fee34d62a334219c66c151f21aab77ba3b467ee
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>M: 2e6bd5c5bd1bea86e906931f02ac7f9fffb03ceb 172.30.108.127:6381
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>   slots:[1365-5460] (4096 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>   1 additional replica(s)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>S: f50ca2949b33d267a3993a41fcae65de8f9370cc 172.30.108.127:6385
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>   slots: (0 slots) slave
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>   replicates 806df04787c07b9a7cc12eba80c80b529b03b3b2
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>M: 806df04787c07b9a7cc12eba80c80b529b03b3b2 172.30.108.127:6382
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>   slots:[6827-10922] (4096 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>   1 additional replica(s)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>[OK] All nodes agree about slots configuration.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>&gt;&gt;&gt; Check <span style="font-weight:bold">for</span> open slots...
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>&gt;&gt;&gt; Check slots coverage...
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>[OK] All 16384 slots covered.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span>&gt;&gt;&gt; Send CLUSTER MEET to node 172.30.108.127:6388 to make it join the cluster.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span>Waiting <span style="font-weight:bold">for</span> the cluster to join
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span>&gt;&gt;&gt; Configure node as replica of 172.30.108.127:6387.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span>[OK] New node added correctly.
</span></span></code></pre></div><p>8、检查集群情况第3次</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>[root@centos ~]<span style="color:#888;font-style:italic"># docker exec -it redis-node-1 /bin/bash</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>root@centos:/data# redis-cli --cluster check 172.30.108.127:6381
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>172.30.108.127:6381 (2e6bd5c5...) -&gt; 0 keys | 4096 slots | 1 slaves.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>172.30.108.127:6383 (8fee34d6...) -&gt; 1 keys | 4096 slots | 1 slaves.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>172.30.108.127:6387 (b8fb6518...) -&gt; 1 keys | 4096 slots | 1 slaves.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>172.30.108.127:6382 (806df047...) -&gt; 0 keys | 4096 slots | 1 slaves.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>[OK] 2 keys in 4 masters.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>0.00 keys per slot on average.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>&gt;&gt;&gt; Performing Cluster Check (using node 172.30.108.127:6381)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>M: 2e6bd5c5bd1bea86e906931f02ac7f9fffb03ceb 172.30.108.127:6381
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>   slots:[1365-5460] (4096 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>   1 additional replica(s)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>M: 8fee34d62a334219c66c151f21aab77ba3b467ee 172.30.108.127:6383
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>   slots:[12288-16383] (4096 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>   1 additional replica(s)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>S: c5ad1043832242c4a08ce7fb268e44a6299d34e7 172.30.108.127:6388
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>   slots: (0 slots) slave
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>   replicates b8fb6518d6d9190252a4bece85cf71deeffe406e
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>S: a81198d45c07dc3580c9de56255aee219b6b7662 172.30.108.127:6386
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>   slots: (0 slots) slave
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>   replicates 8fee34d62a334219c66c151f21aab77ba3b467ee
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>M: b8fb6518d6d9190252a4bece85cf71deeffe406e 172.30.108.127:6387
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>   slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>   1 additional replica(s)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>S: 68549a4f4b658eb7d443629eac61aea4feec1f37 172.30.108.127:6384
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>   slots: (0 slots) slave
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>   replicates 2e6bd5c5bd1bea86e906931f02ac7f9fffb03ceb
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span>M: 806df04787c07b9a7cc12eba80c80b529b03b3b2 172.30.108.127:6382
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span>   slots:[6827-10922] (4096 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span>   1 additional replica(s)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span>S: f50ca2949b33d267a3993a41fcae65de8f9370cc 172.30.108.127:6385
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span>   slots: (0 slots) slave
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span><span>   replicates 806df04787c07b9a7cc12eba80c80b529b03b3b2
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span><span>[OK] All nodes agree about slots configuration.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span><span>&gt;&gt;&gt; Check <span style="font-weight:bold">for</span> open slots...
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span><span>&gt;&gt;&gt; Check slots coverage...
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span><span>[OK] All 16384 slots covered.
</span></span></code></pre></div><h4 id="主从缩容案例">主从缩容案例</h4>
<p>目的：<code>6387</code> 和 <code>6388</code> 下线</p>
<p>1、检查集群情况1获得 <code>6388</code> 节点 <code>ID</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>root@centos:/data# redis-cli --cluster check 172.30.108.127:6382
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>...
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>S: c5ad1043832242c4a08ce7fb268e44a6299d34e7 172.30.108.127:6388
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>   slots: (0 slots) slave
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>   replicates b8fb6518d6d9190252a4bece85cf71deeffe406e
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>...
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>[OK] All nodes agree about slots configuration.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>&gt;&gt;&gt; Check <span style="font-weight:bold">for</span> open slots...
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>&gt;&gt;&gt; Check slots coverage...
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>[OK] All 16384 slots covered.
</span></span></code></pre></div><p>2、将 <code>6388</code> 删除</p>
<p>从集群中将4号从节点 <code>6388</code> 删除</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ redis-cli --cluster del-node ip:从机端口 从机6388节点ID
</span></span></code></pre></div><p>实际操作：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>root@centos:/data# redis-cli --cluster del-node 172.30.108.127:6388 c5ad1043832242c4a08ce7fb268e44a6299d34e7
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>&gt;&gt;&gt; Removing node c5ad1043832242c4a08ce7fb268e44a6299d34e7 from cluster 172.30.108.127:6388
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>&gt;&gt;&gt; Sending CLUSTER FORGET messages to the cluster...
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>&gt;&gt;&gt; Sending CLUSTER RESET SOFT to the deleted node.
</span></span></code></pre></div><p>检查一下发现，<code>6388</code> 被删除了，只剩下7台机器了：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>root@centos:/data# redis-cli --cluster check 172.30.108.127:6382
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>172.30.108.127:6382 (806df047...) -&gt; 0 keys | 4096 slots | 1 slaves.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>172.30.108.127:6381 (2e6bd5c5...) -&gt; 0 keys | 4096 slots | 1 slaves.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>172.30.108.127:6387 (b8fb6518...) -&gt; 1 keys | 4096 slots | 0 slaves.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>172.30.108.127:6383 (8fee34d6...) -&gt; 1 keys | 4096 slots | 1 slaves.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>[OK] 2 keys in 4 masters.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>0.00 keys per slot on average.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>&gt;&gt;&gt; Performing Cluster Check (using node 172.30.108.127:6382)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>M: 806df04787c07b9a7cc12eba80c80b529b03b3b2 172.30.108.127:6382
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>   slots:[6827-10922] (4096 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>   1 additional replica(s)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>M: 2e6bd5c5bd1bea86e906931f02ac7f9fffb03ceb 172.30.108.127:6381
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>   slots:[1365-5460] (4096 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>   1 additional replica(s)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>M: b8fb6518d6d9190252a4bece85cf71deeffe406e 172.30.108.127:6387
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>   slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>S: f50ca2949b33d267a3993a41fcae65de8f9370cc 172.30.108.127:6385
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>   slots: (0 slots) slave
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>   replicates 806df04787c07b9a7cc12eba80c80b529b03b3b2
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>M: 8fee34d62a334219c66c151f21aab77ba3b467ee 172.30.108.127:6383
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>   slots:[12288-16383] (4096 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>   1 additional replica(s)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>S: a81198d45c07dc3580c9de56255aee219b6b7662 172.30.108.127:6386
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>   slots: (0 slots) slave
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>   replicates 8fee34d62a334219c66c151f21aab77ba3b467ee
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>S: 68549a4f4b658eb7d443629eac61aea4feec1f37 172.30.108.127:6384
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>   slots: (0 slots) slave
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span>   replicates 2e6bd5c5bd1bea86e906931f02ac7f9fffb03ceb
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span>[OK] All nodes agree about slots configuration.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span>&gt;&gt;&gt; Check <span style="font-weight:bold">for</span> open slots...
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span>&gt;&gt;&gt; Check slots coverage...
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span>[OK] All 16384 slots covered.
</span></span></code></pre></div><p>4、将 <code>6387</code> 的槽号清空，重新分配，本例将清出来的槽号都给 <code>6381</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>root@centos:/data# redis-cli --cluster reshard 172.30.108.127:6381
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>&gt;&gt;&gt; Performing Cluster Check (using node 172.30.108.127:6381)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>M: 2e6bd5c5bd1bea86e906931f02ac7f9fffb03ceb 172.30.108.127:6381
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>   slots:[1365-5460] (4096 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>   1 additional replica(s)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>M: 8fee34d62a334219c66c151f21aab77ba3b467ee 172.30.108.127:6383
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>   slots:[12288-16383] (4096 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>   1 additional replica(s)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>S: a81198d45c07dc3580c9de56255aee219b6b7662 172.30.108.127:6386
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>   slots: (0 slots) slave
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>   replicates 8fee34d62a334219c66c151f21aab77ba3b467ee
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>M: b8fb6518d6d9190252a4bece85cf71deeffe406e 172.30.108.127:6387
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>   slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>S: 68549a4f4b658eb7d443629eac61aea4feec1f37 172.30.108.127:6384
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>   slots: (0 slots) slave
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>   replicates 2e6bd5c5bd1bea86e906931f02ac7f9fffb03ceb
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>M: 806df04787c07b9a7cc12eba80c80b529b03b3b2 172.30.108.127:6382
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>   slots:[6827-10922] (4096 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>   1 additional replica(s)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>S: f50ca2949b33d267a3993a41fcae65de8f9370cc 172.30.108.127:6385
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>   slots: (0 slots) slave
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>   replicates 806df04787c07b9a7cc12eba80c80b529b03b3b2
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>[OK] All nodes agree about slots configuration.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>&gt;&gt;&gt; Check <span style="font-weight:bold">for</span> open slots...
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>&gt;&gt;&gt; Check slots coverage...
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>[OK] All 16384 slots covered.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>How many slots <span style="font-weight:bold">do</span> you want to move (from 1 to 16384)? 4096
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span>What is the receiving node ID? 2e6bd5c5bd1bea86e906931f02ac7f9fffb03ceb <span style="color:#888;font-style:italic">#6381的节点id，由它接手空出来的槽号</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span>Please enter all the <span style="font-weight:bold;font-style:italic">source</span> node IDs.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span>  Type <span style="color:#666;font-style:italic">&#39;all&#39;</span> to use all the nodes as <span style="font-weight:bold;font-style:italic">source</span> nodes <span style="font-weight:bold">for</span> the <span style="font-weight:bold;font-style:italic">hash</span> slots.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span>  Type <span style="color:#666;font-style:italic">&#39;done&#39;</span> once you entered all the <span style="font-weight:bold;font-style:italic">source</span> nodes IDs.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span>Source node <span style="color:#888;font-style:italic">#1: b8fb6518d6d9190252a4bece85cf71deeffe406e #6387的节点id，要被删除的那个</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span><span>Source node <span style="color:#888;font-style:italic">#2: done</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span><span>Ready to move 4096 slots.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span><span>  Source nodes:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span><span>    M: b8fb6518d6d9190252a4bece85cf71deeffe406e 172.30.108.127:6387
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span><span>       slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span><span>  Destination node:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span><span>    M: 2e6bd5c5bd1bea86e906931f02ac7f9fffb03ceb 172.30.108.127:6381
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span><span>       slots:[1365-5460] (4096 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span><span>       1 additional replica(s)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span><span>  Resharding plan:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span><span>    Moving slot 0 from b8fb6518d6d9190252a4bece85cf71deeffe406e
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span><span>    Moving slot 1 from b8fb6518d6d9190252a4bece85cf71deeffe406e
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span><span>    Moving slot 2 from b8fb6518d6d9190252a4bece85cf71deeffe406e
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span><span>    Moving slot 3 from b8fb6518d6d9190252a4bece85cf71deeffe406e
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48</span><span>    Moving slot 4 from b8fb6518d6d9190252a4bece85cf71deeffe406e
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49</span><span>	...
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50</span><span>Do you want to proceed with the proposed reshard plan (yes/no)? yes
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51</span><span>...
</span></span></code></pre></div><p>5、检查集群情况2</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ redis-cli --cluster check 172.30.108.127:6381
</span></span></code></pre></div><p>4096 个槽位都指给 <code>6381</code>，它变成了8192个槽位。相当于全部都给 <code>6381</code> 了，不然要输入3次。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>root@centos:/data# redis-cli --cluster check 172.30.108.127:6381
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>172.30.108.127:6381 (2e6bd5c5...) -&gt; 1 keys | 8192 slots | 1 slaves.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>172.30.108.127:6383 (8fee34d6...) -&gt; 1 keys | 4096 slots | 1 slaves.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>172.30.108.127:6387 (b8fb6518...) -&gt; 0 keys | 0 slots | 0 slaves.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>172.30.108.127:6382 (806df047...) -&gt; 0 keys | 4096 slots | 1 slaves.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>[OK] 2 keys in 4 masters.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>0.00 keys per slot on average.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>&gt;&gt;&gt; Performing Cluster Check (using node 172.30.108.127:6381)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>M: 2e6bd5c5bd1bea86e906931f02ac7f9fffb03ceb 172.30.108.127:6381
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>   slots:[0-6826],[10923-12287] (8192 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>   1 additional replica(s)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>M: 8fee34d62a334219c66c151f21aab77ba3b467ee 172.30.108.127:6383
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>   slots:[12288-16383] (4096 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>   1 additional replica(s)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>S: a81198d45c07dc3580c9de56255aee219b6b7662 172.30.108.127:6386
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>   slots: (0 slots) slave
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>   replicates 8fee34d62a334219c66c151f21aab77ba3b467ee
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>M: b8fb6518d6d9190252a4bece85cf71deeffe406e 172.30.108.127:6387
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>   slots: (0 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>S: 68549a4f4b658eb7d443629eac61aea4feec1f37 172.30.108.127:6384
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>   slots: (0 slots) slave
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>   replicates 2e6bd5c5bd1bea86e906931f02ac7f9fffb03ceb
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>M: 806df04787c07b9a7cc12eba80c80b529b03b3b2 172.30.108.127:6382
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>   slots:[6827-10922] (4096 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>   1 additional replica(s)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>S: f50ca2949b33d267a3993a41fcae65de8f9370cc 172.30.108.127:6385
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>   slots: (0 slots) slave
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span>   replicates 806df04787c07b9a7cc12eba80c80b529b03b3b2
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span>[OK] All nodes agree about slots configuration.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span>&gt;&gt;&gt; Check <span style="font-weight:bold">for</span> open slots...
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span>&gt;&gt;&gt; Check slots coverage...
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span>[OK] All 16384 slots covered.
</span></span></code></pre></div><p>6、将 <code>6387</code> 删除</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ redis-cli --cluster del-node ip:从机端口6387节点ID
</span></span></code></pre></div><p>实际操作：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>root@centos:/data# redis-cli --cluster del-node 172.30.108.127:6387 b8fb6518d6d9190252a4bece85cf71deeffe406e
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>&gt;&gt;&gt; Removing node b8fb6518d6d9190252a4bece85cf71deeffe406e from cluster 172.30.108.127:6387
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>&gt;&gt;&gt; Sending CLUSTER FORGET messages to the cluster...
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>&gt;&gt;&gt; Sending CLUSTER RESET SOFT to the deleted node.
</span></span></code></pre></div><p>7、检查集群情况3</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>root@centos:/data# redis-cli --cluster check 172.30.108.127:6381
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>172.30.108.127:6381 (2e6bd5c5...) -&gt; 1 keys | 8192 slots | 1 slaves.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>172.30.108.127:6383 (8fee34d6...) -&gt; 1 keys | 4096 slots | 1 slaves.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>172.30.108.127:6382 (806df047...) -&gt; 0 keys | 4096 slots | 1 slaves.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>[OK] 2 keys in 3 masters.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>0.00 keys per slot on average.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>&gt;&gt;&gt; Performing Cluster Check (using node 172.30.108.127:6381)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>M: 2e6bd5c5bd1bea86e906931f02ac7f9fffb03ceb 172.30.108.127:6381
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>   slots:[0-6826],[10923-12287] (8192 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>   1 additional replica(s)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>M: 8fee34d62a334219c66c151f21aab77ba3b467ee 172.30.108.127:6383
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>   slots:[12288-16383] (4096 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>   1 additional replica(s)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>S: a81198d45c07dc3580c9de56255aee219b6b7662 172.30.108.127:6386
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>   slots: (0 slots) slave
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>   replicates 8fee34d62a334219c66c151f21aab77ba3b467ee
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>S: 68549a4f4b658eb7d443629eac61aea4feec1f37 172.30.108.127:6384
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>   slots: (0 slots) slave
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>   replicates 2e6bd5c5bd1bea86e906931f02ac7f9fffb03ceb
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>M: 806df04787c07b9a7cc12eba80c80b529b03b3b2 172.30.108.127:6382
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>   slots:[6827-10922] (4096 slots) master
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>   1 additional replica(s)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>S: f50ca2949b33d267a3993a41fcae65de8f9370cc 172.30.108.127:6385
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>   slots: (0 slots) slave
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>   replicates 806df04787c07b9a7cc12eba80c80b529b03b3b2
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>[OK] All nodes agree about slots configuration.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>&gt;&gt;&gt; Check <span style="font-weight:bold">for</span> open slots...
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span>&gt;&gt;&gt; Check slots coverage...
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span>[OK] All 16384 slots covered.
</span></span></code></pre></div><h2 id="dockerfile解析">Dockerfile解析</h2>
<h3 id="是什么">是什么</h3>
<p><code>Dockerfile</code> 是用来构建 <code>Docker</code> 镜像的文本文件，是由一条条构建镜像所需的指令和参数构成的脚本。</p>
<h4 id="概述">概述</h4>
<p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/dockerfile.png">
            <img class="mx-auto" alt="dockerfile" src="https://blog.imw7.com/images/docker/dockerfile.png" />
        </a>
    </p>
<h4 id="官网">官网</h4>
<p><a href="https://docs.docker.com/engine/reference/builder/">https://docs.docker.com/engine/reference/builder/</a></p>
<h4 id="构建三步骤">构建三步骤</h4>
<p>step1：编写 <code>Dockerfile</code> 文件</p>
<p>step2：<code>docker build</code> 命令构建镜像</p>
<p>step3：<code>docker run</code> 依镜像运行容器实例</p>
<h3 id="dockerfile构建过程解析">Dockerfile构建过程解析</h3>
<h4 id="dockerfile内容基础知识">Dockerfile内容基础知识</h4>
<p>1、每条保留字指令都<strong>必须为大写字母</strong>且后面要跟随至少一个参数</p>
<p>2、指令按照从上到下，顺序执行</p>
<p>3、<code>#</code> 表示注释</p>
<p>4、每条指令都会创建一个新的镜像层并对镜像进行提交</p>
<h4 id="docker执行dockerfile的大致流程">Docker执行Dockerfile的大致流程</h4>
<p>step1：<code>Docker</code> 从基础镜像运行一个容器</p>
<p>step2：执行一条指令并对容器作出修改</p>
<p>step3：执行类似 <code>docker commit</code> 的操作提交一个新的镜像层</p>
<p>step4：<code>Docker</code> 再基于刚提交的镜像运行一个新容器</p>
<p>step5：执行 <code>Dockerfile</code> 中的下一条指令直到所有指令都执行完成</p>
<h4 id="小总结">小总结</h4>
<p>从应用软件的角度来看，<code>Dockerfile</code>、<code>Docker</code> 镜像与 <code>Docker</code> 容器分别代表软件的三个不同阶段，</p>
<ul>
<li><code>Dockerfile</code> 是软件的原材料</li>
<li><code>Docker</code> 镜像是软件的交付品</li>
<li><code>Docker</code> 容器则可以认为是软件镜像的运行态，也即依照镜像运行的容器实例</li>
</ul>
<p><code>Dockerfile</code> 面向开发，<code>Docker</code> 镜像成为交付标准，<code>Docker</code> 容器则涉及部署与运维，三者缺一不可，合力充当 <code>Docker</code> 体系的基石。</p>
<p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/dockerfile1.png">
            <img class="mx-auto" alt="dockerfile1" src="https://blog.imw7.com/images/docker/dockerfile1.png" />
        </a>
    </p>
<ol>
<li><code>Dockerfile</code>，需要定义一个 <code>Dockerfile</code>，<code>Dockerfile</code> 定义了进程需要的一切东西。<code>Dockerfile</code> 涉及的内容包括执行代码或者是文件、环境变量、依赖包、运行时环境、动态链接库、操作系统的发行版、服务进程和内核进程(当应用进程需要和系统服务和内核进程打交道，这时需要考虑如何设计 <code>namespace</code> 的权限控制)等等；</li>
<li><code>Docker</code> 镜像，在用 <code>Dockerfile</code> 定义一个文件之后，<code>docker build</code> 时会产生一个 <code>Docker</code> 镜像，当运行<code>Docker</code> 镜像时会真正开始提供服务；</li>
<li><code>Docker</code> 容器，容器是直接提供服务的。</li>
</ol>
<h3 id="dockerfile常用保留字指令">Dockerfile常用保留字指令</h3>
<h4 id="常用保留字">常用保留字</h4>
<p><strong>注</strong>：参考 <code>tomcat8</code> 的 <code>Dockerfile</code> <a href="https://github.com/docker-library/tomcat">入门</a>。</p>
<h5 id="from">FROM</h5>
<p>基础镜像，当前新镜像是基于哪个镜像的，指定一个已经存在的镜像作为模板，第一条必须是 <code>FROM</code>。</p>
<h5 id="maintainer">MAINTAINER</h5>
<p>镜像维护者的姓名和邮箱地址。</p>
<h5 id="run">RUN</h5>
<p>1、容器构建时需要运行的命令。</p>
<p>2、两种格式：</p>
<ul>
<li><code>shell</code> 格式：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span><span style="font-weight:bold">RUN</span> &lt;命令行命令&gt;<span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span><span style=""></span><span style="color:#888;font-style:italic"># &lt;命令行命令&gt; 等同于，在终端操作的 shell 命令。</span><span style="">
</span></span></span></code></pre></div><ul>
<li><code>exec</code> 格式：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span><span style="font-weight:bold">RUN</span> [<span style="color:#666;font-style:italic">&#34;可执行文件&#34;</span>, <span style="color:#666;font-style:italic">&#34;参数1&#34;</span>, <span style="color:#666;font-style:italic">&#34;参数2&#34;</span>]<span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span><span style=""></span><span style="color:#888;font-style:italic"># 例如：</span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span><span style=""></span><span style="color:#888;font-style:italic"># RUN [&#34;./test.php&#34;, &#34;dev&#34;, &#34;offline&#34;] 等价于 RUN ./test.php dev offline</span><span style="">
</span></span></span></code></pre></div><p>3、<code>RUN</code> 是在 <code>docker build</code> 时运行。</p>
<h5 id="expose">EXPOSE</h5>
<p>当前容器对外暴露出的端口。</p>
<h5 id="workdir">WORKDIR</h5>
<p>指定在创建容器后，终端默认登陆进来的工作目录，一个落脚点。</p>
<h5 id="user">USER</h5>
<p>指定该镜像以什么样的用户去执行，如果不指定，默认是 <code>root</code>。</p>
<h5 id="env">ENV</h5>
<p>用来在构建镜像过程中设置环境变量。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span><span style="font-weight:bold">ENV</span> MY_PATH /usr/mytest<span style="">
</span></span></span></code></pre></div><p>这个环境变量可以在后续的任何 <code>RUN</code> 指令中使用，这就如同在命令前面指定了环境变量前缀一样；也可以在其它指令中直接使用这些环境变量。比如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span><span style="font-weight:bold">WORKDIR</span><span style="color:#666;font-style:italic"> $MY_PATH</span><span style="">
</span></span></span></code></pre></div><h5 id="add">ADD</h5>
<p>将宿主机目录下的文件拷贝进镜像且会自动处理 <code>URL</code> 和解压 <code>tar</code> 压缩包。</p>
<h5 id="copy">COPY</h5>
<p>类似 <code>ADD</code>，拷贝文件和目录到镜像中。</p>
<p>将从构建上下文目录中&lt;源路径&gt;的文件/目录复制到新的一层的镜像内的&lt;目标路径&gt;位置。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span><span style="font-weight:bold">COPY</span> src dest<span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span><span style=""></span><span style="font-weight:bold">COPY</span> [<span style="color:#666;font-style:italic">&#34;src&#34;</span>, <span style="color:#666;font-style:italic">&#34;dest&#34;</span>]<span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span><span style=""></span><span style="color:#888;font-style:italic"># &lt;src源路径&gt;：源文件或者源目录</span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span><span style=""></span><span style="color:#888;font-style:italic"># &lt;dest目标路径&gt;：容器内的指定路径，该路径不用事先建好，路径如果不存在，会自动创建。</span><span style="">
</span></span></span></code></pre></div><h5 id="volume">VOLUME</h5>
<p>容器数据卷，用于数据保存和持久化工作。</p>
<h5 id="cmd">CMD</h5>
<p>1、指定容器<strong>启动后</strong>要干的事情</p>
<p><code>CMD</code> 容器启动命令，<code>CMD</code> 指令的格式和 <code>RUN</code> 相似，也是两种格式：</p>
<ul>
<li><code>shell</code> 格式：<code>CMD &lt;命令&gt;</code></li>
<li><code>exec</code> 格式：<code>CMD [&quot;可执行文件&quot;, &quot;参数1&quot;, &quot;参数2&quot;...]</code></li>
<li>参数列表格式：<code>CMD [&quot;参数1&quot;, &quot;参数2&quot;...]</code>，在指定了 <code>ENTRYPOINT</code> 指令后，用 <code>CMD</code> 指定具体的参数。</li>
</ul>
<p>2、注意</p>
<p><code>Dockerfile</code> 中可以有多个 <code>CMD</code> 指令，<strong>但只有最后一个生效，<code>CMD</code> 会被 <code>docker run</code> 之后的参数替换</strong>。</p>
<p>参考官网 <code>Tomcat</code> 的 <code>Dockerfile</code> 演示：</p>
<p>官网最后一行命令：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span><span style="font-weight:bold">EXPOSE</span><span style="color:#666;font-style:italic"> 8080</span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span><span style=""></span><span style="font-weight:bold">CMD</span> [<span style="color:#666;font-style:italic">&#34;catalina.sh&#34;</span>, <span style="color:#666;font-style:italic">&#34;run&#34;</span>]<span style="">
</span></span></span></code></pre></div><p>演示自己的覆盖操作：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker run -it -p 8080:8080 billygoo/tomcat8-jdk8
</span></span></code></pre></div><p>这样能够正常访问Tomcat首页，如果是这样：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker run -it -p 8080:8080 billygoo/tomcat8-jdk8 /bin/bash
</span></span></code></pre></div><p>则会导致Tomcat首页无法访问，因为 <code>CMD [&quot;catalina.sh&quot;, &quot;run&quot;]</code> 指令被 <code>/bin/bash</code> 给替换了。</p>
<p>3、它和前面<code>RUN</code>命令的区别</p>
<ul>
<li><code>CMD</code> 是在 <code>docker run</code> 时运行。</li>
<li><code>RUN</code> 是在 <code>docker build</code> 时运行。</li>
</ul>
<h5 id="entrypoint">ENTRYPOINT</h5>
<p>也是用来指定一个容器启动时要运行的命令。类似于 <code>CMD</code> 指令，<strong>但是 <code>ENTRYPOINT</code> 不会被 <code>docker run</code> 后面的命令覆盖</strong>，而且这些命令行参数<strong>会被当作参数送给 <code>ENTRYPOINT</code> 指令指定的程序</strong>。</p>
<p>1、命令格式和案例说明</p>
<p>命令格式：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span><span style="font-weight:bold">ENTRYPOINT</span> [<span style="color:#666;font-style:italic">&#34;&lt;executeable&gt;&#34;</span>,<span style="color:#666;font-style:italic">&#34;&lt;param1&gt;&#34;</span>,<span style="color:#666;font-style:italic">&#34;&lt;param2&gt;&#34;</span>,<span style="">...</span>]<span style="">
</span></span></span></code></pre></div><p><code>ENTRYPOINT</code> 可以和 <code>CMD</code> 一起用，一般是<strong>变参</strong>才会使用 <code>CMD</code>，这里的 <code>CMD</code> 等于是在给 <code>ENTRYPOINT</code> 传参。</p>
<p>当指定了 <code>ENTRYPOINT</code> 后，<code>CMD</code> 的含义就发生了变化，不再是直接运行其命令而是将 <code>CMD</code> 的内容作为参数传递给 <code>ENTRYPOINT</code> 指令，他两个组合会变成 <code>&lt;ENTRYPOINT&gt; &quot;&lt;CMD&gt;&quot;</code></p>
<p>案例如下：</p>
<p>假设已通过 <code>Dockerfile</code> 构建了 <code>nginx:test</code> 镜像：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span><span style="font-weight:bold">FROM</span><span style="color:#666;font-style:italic"> nginx</span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span><span style=""></span><span style="font-weight:bold">ENTRYPOINT</span> [<span style="color:#666;font-style:italic">&#34;nginx&#34;</span>, <span style="color:#666;font-style:italic">&#34;-c&#34;</span>] <span style="color:#888;font-style:italic"># 定参</span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span><span style=""></span><span style="font-weight:bold">CMD</span> [<span style="color:#666;font-style:italic">&#34;/etc/nginx/nginx.conf&#34;</span>] <span style="color:#888;font-style:italic"># 变参</span><span style="">
</span></span></span></code></pre></div><table>
<thead>
<tr>
<th style="text-align:left">是否传参</th>
<th style="text-align:left">按照Dockerfile编写执行</th>
<th style="text-align:left">传参运行</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Docker命令</td>
<td style="text-align:left">docker run nginx:test</td>
<td style="text-align:left">docker run nginx:test -c /etc/nginx/new.conf</td>
</tr>
<tr>
<td style="text-align:left">衍生出的实际命令</td>
<td style="text-align:left">nginx -c /etc/nginx/nginx.conf</td>
<td style="text-align:left">nginx -c /etc/nginx/new.conf</td>
</tr>
</tbody>
</table>
<p>2、优点</p>
<p>在执行 <code>docker run</code> 的时候可以通过 <code>--entrypoint</code> 来指定 <code>ENTRYPOINT</code> 运行所需的参数。</p>
<p>3、注意</p>
<p>如果 <code>Dockerfile</code> 中存在多个 <code>ENTRYPOINT</code> 指令，尽最后一个生效。</p>
<h4 id="小总结-1">小总结</h4>
<table>
<thead>
<tr>
<th>BUILD</th>
<th>Both</th>
<th>RUN</th>
</tr>
</thead>
<tbody>
<tr>
<td>FROM</td>
<td>WORKDIR</td>
<td>CMD</td>
</tr>
<tr>
<td>MAINTAINER</td>
<td>USER</td>
<td>ENV</td>
</tr>
<tr>
<td>COPY</td>
<td></td>
<td>EXPOSE</td>
</tr>
<tr>
<td>ADD</td>
<td></td>
<td>VOLUME</td>
</tr>
<tr>
<td>RUN</td>
<td></td>
<td>ENTRYPOINT</td>
</tr>
<tr>
<td>ONBUILD</td>
<td></td>
<td></td>
</tr>
<tr>
<td>.dockerignore</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="案例">案例</h3>
<h4 id="自定义镜像mycentosjava8">自定义镜像mycentosjava8</h4>
<h5 id="要求">要求</h5>
<p><code>Centos7</code> 镜像具备 <code>vim</code> + <code>ifconfig</code> + <a href="https://www.oracle.com/java/technologies/downloads/#java8"><code>jdk8</code></a></p>
<h5 id="编写">编写</h5>
<p>准备编写 <code>Dockerfile</code> 文件，<strong>大写字母D</strong>。在本地下载 <code>jdk8</code>，宿主机中创建 <code>myfile</code> 文件夹，并将 <code>jdk8</code> 传到文件夹下，并在该文件夹创建 <code>Dockerfile</code> 文件。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>[root@centos myfile]<span style="color:#888;font-style:italic"># ls</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>Dockerfile  jdk-8u333-linux-x64.tar.gz
</span></span></code></pre></div><p>将以下内容写入 <code>Dockerfile</code> 中：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="font-weight:bold">FROM</span><span style="color:#666;font-style:italic"> centos:7</span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span><span style=""></span><span style="font-weight:bold">MAINTAINER</span><span style="color:#666;font-style:italic"> ashley&lt;hugew7@163.com&gt;</span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span><span style=""></span><span style="font-weight:bold">ENV</span> MYPATH /usr/local<span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span><span style=""></span><span style="font-weight:bold">WORKDIR</span><span style="color:#666;font-style:italic"> $MYPATH</span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span><span style=""></span><span style="color:#888;font-style:italic">#安装vim编辑器</span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span><span style=""></span><span style="font-weight:bold">RUN</span> yum -y install vim<span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span><span style=""></span><span style="color:#888;font-style:italic">#安装ifconfig命令查看网络IP</span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span><span style=""></span><span style="font-weight:bold">RUN</span> yum -y install net-tools<span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span><span style=""></span><span style="color:#888;font-style:italic">#安装java8及lib库</span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span><span style=""></span><span style="font-weight:bold">RUN</span> yum -y install glibc.i686<span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span><span style=""></span><span style="font-weight:bold">RUN</span> mkdir /usr/local/java<span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span><span style=""></span><span style="color:#888;font-style:italic">#ADD 是相对路径jar，把jdk-8u333-linux-x64.tar.gz添加到容器中，安装包必须要和Dockerfile文件在同一位置</span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span><span style=""></span><span style="font-weight:bold">ADD</span> jdk-8u333-linux-x64.tar.gz /usr/local/java/<span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span><span style=""></span><span style="color:#888;font-style:italic">#配置java环境变量</span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span><span style=""></span><span style="font-weight:bold">ENV</span> JAVA_HOME /usr/local/java/jdk1.8.0_333<span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span><span style=""></span><span style="font-weight:bold">ENV</span> JRE_HOME <span style="color:#666;font-weight:bold;font-style:italic">$JAVA_HOME</span>/jre<span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span><span style=""></span><span style="font-weight:bold">ENV</span> CLASSPATH <span style="color:#666;font-weight:bold;font-style:italic">$JAVA_HOME</span>/lib/dt.jar:<span style="color:#666;font-weight:bold;font-style:italic">$JAVA_HOME</span>/lib/tools.jar:<span style="color:#666;font-weight:bold;font-style:italic">$JRE_HOME</span>/lib:<span style="color:#666;font-weight:bold;font-style:italic">$CLASSPATH</span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span><span style=""></span><span style="font-weight:bold">ENV</span> PATH <span style="color:#666;font-weight:bold;font-style:italic">$JAVA_HOME</span>/bin:<span style="color:#666;font-weight:bold;font-style:italic">$PATH</span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span><span style=""></span><span style="font-weight:bold">EXPOSE</span><span style="color:#666;font-style:italic"> 80</span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span><span style=""></span><span style="font-weight:bold">CMD</span> <span style="font-weight:bold;font-style:italic">echo</span> <span style="color:#666;font-weight:bold;font-style:italic">$MYPATH</span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span><span style=""></span><span style="font-weight:bold">CMD</span> <span style="font-weight:bold;font-style:italic">echo</span> <span style="color:#666;font-style:italic">&#34;success------------ok&#34;</span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span><span style=""></span><span style="font-weight:bold">CMD</span> /bin/bash<span style="">
</span></span></span></code></pre></div><h5 id="构建">构建</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker build -t 新镜像名字:TAG .
</span></span></code></pre></div><p><strong>注意：上面 <code>TAG</code> 后面有个空格，有个点</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker build -t centosjava8:1.5 .
</span></span></code></pre></div><h5 id="运行">运行</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker run -it 新镜像名字:TAG
</span></span></code></pre></div><p>本次：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker run -it centosjava8:1.5
</span></span></code></pre></div><h5 id="再体会下-unionfs联合文件系统">再体会下 <code>UnionFS</code>（联合文件系统）</h5>
<p><code>UnionFS</code> 是一种分层、轻量级并且高性能的文件系统，它支持<strong>对文件系统的修改作为一次提交来一层层的叠加</strong>，同时可以将不同且目录挂载到同一个虚拟文件系统下「<code>unite several directories into a single virtual filesystem</code>」。<code>Union</code> 文件系统是 <code>Docker</code> 镜像的基础。镜像可以通过分层来进行继承，基于基础镜像（没有父镜像），可以制作各种具体的应用镜像。</p>
<p>特性：一次同时加载多个文件系统，但从外面看起来，只能看到一个文件系统，联合加载会把各层文件系统叠加起来，这样最终的文件系统会包含所有底层的文件和目录。</p>
<h4 id="虚悬镜像">虚悬镜像</h4>
<h5 id="是什么-1">是什么</h5>
<p>仓库名、标签都是 <code>&lt;none&gt;</code> 的镜像，俗称 <code>dangling image</code>。</p>
<p><code>Dockerfile</code> 写一个：</p>
<p>1、<code>vim Dockerfile</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span><span style="font-weight:bold">FROM</span><span style="color:#666;font-style:italic"> ubuntu</span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span><span style=""></span><span style="font-weight:bold">CMD</span> <span style="font-weight:bold;font-style:italic">echo</span> <span style="color:#666;font-style:italic">&#39;action is success&#39;</span><span style="">
</span></span></span></code></pre></div><p>2、<code>docker build .</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ <span style="font-weight:bold;font-style:italic">pwd</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>/myfile/test
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>$ docker build .
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>...
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>Successfully built c43dea5c5227
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span><span>$ docker images
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span><span>REPOSITORY    TAG       IMAGE ID       CREATED             SIZE
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8</span><span>&lt;none&gt;        &lt;none&gt;    c43dea5c5227   30 seconds ago      72.8MB
</span></span></code></pre></div><h5 id="查看">查看</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker image ls -f <span style="color:#666;font-weight:bold;font-style:italic">dangling</span>=<span style="font-weight:bold;font-style:italic">true</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>REPOSITORY   TAG       IMAGE ID       CREATED         SIZE
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>&lt;none&gt;       &lt;none&gt;    c43dea5c5227   8 minutes ago   72.8MB
</span></span></code></pre></div><h5 id="删除">删除</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker image prune
</span></span></code></pre></div><p>虚悬镜像已经失去存在价值，可以删除。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>$ docker image ls -f <span style="color:#666;font-weight:bold;font-style:italic">dangling</span>=<span style="font-weight:bold;font-style:italic">true</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>REPOSITORY   TAG       IMAGE ID       CREATED          SIZE
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>&lt;none&gt;       &lt;none&gt;    c43dea5c5227   10 minutes ago   72.8MB
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>$ docker image prune
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>WARNING! This will remove all dangling images.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>Are you sure you want to <span style="font-weight:bold">continue</span>? [y/N] y
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>Deleted Images:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>deleted: sha256:c43dea5c52272d6d85df1762759e1b78bc6148b99a6492327afc2e3d67e11f30
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>Total reclaimed space: 0B
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>$ docker image ls -f <span style="color:#666;font-weight:bold;font-style:italic">dangling</span>=<span style="font-weight:bold;font-style:italic">true</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>REPOSITORY   TAG       IMAGE ID   CREATED   SIZE
</span></span></code></pre></div><h4 id="自定义镜像alpinejava8">自定义镜像alpinejava8</h4>
<h5 id="编写-1">编写</h5>
<p>在宿主机的 <code>/myfile/alpinejava8</code> 文件夹下准备文件：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ <span style="font-weight:bold;font-style:italic">pwd</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>/myfile/alpinejava8
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>$ ls
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>Dockerfile  glibc-2.34-r0.apk  jdk-8u341-linux-x64.tar.gz
</span></span></code></pre></div><p><code>glibc</code> 安装包的下载地址：https://github.com/sgerrand/alpine-pkg-glibc/releases</p>
<p>准备编写 <code>Dockerfile</code> 文件：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="font-weight:bold">FROM</span><span style="color:#666;font-style:italic"> alpine</span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span><span style=""></span><span style="font-weight:bold">MAINTAINER</span><span style="color:#666;font-style:italic"> ashley&lt;hugew7@gmail.com&gt;</span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span><span style=""></span><span style="font-weight:bold">ENV</span> MYPATH /usr/local<span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span><span style=""></span><span style="font-weight:bold">WORKDIR</span><span style="color:#666;font-style:italic"> $MYPATH</span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span><span style=""></span><span style="color:#888;font-style:italic">#修改镜像方便下载</span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span><span style=""></span><span style="font-weight:bold">RUN</span> sed -i <span style="color:#666;font-style:italic">&#39;s/dl-cdn.aplinelinux.org/mirrors.ustc.edu.cn/g&#39;</span> /etc/apk/repositories<span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span><span style=""></span><span style="color:#888;font-style:italic">#更新apk源</span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span><span style=""></span><span style="font-weight:bold">RUN</span> apk update<span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span><span style=""></span><span style="color:#888;font-style:italic">#安装vim编辑器</span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span><span style=""></span><span style="font-weight:bold">RUN</span> apk add vim<span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span><span style=""></span><span style="color:#888;font-style:italic">#安装java8及lib库</span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span><span style=""></span><span style="font-weight:bold">COPY</span> glibc-2.34-r0.apk /tmp<span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span><span style=""></span><span style="font-weight:bold">RUN</span> <span style="font-weight:bold;font-style:italic">echo</span> <span style="color:#666;font-style:italic">\
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span><span style="color:#666;font-style:italic"></span>        <span style="color:#666;font-style:italic">&#34;-----BEGIN PUBLIC KEY-----\
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span><span style="color:#666;font-style:italic">        MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEApZ2u1KJKUu/fW4A25y9m\
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span><span style="color:#666;font-style:italic">        y70AGEa/J3Wi5ibNVGNn1gT1r0VfgeWd0pUybS4UmcHdiNzxJPgoWQhV2SSW1JYu\
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span><span style="color:#666;font-style:italic">        tOqKZF5QSN6X937PTUpNBjUvLtTQ1ve1fp39uf/lEXPpFpOPL88LKnDBgbh7wkCp\
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span><span style="color:#666;font-style:italic">        m2KzLVGChf83MS0ShL6G9EQIAUxLm99VpgRjwqTQ/KfzGtpke1wqws4au0Ab4qPY\
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span><span style="color:#666;font-style:italic">        KXvMLSPLUp7cfulWvhmZSegr5AdhNw5KNizPqCJT8ZrGvgHypXyiFvvAH5YRtSsc\
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span><span style="color:#666;font-style:italic">        Zvo9GI2e2MaZyo9/lvb+LbLEJZKEQckqRj4P26gmASrZEPStwc+yqy1ShHLA0j6m\
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span><span style="color:#666;font-style:italic">        1QIDAQAB\
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span><span style="color:#666;font-style:italic">        -----END PUBLIC KEY-----&#34;</span> | sed <span style="color:#666;font-style:italic">&#39;s/   */\n/g&#39;</span> &gt; <span style="color:#666;font-style:italic">&#34;/etc/apk/keys/sgerrand.rsa.pub&#34;</span> <span style="color:#666;font-style:italic">\
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span><span style="color:#666;font-style:italic"></span>    &amp;&amp; apk add /tmp/glibc-2.34-r0.apk <span style="color:#666;font-style:italic">\
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span><span style="color:#666;font-style:italic"></span>    &amp;&amp; rm -rf /tmp/glibc-2.34-r0.apk<span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span><span style=""></span><span style="font-weight:bold">RUN</span> mkdir /usr/local/java<span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span><span style=""></span><span style="color:#888;font-style:italic">#ADD 是相对路径jar，把jdk-8u341-linux-x64.tar.gz添加到容器中，安装包必须要和Dockerfile文件在同一位置</span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span><span style=""></span><span style="font-weight:bold">ADD</span> jdk-8u341-linux-x64.tar.gz /usr/local/java/<span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span><span style=""></span><span style="color:#888;font-style:italic">#配置java环境变量</span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span><span style=""></span><span style="font-weight:bold">ENV</span> JAVA_HOME /usr/local/java/jdk1.8.0_341<span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span><span><span style=""></span><span style="font-weight:bold">ENV</span> JRE_HOME <span style="color:#666;font-weight:bold;font-style:italic">$JAVA_HOME</span>/jre<span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span><span><span style=""></span><span style="font-weight:bold">ENV</span> CLASSPATH <span style="color:#666;font-weight:bold;font-style:italic">$JAVA_HOME</span>/lib/dt.jar:<span style="color:#666;font-weight:bold;font-style:italic">$JAVA_HOME</span>/lib/tools.jar:<span style="color:#666;font-weight:bold;font-style:italic">$JRE_HOME</span>/lib:<span style="color:#666;font-weight:bold;font-style:italic">$CLASSPATH</span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span><span><span style=""></span><span style="font-weight:bold">ENV</span> PATH <span style="color:#666;font-weight:bold;font-style:italic">$JAVA_HOME</span>/bin:<span style="color:#666;font-weight:bold;font-style:italic">$PATH</span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span><span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span><span><span style=""></span><span style="font-weight:bold">EXPOSE</span><span style="color:#666;font-style:italic"> 80</span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span><span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span><span><span style=""></span><span style="font-weight:bold">CMD</span> <span style="font-weight:bold;font-style:italic">echo</span> <span style="color:#666;font-weight:bold;font-style:italic">$MYPATH</span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span><span><span style=""></span><span style="font-weight:bold">CMD</span> <span style="font-weight:bold;font-style:italic">echo</span> <span style="color:#666;font-style:italic">&#34;success------------ok&#34;</span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span><span><span style=""></span><span style="font-weight:bold">CMD</span> /bin/sh<span style="">
</span></span></span></code></pre></div><h5 id="构建-1">构建</h5>
<p>命令：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker build -t 新镜像名字:TAG .
</span></span></code></pre></div><p>本次：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>$ docker build -t alpinejava8:2.7 .
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>Sending build context to Docker daemon  150.1MB
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>Step 1/19 : FROM alpine
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>latest: Pulling from library/alpine
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>59bf1c3509f3: Pull <span style="font-weight:bold;font-style:italic">complete</span> 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>Digest: sha256:21a3deaa0d32a8057914f36584b5288d2e5ecc984380bc0118285c70fa8c9300
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>Status: Downloaded newer image <span style="font-weight:bold">for</span> alpine:latest
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span> ---&gt; c059bfaa849c
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>Step 2/19 : MAINTAINER ashley&lt;hugew7@gmail.com&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span> ---&gt; Running in ac6e3500072c
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>Removing intermediate container ac6e3500072c
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span> ---&gt; 93ae07580201
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>Step 3/19 : ENV MYPATH /usr/local
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span> ---&gt; Running in 3f2e007a88fa
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>Removing intermediate container 3f2e007a88fa
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span> ---&gt; 769ef0dcf14c
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>Step 4/19 : WORKDIR <span style="color:#666;font-weight:bold;font-style:italic">$MYPATH</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span> ---&gt; Running in 83a1422ac6d0
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>Removing intermediate container 83a1422ac6d0
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span> ---&gt; 3affce388bb6
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>Step 5/19 : RUN sed -i <span style="color:#666;font-style:italic">&#39;s/dl-cdn.aplinelinux.org/mirrors.ustc.edu.cn/g&#39;</span> /etc/apk/repositories
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span> ---&gt; Running in 05802ec344db
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>Removing intermediate container 05802ec344db
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span> ---&gt; 5bea25bb24ef
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>Step 6/19 : RUN apk update
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span> ---&gt; Running in 6ddb000f72d5
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>fetch https://dl-cdn.alpinelinux.org/alpine/v3.15/main/x86_64/APKINDEX.tar.gz
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span>fetch https://dl-cdn.alpinelinux.org/alpine/v3.15/community/x86_64/APKINDEX.tar.gz
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span>v3.15.4-270-gb9701f5e66 [https://dl-cdn.alpinelinux.org/alpine/v3.15/main]
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span>v3.15.5-2-gbb3b41d6d6 [https://dl-cdn.alpinelinux.org/alpine/v3.15/community]
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span>OK: 15863 distinct packages available
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span>Removing intermediate container 6ddb000f72d5
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span><span> ---&gt; 685394dbe0d8
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span><span>Step 7/19 : RUN apk add vim
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span><span> ---&gt; Running in 6f1ca357ce6f
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span><span>(1/5) Installing xxd (8.2.4836-r0)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span><span>(2/5) Installing lua5.3-libs (5.3.6-r1)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span><span>(3/5) Installing ncurses-terminfo-base (6.3_p20211120-r1)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span><span>(4/5) Installing ncurses-libs (6.3_p20211120-r1)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span><span>(5/5) Installing vim (8.2.4836-r0)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span><span>Executing busybox-1.34.1-r3.trigger
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span><span>OK: 35 MiB in 19 packages
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span><span>Removing intermediate container 6f1ca357ce6f
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span><span> ---&gt; d0be1a55fdbe
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span><span>Step 8/19 : COPY glibc-2.34-r0.apk /tmp
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span><span> ---&gt; a2687db1f4f4
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span><span>Step 9/19 : RUN <span style="font-weight:bold;font-style:italic">echo</span>         <span style="color:#666;font-style:italic">&#34;-----BEGIN PUBLIC KEY-----        MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEApZ2u1KJKUu/fW4A25y9m        y70AGEa/J3Wi5ibNVGNn1gT1r0VfgeWd0pUybS4UmcHdiNzxJPgoWQhV2SSW1JYu        tOqKZF5QSN6X937PTUpNBjUvLtTQ1ve1fp39uf/lEXPpFpOPL88LKnDBgbh7wkCp        m2KzLVGChf83MS0ShL6G9EQIAUxLm99VpgRjwqTQ/KfzGtpke1wqws4au0Ab4qPY        KXvMLSPLUp7cfulWvhmZSegr5AdhNw5KNizPqCJT8ZrGvgHypXyiFvvAH5YRtSsc        Zvo9GI2e2MaZyo9/lvb+LbLEJZKEQckqRj4P26gmASrZEPStwc+yqy1ShHLA0j6m        1QIDAQAB        -----END PUBLIC KEY-----&#34;</span> | sed <span style="color:#666;font-style:italic">&#39;s/   */\n/g&#39;</span> &gt; <span style="color:#666;font-style:italic">&#34;/etc/apk/keys/sgerrand.rsa.pub&#34;</span>     &amp;&amp; apk add /tmp/glibc-2.34-r0.apk     &amp;&amp; rm -rf /tmp/glibc-2.34-r0.apk
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48</span><span> ---&gt; Running in 0216ad673247
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49</span><span>(1/1) Installing glibc (2.34-r0)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50</span><span>OK: 39 MiB in 20 packages
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51</span><span>Removing intermediate container 0216ad673247
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52</span><span> ---&gt; 84b7e2cf8a40
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53</span><span>Step 10/19 : RUN mkdir /usr/local/java
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54</span><span> ---&gt; Running in 04a7c039e64f
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55</span><span>Removing intermediate container 04a7c039e64f
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56</span><span> ---&gt; f284cf289b3e
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57</span><span>Step 11/19 : ADD jdk-8u341-linux-x64.tar.gz /usr/local/java/
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58</span><span> ---&gt; 62dbf9f8e102
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59</span><span>Step 12/19 : ENV JAVA_HOME /usr/local/java/jdk1.8.0_341
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60</span><span> ---&gt; Running in 4000650801ca
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61</span><span>Removing intermediate container 4000650801ca
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62</span><span> ---&gt; 446d849337e7
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63</span><span>Step 13/19 : ENV JRE_HOME <span style="color:#666;font-weight:bold;font-style:italic">$JAVA_HOME</span>/jre
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64</span><span> ---&gt; Running in ccb033322163
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65</span><span>Removing intermediate container ccb033322163
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66</span><span> ---&gt; dda56fb0d9cb
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67</span><span>Step 14/19 : ENV CLASSPATH <span style="color:#666;font-weight:bold;font-style:italic">$JAVA_HOME</span>/lib/dt.jar:<span style="color:#666;font-weight:bold;font-style:italic">$JAVA_HOME</span>/lib/tools.jar:<span style="color:#666;font-weight:bold;font-style:italic">$JRE_HOME</span>/lib:<span style="color:#666;font-weight:bold;font-style:italic">$CLASSPATH</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68</span><span> ---&gt; Running in d6a9874adcd2
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69</span><span>Removing intermediate container d6a9874adcd2
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70</span><span> ---&gt; 77833ad753d6
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71</span><span>Step 15/19 : ENV PATH <span style="color:#666;font-weight:bold;font-style:italic">$JAVA_HOME</span>/bin:<span style="color:#666;font-weight:bold;font-style:italic">$PATH</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72</span><span> ---&gt; Running in 6c6ad441608c
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73</span><span>Removing intermediate container 6c6ad441608c
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74</span><span> ---&gt; a096dc7d5ec6
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75</span><span>Step 16/19 : EXPOSE 80
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">76</span><span> ---&gt; Running in 7333abb8d4f1
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">77</span><span>Removing intermediate container 7333abb8d4f1
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">78</span><span> ---&gt; 5e0a0cfe37a9
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">79</span><span>Step 17/19 : CMD <span style="font-weight:bold;font-style:italic">echo</span> <span style="color:#666;font-weight:bold;font-style:italic">$MYPATH</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">80</span><span> ---&gt; Running in f41988bb3b10
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">81</span><span>Removing intermediate container f41988bb3b10
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">82</span><span> ---&gt; b0fc8742c89e
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">83</span><span>Step 18/19 : CMD <span style="font-weight:bold;font-style:italic">echo</span> <span style="color:#666;font-style:italic">&#34;success------------ok&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">84</span><span> ---&gt; Running in 01aa9f13d7e6
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">85</span><span>Removing intermediate container 01aa9f13d7e6
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">86</span><span> ---&gt; 18c73f89c881
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">87</span><span>Step 19/19 : CMD /bin/sh
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">88</span><span> ---&gt; Running in 45ff6f43ee27
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">89</span><span>Removing intermediate container 45ff6f43ee27
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">90</span><span> ---&gt; ab3fe232d0ee
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">91</span><span>Successfully built ab3fe232d0ee
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">92</span><span>Successfully tagged alpinejava8:2.7
</span></span></code></pre></div><h5 id="运行-1">运行</h5>
<p>命令：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker run -it 新镜像名字:TAG
</span></span></code></pre></div><p>本次：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>$ docker run -it alpinejava8:2.7
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>/usr/local <span style="color:#888;font-style:italic"># vim a.txt</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>/usr/local <span style="color:#888;font-style:italic"># cat a.txt</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>Hello, 世界！
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>/usr/local <span style="color:#888;font-style:italic"># java -version</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>java version <span style="color:#666;font-style:italic">&#34;1.8.0_341&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>Java(TM) SE Runtime Environment (build 1.8.0_341-b10)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>Java HotSpot(TM) 64-Bit Server VM (build 25.341-b10, mixed mode)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>/usr/local <span style="color:#888;font-style:italic"># javac -version</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>javac 1.8.0_341
</span></span></code></pre></div><h3 id="小总结-2">小总结</h3>
<p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/dockerfile.png">
            <img class="mx-auto" alt="dockerfile" src="https://blog.imw7.com/images/docker/dockerfile.png" />
        </a>
    </p>
<h2 id="docker微服务实战">Docker微服务实战</h2>
<h3 id="通过idea新建一个普通微服务模块">通过IDEA新建一个普通微服务模块</h3>
<h4 id="建module">建Module</h4>
<p>以此点击<code>File</code> -<code>New</code>-<code>Project</code>，在弹出的窗口左边选择 <code>Spring Initializr</code>，按照下图填写：</p>
<p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/new_project.png">
            <img class="mx-auto" alt="new_project" src="https://blog.imw7.com/images/docker/new_project.png" />
        </a>
    </p>
<p>填完了以后，点击 <code>Next</code>，选择合适的 <code>Spring Boot</code> 版本（如：2.5.6）以及其他需要的扩展后点击 <code>Create</code> 等待创建完成。</p>
<h4 id="改pom">改POM</h4>
<p>修改 <code>pom.xml</code> 文件：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#888;font-weight:bold">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>&lt;project xmlns=<span style="color:#666;font-style:italic">&#34;http://maven.apache.org/POM/4.0.0&#34;</span> xmlns:xsi=<span style="color:#666;font-style:italic">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>         xsi:schemaLocation=<span style="color:#666;font-style:italic">&#34;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span>&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>    &lt;parent&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>        &lt;version&gt;2.5.6&lt;/version&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>        &lt;relativePath/&gt; <span style="color:#888;font-style:italic">&lt;!-- lookup parent from repository --&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>    &lt;/parent&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>    &lt;groupId&gt;com.imw7.docker&lt;/groupId&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>    &lt;artifactId&gt;docker_boot&lt;/artifactId&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>    &lt;properties&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>        &lt;maven.compiler.source&gt;1.8&lt;/maven.compiler.source&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>        &lt;maven.compiler.target&gt;1.8&lt;/maven.compiler.target&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>        &lt;junit.version&gt;4.12&lt;/junit.version&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>        &lt;log4j.version&gt;1.2.17&lt;/log4j.version&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>        &lt;lombok.version&gt;1.16.18&lt;/lombok.version&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>        &lt;mysql.version&gt;5.1.47&lt;/mysql.version&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>        &lt;druid.version&gt;1.1.16&lt;/druid.version&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>        &lt;mapper.version&gt;4.1.5&lt;/mapper.version&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>        &lt;mybatis.spring.boot.version&gt;1.3.0&lt;/mybatis.spring.boot.version&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>    &lt;/properties&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span>    &lt;dependencies&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span>        <span style="color:#888;font-style:italic">&lt;!--SpringBoot通用依赖模块--&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span>        &lt;dependency&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span><span>            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span><span>        &lt;/dependency&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span><span>        &lt;dependency&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span><span>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span><span>            &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span><span>        &lt;/dependency&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span><span>        <span style="color:#888;font-style:italic">&lt;!--test--&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span><span>        &lt;dependency&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span><span>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span><span>            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span><span>            &lt;scope&gt;test&lt;/scope&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span><span>        &lt;/dependency&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span><span>    &lt;/dependencies&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span><span>    &lt;build&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48</span><span>        &lt;plugins&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49</span><span>            &lt;plugin&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50</span><span>                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51</span><span>                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52</span><span>            &lt;/plugin&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53</span><span>        &lt;/plugins&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54</span><span>    &lt;/build&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56</span><span>&lt;/project&gt;
</span></span></code></pre></div><h4 id="写yml">写YML</h4>
<p>写 <code>docker_boot/src/main/resources/application.properties</code> 文件：</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">server.port=6001
</code></pre><h4 id="主启动">主启动</h4>
<pre tabindex="0"><code>docker_boot/src/main/java/com/imw7/docker/DockerBootApplication.java
package com.imw7.docker;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class DockerBootApplication {

    public static void main(String[] args) {
        SpringApplication.run(DockerBootApplication.class, args);
    }

}
</code></pre><h4 id="业务类">业务类</h4>
<pre tabindex="0"><code>docker_boot/src/main/java/com/imw7/docker/controller/OrderController.java
package com.imw7.docker.controller;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RestController;


import java.util.UUID;

@RestController
public class OrderController {
    @Value(&#34;${server.port}&#34;)
    private String port;

    @RequestMapping(&#34;/order/docker&#34;)
    public String helloDocker() {
        return &#34;hello docker&#34; + &#34;\t&#34; + port + &#34;\t&#34; + UUID.randomUUID().toString();
    }

    @RequestMapping(value =&#34;/order/index&#34;,method = RequestMethod.GET)
    public String index() {
        return &#34;服务器端口号：&#34;+&#34;\t&#34;+port+&#34;\t&#34;+UUID.randomUUID().toString();
    }
}
</code></pre><p>完成上述步骤之后，运行<code>DockerBootApplication.java</code>，通过网页访问 http://localhost:6001/order/index 和 http://localhost:6001/order/docker：</p>
<p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/order_index.png">
            <img class="mx-auto" alt="order_index" src="https://blog.imw7.com/images/docker/order_index.png" />
        </a>
    </p>
<p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/order_docker.png">
            <img class="mx-auto" alt="order_docker" src="https://blog.imw7.com/images/docker/order_docker.png" />
        </a>
    </p>
<p>如果能访问到上述两个网址，说明一切正常，可以进行下一步。</p>
<h3 id="通过dockerfile发布微服务部署到docker容器">通过Dockerfile发布微服务部署到docker容器</h3>
<h4 id="idea工具搞定微服务jar包">IDEA工具搞定微服务jar包</h4>
<p>使用 <code>maven</code> 生成 <code>jar</code> 包：</p>
<p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/maven.png">
            <img class="mx-auto" alt="maven" src="https://blog.imw7.com/images/docker/maven.png" />
        </a>
    </p>
<p>生成的 <code>jar</code> 包在 <code>target</code> 目录下面：</p>
<pre tabindex="0"><code>docker_boot/target/docker_boot-0.0.1-SNAPSHOT.jar
</code></pre><h4 id="编写dockerfile">编写Dockerfile</h4>
<h5 id="dockerfile内容">Dockerfile内容</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#888;font-style:italic"># 基础镜像使用java</span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span><span style=""></span><span style="font-weight:bold">FROM</span><span style="color:#666;font-style:italic"> java:8</span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span><span style=""></span><span style="color:#888;font-style:italic"># 作者</span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span><span style=""></span><span style="font-weight:bold">MAINTAINER</span><span style="color:#666;font-style:italic"> ashley</span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span><span style=""></span><span style="color:#888;font-style:italic"># VOLUME 指定临时文件目录/tmp，在主机/var/lib/docker目录下创建了一个临时文件并链接到容器的/tmp</span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span><span style=""></span><span style="font-weight:bold">VOLUME</span><span style="color:#666;font-style:italic"> /tmp</span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span><span style=""></span><span style="color:#888;font-style:italic"># 将jar包添加到容器中并更名为ashley_docker.jar</span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span><span style=""></span><span style="font-weight:bold">ADD</span> docker_boot-0.0.1-SNAPSHOT.jar ashley_docker.jar<span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span><span style=""></span><span style="color:#888;font-style:italic"># 运行jar包</span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span><span style=""></span><span style="font-weight:bold">RUN</span> bash -c <span style="color:#666;font-style:italic">&#39;touch /ashley_docker.jar&#39;</span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span><span style=""></span><span style="font-weight:bold">ENTRYPOINT</span> [<span style="color:#666;font-style:italic">&#34;java&#34;</span>,<span style="color:#666;font-style:italic">&#34;-jar&#34;</span>,<span style="color:#666;font-style:italic">&#34;/ashley_docker.jar&#34;</span>]<span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span><span style=""></span><span style="color:#888;font-style:italic"># 暴露6001端口作为微服务</span><span style="">
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span><span style=""></span><span style="font-weight:bold">EXPOSE</span><span style="color:#666;font-style:italic"> 6001</span><span style="">
</span></span></span></code></pre></div><h5 id="上传">上传</h5>
<p>使用 <code>Xftp</code> 或者 <code>scp</code> 命令将<code>docker_boot-0.0.1-SNAPSHOT.jar</code> 包和 <code>Dockerfile</code> 文件上传到服务器的 <code>/mydocker</code> 文件夹下。</p>
<h4 id="构建镜像">构建镜像</h4>
<p>构建命令：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker build -t ashley_docker:1.6 .
</span></span></code></pre></div><p>具体过程：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>$ docker build -t ashley_docker:1.6 .
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>Sending build context to Docker daemon  19.52MB
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>Step 1/7 : FROM java:8
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>8: Pulling from library/java
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>5040bd298390: Pull <span style="font-weight:bold;font-style:italic">complete</span> 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>fce5728aad85: Pull <span style="font-weight:bold;font-style:italic">complete</span> 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>76610ec20bf5: Pull <span style="font-weight:bold;font-style:italic">complete</span> 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>60170fec2151: Pull <span style="font-weight:bold;font-style:italic">complete</span> 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>e98f73de8f0d: Pull <span style="font-weight:bold;font-style:italic">complete</span> 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>11f7af24ed9c: Pull <span style="font-weight:bold;font-style:italic">complete</span> 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>49e2d6393f32: Pull <span style="font-weight:bold;font-style:italic">complete</span> 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>bb9cdec9c7f3: Pull <span style="font-weight:bold;font-style:italic">complete</span> 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>Digest: sha256:c1ff613e8ba25833d2e1940da0940c3824f03f802c449f3d1815a66b7f8c0e9d
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>Status: Downloaded newer image <span style="font-weight:bold">for</span> java:8
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span> ---&gt; d23bdf5b1b1b
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>Step 2/7 : MAINTAINER ashley
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span> ---&gt; Running in 2b04d48fd264
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>Removing intermediate container 2b04d48fd264
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span> ---&gt; f603afb9dafe
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>Step 3/7 : VOLUME /tmp
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span> ---&gt; Running in 59940e538fcf
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>Removing intermediate container 59940e538fcf
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span> ---&gt; 7e3ff0743c1d
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>Step 4/7 : ADD docker_boot-0.0.1-SNAPSHOT.jar ashley_docker.jar
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span> ---&gt; 8b3d54140084
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>Step 5/7 : RUN bash -c <span style="color:#666;font-style:italic">&#39;touch /ashley_docker.jar&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span> ---&gt; Running in 5b322a05c92b
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span>Removing intermediate container 5b322a05c92b
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span> ---&gt; bec257c0dcf7
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span>Step 6/7 : ENTRYPOINT [<span style="color:#666;font-style:italic">&#34;java&#34;</span>,<span style="color:#666;font-style:italic">&#34;-jar&#34;</span>,<span style="color:#666;font-style:italic">&#34;/ashley_docker.jar&#34;</span>]
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span> ---&gt; Running in 7a12ae1e5439
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span>Removing intermediate container 7a12ae1e5439
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span><span> ---&gt; 2df52d1cb431
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span><span>Step 7/7 : EXPOSE 6001
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span><span> ---&gt; Running in e5774c32d1c7
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span><span>Removing intermediate container e5774c32d1c7
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span><span> ---&gt; d78242d80d92
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span><span>Successfully built d78242d80d92
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span><span>Successfully tagged ashley_docker:1.6
</span></span></code></pre></div><h4 id="运行容器">运行容器</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker run -d -p 6001:6001 ashley_docker:1.6
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>1e0e30b22fe33a6567b39dcc3de4130ec44abbaafad0c0ddfb053f4c6362301d
</span></span></code></pre></div><h4 id="访问测试">访问测试</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ curl 127.0.0.1:6001/order/docker
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>hello docker	6001	413aa426-3dd1-4cb2-a6e5-75aa33cc4eb7
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>$ curl 127.0.0.1:6001/order/index
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>服务器端口号：	6001	b8c21f87-4c11-4c40-84c7-97db40c1ad20
</span></span></code></pre></div><h2 id="docker网络">Docker网络</h2>
<h3 id="是什么-2">是什么</h3>
<h4 id="docker不启动默认网络情况">Docker不启动，默认网络情况</h4>
<p>1、<code>ens33</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>ens33: <span style="color:#666;font-weight:bold;font-style:italic">flags</span>=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>        inet 172.16.173.128  netmask 255.255.255.0  broadcast 172.16.173.255
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>        inet6 fe80::5440:c6ca:eb51:dae4  prefixlen 64  scopeid 0x20&lt;link&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>        ether 00:0c:29:af:e5:6d  txqueuelen 1000  (Ethernet)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>        RX packets 118  bytes 13777 (13.4 KiB)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span><span>        RX errors 0  dropped 0  overruns 0  frame 0
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span><span>        TX packets 107  bytes 11996 (11.7 KiB)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8</span><span>        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
</span></span></code></pre></div><p>2、<code>lo</code></p>
<p><code>localhost</code>的简写，本地地址。一般为：<code>127.0.0.1</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>lo: <span style="color:#666;font-weight:bold;font-style:italic">flags</span>=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>        inet 127.0.0.1  netmask 255.0.0.0
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>        inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>        loop  txqueuelen 1000  (Local Loopback)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>        RX packets 0  bytes 0 (0.0 B)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span><span>        RX errors 0  dropped 0  overruns 0  frame 0
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span><span>        TX packets 0  bytes 0 (0.0 B)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8</span><span>        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
</span></span></code></pre></div><p>3、<code>virbr0</code></p>
<p>在 <code>CentOS7</code> 的安装过程中如果<strong>有选择相关虚拟化的服务安装系统后</strong>，启动网卡时会发现有一个以网桥连接的私网地址的 <code>virbr0</code> 网卡（<code>virbr0</code> 网卡：它还有一个固定的默认 <code>IP</code> 地址 <code>192.168.122.1</code>），是做虚拟机网桥的使用的，其作用是为连接其上的虚拟网卡提供 <code>NAT</code> 访问外网的功能。</p>
<p>之前安装 <code>Linux</code>，勾选安装系统的时候附带了 <code>libvirt</code> 服务才会生成，如果不需要可直接卸载：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ yum remove libvirt-libs.x86_64
</span></span></code></pre></div><h4 id="docker启动后网络情况">Docker启动后，网络情况</h4>
<p>会产生一个名为 <code>docker0</code> 的虚拟网桥</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>docker0: <span style="color:#666;font-weight:bold;font-style:italic">flags</span>=4099&lt;UP,BROADCAST,MULTICAST&gt;  mtu 1500
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>        inet 172.17.0.1  netmask 255.255.0.0  broadcast 172.17.255.255
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>        ether 02:42:c7:7f:fe:86  txqueuelen 0  (Ethernet)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>        RX packets 0  bytes 0 (0.0 B)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>        RX errors 0  dropped 0  overruns 0  frame 0
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span><span>        TX packets 0  bytes 0 (0.0 B)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span><span>        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
</span></span></code></pre></div><p>查看 <code>Docker</code> 网络模式命令：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker network ls
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>NETWORK ID     NAME      DRIVER    SCOPE
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>c991f0b97e5e   bridge    bridge    <span style="font-weight:bold;font-style:italic">local</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>8e6b4651280a   host      host      <span style="font-weight:bold;font-style:italic">local</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>612c09bd5f08   none      null      <span style="font-weight:bold;font-style:italic">local</span>
</span></span></code></pre></div><p>默认创建3大网络模式。</p>
<h3 id="常用基础命令">常用基础命令</h3>
<h4 id="all命令">All命令</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>$ docker network --help
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>Usage:  docker network COMMAND
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>Manage networks
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>Commands:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>  connect     Connect a container to a network
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>  create      Create a network
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>  disconnect  Disconnect a container from a network
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>  inspect     Display detailed information on one or more networks
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>  ls          List networks
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>  prune       Remove all unused networks
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>  rm          Remove one or more networks
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>Run <span style="color:#666;font-style:italic">&#39;docker network COMMAND --help&#39;</span> <span style="font-weight:bold">for</span> more information on a command.
</span></span></code></pre></div><h4 id="查看网络">查看网络</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker network ls
</span></span></code></pre></div><h4 id="查看网络源数据">查看网络源数据</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker network inspect XXX网络名字
</span></span></code></pre></div><h4 id="删除网络">删除网络</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker network rm XXX网络名字
</span></span></code></pre></div><h4 id="案例-1">案例</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>$ docker network create aa_network
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>1410ae30c25c2e21fe5a69538f531c3e2541d3cb0047f843f608daa8f395ebaf
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>$ docker network ls
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>NETWORK ID     NAME         DRIVER    SCOPE
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>1410ae30c25c   aa_network   bridge    <span style="font-weight:bold;font-style:italic">local</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>c991f0b97e5e   bridge       bridge    <span style="font-weight:bold;font-style:italic">local</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>8e6b4651280a   host         host      <span style="font-weight:bold;font-style:italic">local</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>612c09bd5f08   none         null      <span style="font-weight:bold;font-style:italic">local</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>$ docker network rm aa_network
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>aa_network
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>$ docker network ls
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>NETWORK ID     NAME      DRIVER    SCOPE
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>c991f0b97e5e   bridge    bridge    <span style="font-weight:bold;font-style:italic">local</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>8e6b4651280a   host      host      <span style="font-weight:bold;font-style:italic">local</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>612c09bd5f08   none      null      <span style="font-weight:bold;font-style:italic">local</span>
</span></span></code></pre></div><h3 id="能干嘛">能干嘛</h3>
<p>1、容器间的互联和通信以及端口映射</p>
<p>2、容器 <code>IP</code> 变动时可以通过服务名直接网络通信而不受影响</p>
<h3 id="网络模式">网络模式</h3>
<h4 id="总体介绍">总体介绍</h4>
<table>
<thead>
<tr>
<th style="text-align:left">网络模式</th>
<th style="text-align:left">简介</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">bridge</td>
<td style="text-align:left">为每一个容器分配、设置IP等，并将容器连接到一个<code>docker0</code>虚拟网桥，默认为该模式。</td>
</tr>
<tr>
<td style="text-align:left">host</td>
<td style="text-align:left">容器将不会虚拟出自己的网卡，配置自己的IP等，而是使用容器宿主机的IP和端口。</td>
</tr>
<tr>
<td style="text-align:left">none</td>
<td style="text-align:left">容器有独立的 <code>Network namespace</code>，但并没有对其进行任何网络设置，如分配 <code>veth pair</code> 和网桥连接，IP等。</td>
</tr>
<tr>
<td style="text-align:left">container</td>
<td style="text-align:left">新创建的容器不会创建自己的网卡和配置自己的IP，而是和一个指定的容器共享IP、端口范围等。</td>
</tr>
</tbody>
</table>
<ul>
<li><code>bridge</code> 模式：使用 <code>--network bridge</code> 指定，默认使用 <code>docker0</code></li>
<li><code>host</code> 模式：使用 <code>--network host</code> 指定</li>
<li><code>none</code> 模式：使用 <code>--network none</code> 指定</li>
<li><code>container</code> 模式：使用 <code>--network container:NAME 或 容器ID</code> 指定</li>
</ul>
<h4 id="容器实例内默认网络ip生产规则">容器实例内默认网络IP生产规则</h4>
<h5 id="说明">说明</h5>
<p>1、先启动两个 <code>ubuntu</code> 容器实例</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker run -it --name u1 ubuntu
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>root@c5fdfdfe9104:/# <span style="color:#888;font-style:italic">#按ctrl+p+q退出</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>$ docker run -it --name u2 ubuntu
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>root@0d892e6ef374:/# 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>$ docker ps
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span><span>CONTAINER ID   IMAGE     COMMAND   CREATED          STATUS          PORTS     NAMES
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span><span>0d892e6ef374   ubuntu    <span style="color:#666;font-style:italic">&#34;bash&#34;</span>    6 seconds ago    Up 5 seconds              u2
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8</span><span>c5fdfdfe9104   ubuntu    <span style="color:#666;font-style:italic">&#34;bash&#34;</span>    18 seconds ago   Up 17 seconds             u1
</span></span></code></pre></div><p>2、<code>docker inspect NAME|ID</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>$ docker inspect u1 | tail -n 20
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>            <span style="color:#666;font-style:italic">&#34;Networks&#34;</span>: {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>                <span style="color:#666;font-style:italic">&#34;bridge&#34;</span>: {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>                    <span style="color:#666;font-style:italic">&#34;IPAMConfig&#34;</span>: null,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>                    <span style="color:#666;font-style:italic">&#34;Links&#34;</span>: null,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>                    <span style="color:#666;font-style:italic">&#34;Aliases&#34;</span>: null,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>                    <span style="color:#666;font-style:italic">&#34;NetworkID&#34;</span>: <span style="color:#666;font-style:italic">&#34;c991f0b97e5e9d423f6632ef08c11577c01770d134da992b7c047a7dc45c9764&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>                    <span style="color:#666;font-style:italic">&#34;EndpointID&#34;</span>: <span style="color:#666;font-style:italic">&#34;752acb1d865c080b978b7417c051a4054285f4c4af84a694e9364c1febdac007&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>                    <span style="color:#666;font-style:italic">&#34;Gateway&#34;</span>: <span style="color:#666;font-style:italic">&#34;172.17.0.1&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>                    <span style="color:#666;font-style:italic">&#34;IPAddress&#34;</span>: <span style="color:#666;font-style:italic">&#34;172.17.0.2&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>                    <span style="color:#666;font-style:italic">&#34;IPPrefixLen&#34;</span>: 16,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>                    <span style="color:#666;font-style:italic">&#34;IPv6Gateway&#34;</span>: <span style="color:#666;font-style:italic">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>                    <span style="color:#666;font-style:italic">&#34;GlobalIPv6Address&#34;</span>: <span style="color:#666;font-style:italic">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>                    <span style="color:#666;font-style:italic">&#34;GlobalIPv6PrefixLen&#34;</span>: 0,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>                    <span style="color:#666;font-style:italic">&#34;MacAddress&#34;</span>: <span style="color:#666;font-style:italic">&#34;02:42:ac:11:00:02&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>                    <span style="color:#666;font-style:italic">&#34;DriverOpts&#34;</span>: null
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>                }
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>            }
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>        }
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>    }
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>]
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>$ docker inspect u2 | tail -n 20
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>            <span style="color:#666;font-style:italic">&#34;Networks&#34;</span>: {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>                <span style="color:#666;font-style:italic">&#34;bridge&#34;</span>: {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>                    <span style="color:#666;font-style:italic">&#34;IPAMConfig&#34;</span>: null,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>                    <span style="color:#666;font-style:italic">&#34;Links&#34;</span>: null,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>                    <span style="color:#666;font-style:italic">&#34;Aliases&#34;</span>: null,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span>                    <span style="color:#666;font-style:italic">&#34;NetworkID&#34;</span>: <span style="color:#666;font-style:italic">&#34;c991f0b97e5e9d423f6632ef08c11577c01770d134da992b7c047a7dc45c9764&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span>                    <span style="color:#666;font-style:italic">&#34;EndpointID&#34;</span>: <span style="color:#666;font-style:italic">&#34;c1be3f3a34a65f9305c4ab7fc45a229b5b5ffede7e0eb123adee30f463509089&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span>                    <span style="color:#666;font-style:italic">&#34;Gateway&#34;</span>: <span style="color:#666;font-style:italic">&#34;172.17.0.1&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span>                    <span style="color:#666;font-style:italic">&#34;IPAddress&#34;</span>: <span style="color:#666;font-style:italic">&#34;172.17.0.3&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span>                    <span style="color:#666;font-style:italic">&#34;IPPrefixLen&#34;</span>: 16,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span><span>                    <span style="color:#666;font-style:italic">&#34;IPv6Gateway&#34;</span>: <span style="color:#666;font-style:italic">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span><span>                    <span style="color:#666;font-style:italic">&#34;GlobalIPv6Address&#34;</span>: <span style="color:#666;font-style:italic">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span><span>                    <span style="color:#666;font-style:italic">&#34;GlobalIPv6PrefixLen&#34;</span>: 0,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span><span>                    <span style="color:#666;font-style:italic">&#34;MacAddress&#34;</span>: <span style="color:#666;font-style:italic">&#34;02:42:ac:11:00:03&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span><span>                    <span style="color:#666;font-style:italic">&#34;DriverOpts&#34;</span>: null
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span><span>                }
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span><span>            }
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span><span>        }
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span><span>    }
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span><span>]
</span></span></code></pre></div><p>3、关闭 <code>u2</code> 实例，新建 <code>u3</code>，查看 <code>ip</code> 变化</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>$ docker stop u2
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>u2
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>$ docker ps
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>CONTAINER ID   IMAGE     COMMAND   CREATED          STATUS              PORTS     NAMES
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>3858717e3f07   ubuntu    <span style="color:#666;font-style:italic">&#34;bash&#34;</span>    2 minutes ago    Up About a minute             u3
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>c5fdfdfe9104   ubuntu    <span style="color:#666;font-style:italic">&#34;bash&#34;</span>    11 minutes ago   Up 11 minutes                 u1
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>$ docker run -it --name u3 ubuntu
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>root@3858717e3f07:/# <span style="color:#888;font-style:italic">#按ctrl+p+q退出</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>$ docker inspect u3 | tail -n 20
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>            <span style="color:#666;font-style:italic">&#34;Networks&#34;</span>: {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>                <span style="color:#666;font-style:italic">&#34;bridge&#34;</span>: {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>                    <span style="color:#666;font-style:italic">&#34;IPAMConfig&#34;</span>: null,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>                    <span style="color:#666;font-style:italic">&#34;Links&#34;</span>: null,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>                    <span style="color:#666;font-style:italic">&#34;Aliases&#34;</span>: null,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>                    <span style="color:#666;font-style:italic">&#34;NetworkID&#34;</span>: <span style="color:#666;font-style:italic">&#34;c991f0b97e5e9d423f6632ef08c11577c01770d134da992b7c047a7dc45c9764&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>                    <span style="color:#666;font-style:italic">&#34;EndpointID&#34;</span>: <span style="color:#666;font-style:italic">&#34;9d67500fdd88e7d14f073d03b41648d065c1c419fedcd549e4e42174a1e377ac&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>                    <span style="color:#666;font-style:italic">&#34;Gateway&#34;</span>: <span style="color:#666;font-style:italic">&#34;172.17.0.1&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>                    <span style="color:#666;font-style:italic">&#34;IPAddress&#34;</span>: <span style="color:#666;font-style:italic">&#34;172.17.0.3&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>                    <span style="color:#666;font-style:italic">&#34;IPPrefixLen&#34;</span>: 16,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>                    <span style="color:#666;font-style:italic">&#34;IPv6Gateway&#34;</span>: <span style="color:#666;font-style:italic">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>                    <span style="color:#666;font-style:italic">&#34;GlobalIPv6Address&#34;</span>: <span style="color:#666;font-style:italic">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>                    <span style="color:#666;font-style:italic">&#34;GlobalIPv6PrefixLen&#34;</span>: 0,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>                    <span style="color:#666;font-style:italic">&#34;MacAddress&#34;</span>: <span style="color:#666;font-style:italic">&#34;02:42:ac:11:00:03&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>                    <span style="color:#666;font-style:italic">&#34;DriverOpts&#34;</span>: null
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>                }
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>            }
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>        }
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span>    }
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span>]
</span></span></code></pre></div><h5 id="结论">结论</h5>
<p><strong><code>Docker</code> 容器内部的 <code>IP</code> 是有可能会发生改变的</strong>。</p>
<h4 id="案例说明">案例说明</h4>
<h5 id="bridge">bridge</h5>
<p>1、是什么</p>
<p><code>Docker</code> 服务默认会创建一个 <code>docker0</code> 网桥（其上有一个 <code>docker0</code> 内部接口），该桥接网络的名称为 <code>docker0</code>，它在<strong>内核层</strong>连通了其他的物理或虚拟网卡，这就将所有容器和本地主机都放到<strong>同一个物理网络</strong>。<code>Docker</code> 默认指定 <code>docker0</code> 接口的 <code>IP</code> 地址和子网掩码，<strong>让主机和容器之间可以通过网桥相互通信</strong>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span><span style="color:#888;font-style:italic">#查看bridge网络的详细信息，并通过grep获取名称项</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>$ docker network inspect bridge | grep name
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>            <span style="color:#666;font-style:italic">&#34;com.docker.network.bridge.name&#34;</span>: <span style="color:#666;font-style:italic">&#34;docker0&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>$ ifconfig | grep docker
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>docker0: <span style="color:#666;font-weight:bold;font-style:italic">flags</span>=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
</span></span></code></pre></div><p>2、案例</p>
<p>①说明</p>
<ol>
<li>
<p><code>Docker</code> 使用 <code>Linux桥接</code>，在宿主机虚拟一个 <code>Docker</code> 容器网桥(<code>docker0</code>)，<code>Docker</code> 启动一个容器时会根据 <code>Docker</code> 网桥的网段分配给容器一个 <code>IP</code> 地址，称为<code>Container-IP</code>，同时 <code>Docker</code> 网桥是每个容器的默认网关。因为在同一宿主机内的容器都接入同一个网桥，这样容器之间就能够通过容器的<code>Container-IP</code>直接通信。</p>
</li>
<li>
<p><code>docker run</code> 时，如果没有指定 <code>network</code> ，默认使用的网桥模式就是 <code>bridge</code>，使用的就是 <code>docker0</code>。在宿主机 <code>ifconfig</code>，就可以看到 <code>docker0</code> 和自己 <code>create</code> 的 <code>network</code> 的 <code>eth0</code>，<code>eth1</code>，<code>eth2</code>……代表网卡一，网卡二，网卡三……，<code>lo</code>代表 <code>127.0.0.1</code>，即<code>localhost</code>，<code>inet addr</code> 用来表示网卡的 <code>IP</code> 地址。</p>
</li>
<li>
<p>网桥 <code>docker0</code> 创建一对对等虚拟设备接口一个叫 <code>veth</code>，另一个叫 <code>eth0</code>，成对匹配。</p>
<ul>
<li>整个宿主机的网桥模式都是 <code>docker0</code>，类似一个交换机有一堆接口，每个接口叫 <code>veth</code>，在本地主机和容器内分别创建一个虚拟接口，并让他们彼此连通（这样一对接口叫 <code>veth pair</code>）；</li>
<li>每个容器实例内部也有一块网卡，每个接口叫 <code>eht0</code>；</li>
<li><code>docker0</code> 上面的每个 <code>veth</code> 匹配某个容器实例内部的 <code>eth0</code>，两两配对，一一匹配。</li>
</ul>
</li>
</ol>
<p>通过上述，将宿主机上的所有容器都连接到这个内部网络上，两个容器在同一个网络下，会从这个网关下各自拿到分配的 <code>ip</code>，此时两个容器的网络是互通的。</p>
<p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/bridge.png">
            <img class="mx-auto" alt="bridge" src="https://blog.imw7.com/images/docker/bridge.png" />
        </a>
    </p>
<p>②代码</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker run -d -p 8081:8080 --name tomcat81 billygoo/tomcat8-jdk8
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>$ docker run -d -p 8082:8080 --name tomcat82 billygoo/tomcat8-jdk8
</span></span></code></pre></div><p>③两两匹配验证</p>
<p>宿主机：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ ip addr | tail -n 8
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>5: vethf9ef600@if4: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>    link/ether 9a:10:64:15:ef:58 brd ff:ff:ff:ff:ff:ff link-netnsid 0
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>    inet6 fe80::9810:64ff:fe15:ef58/64 scope link 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>       valid_lft forever preferred_lft forever
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span><span>7: veth2fbe32f@if6: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span><span>    link/ether 0e:15:26:b7:b4:91 brd ff:ff:ff:ff:ff:ff link-netnsid 1
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8</span><span>    inet6 fe80::c15:26ff:feb7:b491/64 scope link 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9</span><span>       valid_lft forever preferred_lft forever
</span></span></code></pre></div><p><code>tomcat81</code>：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>$ docker <span style="font-weight:bold;font-style:italic">exec</span> -it tomcat81 bash
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>oot@3fdde15b6173:/usr/local/tomcat# ip addr
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>    inet 127.0.0.1/8 scope host lo
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>       valid_lft forever preferred_lft forever
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>4: eth0@if5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff link-netnsid 0
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>       valid_lft forever preferred_lft forever
</span></span></code></pre></div><p><code>tomcat82</code>：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>$ docker <span style="font-weight:bold;font-style:italic">exec</span> -it tomcat82 bash
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>root@eec5bc95985b:/usr/local/tomcat# ip addr
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>root@455ddfebfa4e:/usr/local/tomcat# ip addr
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>    inet 127.0.0.1/8 scope host lo
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>       valid_lft forever preferred_lft forever
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>6: eth0@if7: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>    link/ether 02:42:ac:11:00:03 brd ff:ff:ff:ff:ff:ff link-netnsid 0
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>    inet 172.17.0.3/16 brd 172.17.255.255 scope global eth0
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>       valid_lft forever preferred_lft forever
</span></span></code></pre></div><h5 id="host">host</h5>
<p>1、是什么</p>
<p>直接使用宿主机的 <code>IP</code> 地址与外界进行通信，不再需要额外进行 <code>NAT</code> 转接。</p>
<p>2、案例</p>
<p>①说明</p>
<p>容器将<strong>不会获得</strong>一个独立的 <code>Network Namespace</code>，而是和宿主机共用一个<code>Network Namespace</code>。<strong>容器将不会虚拟出自己的网卡而是使用宿主机的IP和端口</strong>。</p>
<p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/host.png">
            <img class="mx-auto" alt="host" src="https://blog.imw7.com/images/docker/host.png" />
        </a>
    </p>
<p>②代码</p>
<p><strong>警告</strong>：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker run -d -p 8083:8080 --network host --name tomcat83 billygoo/tomcat8-jdk8
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>WARNING: Published ports are discarded when using host network mode
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>ee04c5a61a805f7564a9327bdd0486af91d1292b8d4262d8d794fbe6eaa0d367
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>$ docker ps
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>CONTAINER ID   IMAGE                   COMMAND            CREATED        STATUS          PORTS      NAMES
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span><span>ee04c5a61a80   billygoo/tomcat8-jdk8   <span style="color:#666;font-style:italic">&#34;catalina.sh run&#34;</span>  3 seconds age  Up 2 seconds               tomcat83
</span></span></code></pre></div><ol>
<li>问题：<code>Docker</code> 启动时总是遇见上面的警告</li>
<li>原因：<code>Docker</code> 启动时指定 <code>--network=host</code> 或 <code>-net=host</code>，如果还指定了 <code>-p</code> 映射端口，那这个时候就会有此警告。并且通过 <code>-p</code> 设置的参数将不会起到任何作用，端口号会以主机端口号为主，重复时则递增。</li>
<li>解决：解决的办法就是使用 <code>Docker</code> 的其他网络模式，例如 <code>--network=bridge</code>，这样就可以解决问题，或者直接无视……</li>
</ol>
<p><strong>正确</strong>：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker run -d --network host --name tomcat83 billygoo/tomcat8-jdk8
</span></span></code></pre></div><p><strong>注意</strong>：没有之前的配对显示了，看容器实例内部：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>$ docker inspect tomcat83 | tail -n 20
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>            <span style="color:#666;font-style:italic">&#34;Networks&#34;</span>: {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>                <span style="color:#666;font-style:italic">&#34;host&#34;</span>: {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>                    <span style="color:#666;font-style:italic">&#34;IPAMConfig&#34;</span>: null,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>                    <span style="color:#666;font-style:italic">&#34;Links&#34;</span>: null,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>                    <span style="color:#666;font-style:italic">&#34;Aliases&#34;</span>: null,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>                    <span style="color:#666;font-style:italic">&#34;NetworkID&#34;</span>: <span style="color:#666;font-style:italic">&#34;bf93337b605d54c375263979dda34234ddbeff5f39c17ca921cbefad3dd8acab&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>                    <span style="color:#666;font-style:italic">&#34;EndpointID&#34;</span>: <span style="color:#666;font-style:italic">&#34;ddaea4ae78633f41b13e5ca4cdc652f8142a766109d1584bafc4a23205583d62&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>                    <span style="color:#666;font-style:italic">&#34;Gateway&#34;</span>: <span style="color:#666;font-style:italic">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>                    <span style="color:#666;font-style:italic">&#34;IPAddress&#34;</span>: <span style="color:#666;font-style:italic">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>                    <span style="color:#666;font-style:italic">&#34;IPPrefixLen&#34;</span>: 0,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>                    <span style="color:#666;font-style:italic">&#34;IPv6Gateway&#34;</span>: <span style="color:#666;font-style:italic">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>                    <span style="color:#666;font-style:italic">&#34;GlobalIPv6Address&#34;</span>: <span style="color:#666;font-style:italic">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>                    <span style="color:#666;font-style:italic">&#34;GlobalIPv6PrefixLen&#34;</span>: 0,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>                    <span style="color:#666;font-style:italic">&#34;MacAddress&#34;</span>: <span style="color:#666;font-style:italic">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>                    <span style="color:#666;font-style:italic">&#34;DriverOpts&#34;</span>: null
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>                }
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>            }
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>        }
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>    }
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>]
</span></span></code></pre></div><p>可以看到，<code>host</code> 网络模式下 <code>Gateway</code> 和 <code>IPAddress</code> 都为空。全部使用的是宿主机的。</p>
<p><strong>问题</strong>：没有设置 <code>-p</code> 的端口映射了，如何访问启动的 <code>tomcat83</code>？</p>
<p>使用 <code>http://宿主机IP:8080</code> 即可访问 <code>tomcat83</code>。</p>
<p>在 <code>CentOS</code> 里面用默认的火狐浏览器访问容器内的 <code>tomcat83</code> 看到访问成功，因为此时容器的 <code>IP</code> 借用主机的，所以容器共享宿主机网络 <code>IP</code>，这样的好处是外部主机与容器可以直接通信。</p>
<h5 id="none">none</h5>
<p>1、是什么</p>
<p>禁用网络功能，只有 <code>lo</code> 标识（就是 <code>127.0.0.1</code> 表示本地回环）。</p>
<p>在 <code>none</code> 模式下，并不为 <code>Docker</code> 容器进行任何网络配置。也就是说，这个 <code>Docker</code> 容器没有网卡、<code>IP</code>、路由等信息，只有一个<code>lo</code>。需要自己为 <code>Docker</code> 容器添加网卡、配置 <code>IP</code> 等。</p>
<p>2、案例</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>$ docker run -d -p 8084:8080 --network none --name tomcat84 billygoo/tomcat8-jdk8
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>7933d4080506dd4ace2f060d4a002ef6d78cb1cfe74c402e478f13dd67975c6c
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>$ docker ps
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>CONTAINER ID   IMAGE                   COMMAND             CREATED          STATUS          PORTS          NAMES
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>7933d4080506   billygoo/tomcat8-jdk8   <span style="color:#666;font-style:italic">&#34;catalina.sh run&#34;</span>   2 seconds ago    Up 2 seconds                   tomcat84
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>$ docker inspect tomcat84 | tail -n 20
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>            <span style="color:#666;font-style:italic">&#34;Networks&#34;</span>: {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>                <span style="color:#666;font-style:italic">&#34;none&#34;</span>: {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>                    <span style="color:#666;font-style:italic">&#34;IPAMConfig&#34;</span>: null,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>                    <span style="color:#666;font-style:italic">&#34;Links&#34;</span>: null,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>                    <span style="color:#666;font-style:italic">&#34;Aliases&#34;</span>: null,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>                    <span style="color:#666;font-style:italic">&#34;NetworkID&#34;</span>: <span style="color:#666;font-style:italic">&#34;a287a6fe57a0f10ae3e407ca9841daff6d868dbd8cef80b54a452b73022df043&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>                    <span style="color:#666;font-style:italic">&#34;EndpointID&#34;</span>: <span style="color:#666;font-style:italic">&#34;3a628a91ded6737c235012e015e5b2f355153fe37f03069dc4dc2d3944353a9b&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>                    <span style="color:#666;font-style:italic">&#34;Gateway&#34;</span>: <span style="color:#666;font-style:italic">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>                    <span style="color:#666;font-style:italic">&#34;IPAddress&#34;</span>: <span style="color:#666;font-style:italic">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>                    <span style="color:#666;font-style:italic">&#34;IPPrefixLen&#34;</span>: 0,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>                    <span style="color:#666;font-style:italic">&#34;IPv6Gateway&#34;</span>: <span style="color:#666;font-style:italic">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>                    <span style="color:#666;font-style:italic">&#34;GlobalIPv6Address&#34;</span>: <span style="color:#666;font-style:italic">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>                    <span style="color:#666;font-style:italic">&#34;GlobalIPv6PrefixLen&#34;</span>: 0,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>                    <span style="color:#666;font-style:italic">&#34;MacAddress&#34;</span>: <span style="color:#666;font-style:italic">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>                    <span style="color:#666;font-style:italic">&#34;DriverOpts&#34;</span>: null
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>                }
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>            }
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>        }
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>    }
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>]
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>$ docker <span style="font-weight:bold;font-style:italic">exec</span> -it tomcat84 bash
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span>root@7933d4080506:/usr/local/tomcat# ip addr
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span>    inet 127.0.0.1/8 scope host lo
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span>       valid_lft forever preferred_lft forever
</span></span></code></pre></div><h5 id="container">container</h5>
<p>1、是什么</p>
<p><code>container</code> 网络模式，新建的容器和已经存在的一个容器共享一个网络 <code>IP</code> 配置而不是和宿主机共享，新创建的容器不会创建自己的网卡，配置自己的 <code>IP</code>，而是和一个指定的容器共享 <code>IP</code>、端口范围等。同样，两个容器除了网络方面，其他的如文件系统、进程列表等还是隔离的。</p>
<p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/container.png">
            <img class="mx-auto" alt="container" src="https://blog.imw7.com/images/docker/container.png" />
        </a>
    </p>
<p>2、案例</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker run -d -p 8085:8080 --name tomcat85 billygoo/tomcat8-jdk8
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>$ docker run -d -p 8086:8080 --network container:tomcat85 --name tomcat86 billygoo/tomcat8-jdk8
</span></span></code></pre></div><p>运行结果：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker run -d -p 8086:8080 --network container:tomcat85 --name tomcat86 billygoo/tomcat8-jdk8
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>docker: Error response from daemon: conflicting options: port publishing and the container <span style="font-weight:bold;font-style:italic">type</span> network mode.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>See <span style="color:#666;font-style:italic">&#39;docker run --help&#39;</span>.
</span></span></code></pre></div><p>相当于<code>tomcat86</code> 和 <code>tomcat85</code> 共用同一个 <code>IP</code> 同一个端口，导致端口冲突。</p>
<p>3、案例2</p>
<p><code>Alpine</code> 操作系统是一个面向安全的轻型 <code>Linux</code> 发行版。<code>Alpine Linux</code> 是一款独立的、非商用的通用 <code>Linux</code> 发行版，专为追求安全性、简单性和资源效率的用户而设计。可能很多人没听说过这个 <code>Linux</code> 发行版本，但是经常用 <code>Docker</code> 的朋友可能都用过，因为它以小、简单、安全而著称，所以作为基础镜像是非常好的一个选择，可谓是麻雀虽小但五脏俱全，镜像非常小巧，不到 <code>6M</code> 的大小，所以特别适合容器打包。</p>
<p>命令：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker run -it --name alpine1 alpine /bin/sh
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>$ docker run -it --network container:alpine1 --name alpine2 alpine /bin/sh
</span></span></code></pre></div><p>运行结果，验证共用搭桥：</p>
<p><code>alpine1</code>：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>$ docker run -it --name alpine1 alpine /bin/sh
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>/ <span style="color:#888;font-style:italic"># ip addr</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>    inet 127.0.0.1/8 scope host lo
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>       valid_lft forever preferred_lft forever
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>8: eth0@if9: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>       valid_lft forever preferred_lft forever
</span></span></code></pre></div><p><code>alpine2</code>：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>$ docker run -it --network container:alpine1 --name alpine2 alpine /bin/sh
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>/ <span style="color:#888;font-style:italic"># ip addr</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>    inet 127.0.0.1/8 scope host lo
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>       valid_lft forever preferred_lft forever
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>8: eth0@if9: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>       valid_lft forever preferred_lft forever
</span></span></code></pre></div><p>假如此时关闭 <code>apline1</code>，再看看 <code>alpine2</code>：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ ip addr
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>    inet 127.0.0.1/8 scope host lo
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>       valid_lft forever preferred_lft forever
</span></span></code></pre></div><h5 id="自定义网络">自定义网络</h5>
<p>1、过时的link</p>
<p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/links.png">
            <img class="mx-auto" alt="links" src="https://blog.imw7.com/images/docker/links.png" />
        </a>
    </p>
<p>2、是什么</p>
<p>3、案例</p>
<p>① before</p>
<ol>
<li>案例</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker run -d -p 8081:8080 --name tomcat81 billygoo/tomcat8-jdk8
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>$ docker run -d -p 8082:8080 --name tomcat82 billygoo/tomcat8-jdk8
</span></span></code></pre></div><p>上述成功启动并用 <code>docker exec</code> 进入各自容器实例内部。</p>
<ol start="2">
<li>问题</li>
</ol>
<ul>
<li>
<p>按照 <code>IP</code> 地址 <code>ping</code> 是可以的</p>
<ul>
<li>查看 <code>IP</code> 地址：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>$ docker <span style="font-weight:bold;font-style:italic">exec</span> -it tomcat81 bash
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>root@7273c8b7579b:/usr/local/tomcat# ip addr
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>    inet 127.0.0.1/8 scope host lo
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>       valid_lft forever preferred_lft forever
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>4: eth0@if5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff link-netnsid 0
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>       valid_lft forever preferred_lft forever
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>$ docker <span style="font-weight:bold;font-style:italic">exec</span> -it tomcat82 bash
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>root@2d1a3d035761:/usr/local/tomcat# ip addr
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>    inet 127.0.0.1/8 scope host lo
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>       valid_lft forever preferred_lft forever
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>6: eth0@if7: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>    link/ether 02:42:ac:11:00:03 brd ff:ff:ff:ff:ff:ff link-netnsid 0
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>    inet 172.17.0.3/16 brd 172.17.255.255 scope global eth0
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>       valid_lft forever preferred_lft forever
</span></span></code></pre></div><ul>
<li>在 <code>tomcat81</code> 中 <code>ping</code> <code>tomcat82</code>：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>root@7273c8b7579b:/usr/local/tomcat# ping 172.17.0.3
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>PING 172.17.0.3 (172.17.0.3) 56(84) bytes of data.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>64 bytes from 172.17.0.3: <span style="color:#666;font-weight:bold;font-style:italic">icmp_seq</span>=1 <span style="color:#666;font-weight:bold;font-style:italic">ttl</span>=64 <span style="color:#666;font-weight:bold;font-style:italic">time</span>=0.077 ms
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>64 bytes from 172.17.0.3: <span style="color:#666;font-weight:bold;font-style:italic">icmp_seq</span>=2 <span style="color:#666;font-weight:bold;font-style:italic">ttl</span>=64 <span style="color:#666;font-weight:bold;font-style:italic">time</span>=0.102 ms
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>64 bytes from 172.17.0.3: <span style="color:#666;font-weight:bold;font-style:italic">icmp_seq</span>=3 <span style="color:#666;font-weight:bold;font-style:italic">ttl</span>=64 <span style="color:#666;font-weight:bold;font-style:italic">time</span>=0.109 ms
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>64 bytes from 172.17.0.3: <span style="color:#666;font-weight:bold;font-style:italic">icmp_seq</span>=4 <span style="color:#666;font-weight:bold;font-style:italic">ttl</span>=64 <span style="color:#666;font-weight:bold;font-style:italic">time</span>=0.103 ms
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>^C
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>--- 172.17.0.3 ping statistics ---
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>4 packets transmitted, 4 received, 0% packet loss, <span style="font-weight:bold;font-style:italic">time</span> 3001ms
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>rtt min/avg/max/mdev = 0.077/0.097/0.109/0.017 ms
</span></span></code></pre></div><ul>
<li>在 <code>tomcat82</code> 中 <code>ping</code> <code>tomcat81</code>：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>root@2d1a3d035761:/usr/local/tomcat# ping 172.17.0.2
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>PING 172.17.0.2 (172.17.0.2) 56(84) bytes of data.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>64 bytes from 172.17.0.2: <span style="color:#666;font-weight:bold;font-style:italic">icmp_seq</span>=1 <span style="color:#666;font-weight:bold;font-style:italic">ttl</span>=64 <span style="color:#666;font-weight:bold;font-style:italic">time</span>=0.079 ms
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>64 bytes from 172.17.0.2: <span style="color:#666;font-weight:bold;font-style:italic">icmp_seq</span>=2 <span style="color:#666;font-weight:bold;font-style:italic">ttl</span>=64 <span style="color:#666;font-weight:bold;font-style:italic">time</span>=0.113 ms
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>64 bytes from 172.17.0.2: <span style="color:#666;font-weight:bold;font-style:italic">icmp_seq</span>=3 <span style="color:#666;font-weight:bold;font-style:italic">ttl</span>=64 <span style="color:#666;font-weight:bold;font-style:italic">time</span>=0.178 ms
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>64 bytes from 172.17.0.2: <span style="color:#666;font-weight:bold;font-style:italic">icmp_seq</span>=4 <span style="color:#666;font-weight:bold;font-style:italic">ttl</span>=64 <span style="color:#666;font-weight:bold;font-style:italic">time</span>=0.114 ms
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>^C
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>--- 172.17.0.2 ping statistics ---
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>4 packets transmitted, 4 received, 0% packet loss, <span style="font-weight:bold;font-style:italic">time</span> 2999ms
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>rtt min/avg/max/mdev = 0.079/0.121/0.178/0.035 ms
</span></span></code></pre></div></li>
</ul>
<ul>
<li>
<p>按照服务名 <code>ping</code> 结果？</p>
<ul>
<li>在 <code>tomcat81</code> 中按照服务名 <code>ping</code> <code>tomcat82</code>：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>root@7273c8b7579b:/usr/local/tomcat# ping tomcat82
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>ping: tomcat82: Name or service not known
</span></span></code></pre></div><ul>
<li>在 <code>tomcat82</code> 中按照服务名 <code>ping</code> <code>tomcat81</code>：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>root@2d1a3d035761:/usr/local/tomcat# ping tomcat81
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>ping: tomcat81: Name or service not known
</span></span></code></pre></div></li>
</ul>
<p>以上使用服务名是 <code>ping</code> 不通的。</p>
<p>② after</p>
<ol>
<li>案例</li>
</ol>
<p>​	自定义桥接网络，自定义网络默认使用的桥接网络 <code>bridge</code>。</p>
<ul>
<li>新建自定义网络</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>$ docker network ls
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>NETWORK ID     NAME      DRIVER    SCOPE
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>2e29d6fa39aa   bridge    bridge    <span style="font-weight:bold;font-style:italic">local</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>8e6b4651280a   host      host      <span style="font-weight:bold;font-style:italic">local</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>612c09bd5f08   none      null      <span style="font-weight:bold;font-style:italic">local</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>$ docker network create my_network
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>a996f674abd8e93b6f197e0dac501d2668c7b5390e105a83a1d1e40d07cc82ac
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>$ docker network ls
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>NETWORK ID     NAME         DRIVER    SCOPE
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>2e29d6fa39aa   bridge       bridge    <span style="font-weight:bold;font-style:italic">local</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>8e6b4651280a   host         host      <span style="font-weight:bold;font-style:italic">local</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>a996f674abd8   my_network   bridge    <span style="font-weight:bold;font-style:italic">local</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>612c09bd5f08   none         null      <span style="font-weight:bold;font-style:italic">local</span>
</span></span></code></pre></div><ul>
<li>新建容器加入上一步新建的自定义网络</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker run -d -p 8081:8080 --network my_network --name tomcat81 billygoo/tomcat8-jdk8
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>$ docker run -d -p 8082:8080 --network my_network --name tomcat82 billygoo/tomcat8-jdk8
</span></span></code></pre></div><ul>
<li>
<p>互相 <code>ping</code> 测试</p>
<ul>
<li>进入容器查看 <code>IP</code> 地址：</li>
</ul>
<p><code>tomcat81</code>：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>$ docker <span style="font-weight:bold;font-style:italic">exec</span> -it tomcat81 bash
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>root@1a5a5a7ce19c:/usr/local/tomcat# ip addr
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>    inet 127.0.0.1/8 scope host lo
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>       valid_lft forever preferred_lft forever
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>9: eth0@if10: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>    link/ether 02:42:ac:12:00:02 brd ff:ff:ff:ff:ff:ff link-netnsid 0
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>    inet 172.18.0.2/16 brd 172.18.255.255 scope global eth0
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>       valid_lft forever preferred_lft forever
</span></span></code></pre></div><p><code>tomcat82</code>：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>$ docker <span style="font-weight:bold;font-style:italic">exec</span> -it tomcat82 bash
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>root@6a3eb013f735:/usr/local/tomcat# ip addr
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>    inet 127.0.0.1/8 scope host lo
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>       valid_lft forever preferred_lft forever
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>11: eth0@if12: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>    link/ether 02:42:ac:12:00:03 brd ff:ff:ff:ff:ff:ff link-netnsid 0
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>    inet 172.18.0.3/16 brd 172.18.255.255 scope global eth0
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>       valid_lft forever preferred_lft forever
</span></span></code></pre></div><ul>
<li><code>IP</code> 地址和服务名均可互相 <code>ping</code> 通：</li>
</ul>
<p>在 <code>tomcat81</code> 中 <code>ping</code> <code>tomcat82</code>：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>root@1a5a5a7ce19c:/usr/local/tomcat# ping 172.18.0.3
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>PING 172.18.0.3 (172.18.0.3) 56(84) bytes of data.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>64 bytes from 172.18.0.3: <span style="color:#666;font-weight:bold;font-style:italic">icmp_seq</span>=1 <span style="color:#666;font-weight:bold;font-style:italic">ttl</span>=64 <span style="color:#666;font-weight:bold;font-style:italic">time</span>=2.02 ms
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>64 bytes from 172.18.0.3: <span style="color:#666;font-weight:bold;font-style:italic">icmp_seq</span>=2 <span style="color:#666;font-weight:bold;font-style:italic">ttl</span>=64 <span style="color:#666;font-weight:bold;font-style:italic">time</span>=0.070 ms
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>64 bytes from 172.18.0.3: <span style="color:#666;font-weight:bold;font-style:italic">icmp_seq</span>=3 <span style="color:#666;font-weight:bold;font-style:italic">ttl</span>=64 <span style="color:#666;font-weight:bold;font-style:italic">time</span>=0.112 ms
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>^C
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>--- 172.18.0.3 ping statistics ---
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>3 packets transmitted, 3 received, 0% packet loss, <span style="font-weight:bold;font-style:italic">time</span> 2001ms
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>rtt min/avg/max/mdev = 0.070/0.735/2.024/0.911 ms
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>root@1a5a5a7ce19c:/usr/local/tomcat# ping tomcat82
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>PING tomcat82 (172.18.0.3) 56(84) bytes of data.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>64 bytes from tomcat82.my_network (172.18.0.3): <span style="color:#666;font-weight:bold;font-style:italic">icmp_seq</span>=1 <span style="color:#666;font-weight:bold;font-style:italic">ttl</span>=64 <span style="color:#666;font-weight:bold;font-style:italic">time</span>=0.066 ms
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>64 bytes from tomcat82.my_network (172.18.0.3): <span style="color:#666;font-weight:bold;font-style:italic">icmp_seq</span>=2 <span style="color:#666;font-weight:bold;font-style:italic">ttl</span>=64 <span style="color:#666;font-weight:bold;font-style:italic">time</span>=0.114 ms
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>64 bytes from tomcat82.my_network (172.18.0.3): <span style="color:#666;font-weight:bold;font-style:italic">icmp_seq</span>=3 <span style="color:#666;font-weight:bold;font-style:italic">ttl</span>=64 <span style="color:#666;font-weight:bold;font-style:italic">time</span>=0.104 ms
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>^C
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>--- tomcat82 ping statistics ---
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>3 packets transmitted, 3 received, 0% packet loss, <span style="font-weight:bold;font-style:italic">time</span> 2003ms
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>rtt min/avg/max/mdev = 0.066/0.094/0.114/0.023 ms
</span></span></code></pre></div><p>在 <code>tomcat82</code> 中 <code>ping</code> <code>tomcat81</code>：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>root@6a3eb013f735:/usr/local/tomcat# ping 172.18.0.2
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>PING 172.18.0.2 (172.18.0.2) 56(84) bytes of data.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>64 bytes from 172.18.0.2: <span style="color:#666;font-weight:bold;font-style:italic">icmp_seq</span>=1 <span style="color:#666;font-weight:bold;font-style:italic">ttl</span>=64 <span style="color:#666;font-weight:bold;font-style:italic">time</span>=0.099 ms
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>64 bytes from 172.18.0.2: <span style="color:#666;font-weight:bold;font-style:italic">icmp_seq</span>=2 <span style="color:#666;font-weight:bold;font-style:italic">ttl</span>=64 <span style="color:#666;font-weight:bold;font-style:italic">time</span>=0.112 ms
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>64 bytes from 172.18.0.2: <span style="color:#666;font-weight:bold;font-style:italic">icmp_seq</span>=3 <span style="color:#666;font-weight:bold;font-style:italic">ttl</span>=64 <span style="color:#666;font-weight:bold;font-style:italic">time</span>=0.110 ms
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>^C
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>--- 172.18.0.2 ping statistics ---
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>3 packets transmitted, 3 received, 0% packet loss, <span style="font-weight:bold;font-style:italic">time</span> 2001ms
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>rtt min/avg/max/mdev = 0.099/0.107/0.112/0.005 ms
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>root@6a3eb013f735:/usr/local/tomcat# ping tomcat81
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>PING tomcat81 (172.18.0.2) 56(84) bytes of data.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>64 bytes from tomcat81.my_network (172.18.0.2): <span style="color:#666;font-weight:bold;font-style:italic">icmp_seq</span>=1 <span style="color:#666;font-weight:bold;font-style:italic">ttl</span>=64 <span style="color:#666;font-weight:bold;font-style:italic">time</span>=0.062 ms
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>64 bytes from tomcat81.my_network (172.18.0.2): <span style="color:#666;font-weight:bold;font-style:italic">icmp_seq</span>=2 <span style="color:#666;font-weight:bold;font-style:italic">ttl</span>=64 <span style="color:#666;font-weight:bold;font-style:italic">time</span>=0.206 ms
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>64 bytes from tomcat81.my_network (172.18.0.2): <span style="color:#666;font-weight:bold;font-style:italic">icmp_seq</span>=3 <span style="color:#666;font-weight:bold;font-style:italic">ttl</span>=64 <span style="color:#666;font-weight:bold;font-style:italic">time</span>=0.132 ms
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>^C
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>--- tomcat81 ping statistics ---
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>3 packets transmitted, 3 received, 0% packet loss, <span style="font-weight:bold;font-style:italic">time</span> 2002ms
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>rtt min/avg/max/mdev = 0.062/0.133/0.206/0.059 ms
</span></span></code></pre></div></li>
</ul>
<ol start="2">
<li>问题结论</li>
</ol>
<p>​	自定义网络本身就维护好了主机名和 <code>ip</code> 的对应关系（<code>ip</code> 和域名都能通）。</p>
<h3 id="docker平台架构图解">Docker平台架构图解</h3>
<h4 id="整体说明">整体说明</h4>
<p>从其架构和运行流程来看，<code>Docker</code> 是一个 <code>C/S</code> 模式的架构，后端是一个松耦合架构，众多模型各司其职。</p>
<p><code>Docker</code> 运行的基本流程为：</p>
<p>1、用户是使用 <code>Docker Client</code> 与 <code>Docker Daemon</code> 建立通信，并发送请求给后者。</p>
<p>2、<code>Docker Daemon</code> 作为 <code>Docker</code> 架构中的主体部分，首先提供 <code>Docker Server</code> 的功能使其可以接受 <code>Docker Client</code> 的请求。</p>
<p>3、<code>Docker Engine</code> 执行 <code>Docker</code> 内部的一系列工作，每一项工作都是以一个 <code>Job</code> 的形式的存在。</p>
<p>4、<code>Job</code> 的运行过程中，当需要容器镜像时，则从 <code>Docker Registry</code> 中下载镜像，并通过镜像管理驱动 <code>Graph driver</code> 将下载镜像以 <code>Graph</code> 的形式存储。</p>
<p>5、当需要为 <code>Docker</code> 创建网络环境时，通过网络管理驱动 <code>Network driver</code> 创建并配置 <code>Docker</code> 容器网络环境。</p>
<p>6、当需要限制 <code>Docker</code> 容器运行资源或执行用户指令等操作时，则通过 <code>Execdriver</code> 来完成。</p>
<p>7、<code>Libcontainer</code> 是一项独立的容器管理包，<code>Network driver</code> 以及 <code>Exec driver</code> 都是通过 <code>Libcontainer</code> 来实现具体对容器进行的操作。</p>
<h4 id="整体架构">整体架构</h4>
<p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/docker_structure.jpg">
            <img class="mx-auto" alt="docker_structure" src="https://blog.imw7.com/images/docker/docker_structure.jpg" />
        </a>
    </p>
<h2 id="docker-compose容器编排">Docker-compose容器编排</h2>
<h3 id="简介">简介</h3>
<h4 id="概念">概念</h4>
<p><code>Docker-Compose</code> 是 <code>Docker</code> 官方的开源项目，负责实现对 <code>Docker</code> 容器集群的快速编排。</p>
<p><code>Compose</code> 是 <code>Docker</code> 公司推出的一个工具软件，可以管理多个 <code>Docker</code> 容器组成一个应用。你需要定义一个 <code>YAML</code> 格式的配置文件 <code>docker-compose.yaml</code>。写好多个容器之间的调用关系，然后，只需要一个命令，就能同时启动/关闭这些容器。</p>
<h4 id="作用">作用</h4>
<p><code>docker</code> 建议每一个容器中只运行一个服务，因为 <code>docker</code> 容器本身占用资源很少，所以最好是将每个服务单独的分割开来。但是这样有面临一个问题：</p>
<p>如果需要同时部署好多个服务，难道要每个服务单独写 <code>Dockerfile</code>，然后再构建镜像，构建容器吗？这样太麻烦。所以 <code>docker</code> 官方给提供了 <code>docker-compose</code> 多服务部署的工具。</p>
<p>例如要实现一个 <code>Web</code> 微服务项目，除了 <code>Web</code> 服务容器本身，往往还需要再加上后端的数据库 <code>mysql</code> 服务容器，<code>redis</code> 服务器，注册中心 <code>eureka</code>，甚至还包括负载均衡容器等等……</p>
<p><code>Compose</code> 允许用户通过一个单独的 <code>docker-compose.yml</code> 模板文件（<code>YAML</code>格式）来定义一组相关联的应用容器为一个项目（<code>project</code>）。</p>
<p>可以很容易地用一个配置文件定义一个多容器的应用，然后使用一条指令安装这个应用的所有依赖，完成构建。<code>Docker-Compose</code> 解决了容器与容器之间如何管理编排的问题。</p>
<h4 id="安装">安装</h4>
<p>官网API：https://docs.docker.com/compose/compose-file/compose-file-v3/</p>
<p>下载：https://docs.docker.com/compose/install/</p>
<h5 id="安装步骤">安装步骤</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ sudo curl -L <span style="color:#666;font-style:italic">&#34;https://github.com/docker/compose/releases/download/v2.6.1/docker-compose-</span><span style="font-weight:bold">$(</span>uname -s<span style="font-weight:bold">)</span><span style="color:#666;font-style:italic">-</span><span style="font-weight:bold">$(</span>uname -m<span style="font-weight:bold">)</span><span style="color:#666;font-style:italic">&#34;</span> -o /usr/local/bin/docker-compose
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>$ sudo chmod +x /usr/local/bin/docker-compose
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>$ docker-compose --version
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>Docker Compose version v2.6.1
</span></span></code></pre></div><h5 id="卸载步骤">卸载步骤</h5>
<p>如果使用 <code>curl</code> 方式安装，则卸载 <code>Docker Compose</code>：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ sudo rm /user/local/bin/docker-compose
</span></span></code></pre></div><h3 id="compose核心概念">Compose核心概念</h3>
<h4 id="一文件">一文件</h4>
<pre tabindex="0"><code>docker-compose.yml
</code></pre><h4 id="两要素">两要素</h4>
<ol>
<li>服务（<code>service</code>）：一个个应用容器实例，比如订单微服务、库存微服务、<code>MySQL</code> 容器、<code>Nginx</code> 容器或者 <code>Redis</code> 容器。</li>
<li>工程（<code>project</code>）：由一组关联的应用容器组成的一个<strong>完整业务单元</strong>，在 <code>docker-compose.yml</code> 文件中定义。</li>
</ol>
<h3 id="compose使用的三步骤">Compose使用的三步骤</h3>
<ol>
<li>编写 <code>Dockerfile</code> 定义各个微服务应用并构建出对应的镜像文件</li>
<li>使用 <code>docker-compose.yml</code> 定义一个完整业务单元，安排好整体应用中的各个容器服务。</li>
<li>最后，执行 <code>docker-compose up</code> 命令来启动并运行整个应用程序，完成一键部署上线。</li>
</ol>
<h3 id="compose常用命令">Compose常用命令</h3>
<table>
<thead>
<tr>
<th>常用命令</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>docker-compose -h</td>
<td>查看帮助</td>
</tr>
<tr>
<td>docker-compose up</td>
<td>启动所有docker-compose服务</td>
</tr>
<tr>
<td>docker-compose up -d</td>
<td>启动所有docker-compose服务并后台运行</td>
</tr>
<tr>
<td>docker-compose down</td>
<td>停止并删除容器、网络、卷、镜像</td>
</tr>
<tr>
<td>docker-compose exec yml里面的服务id</td>
<td>进入容器实例内部 docker-compose exec docker-compose.yml文件中写的服务id /bin/bash</td>
</tr>
<tr>
<td>docker-compose ps</td>
<td>展示当前docker-compose编排过的运行的所有容器</td>
</tr>
<tr>
<td>docker-compose top</td>
<td>展示当前docker-compose编排过的容器进程</td>
</tr>
<tr>
<td>docker-compose logs yml里面的服务id</td>
<td>查看容器输出日志</td>
</tr>
<tr>
<td>docker-compose config</td>
<td>检查配置</td>
</tr>
<tr>
<td>docker-compose config -q</td>
<td>检查配置，有问题才有输出</td>
</tr>
<tr>
<td>docker-compose restart</td>
<td>重启服务</td>
</tr>
<tr>
<td>docker-compose start</td>
<td>启动服务</td>
</tr>
<tr>
<td>docker-compose stop</td>
<td>停止服务</td>
</tr>
</tbody>
</table>
<h3 id="compose编排微服务">Compose编排微服务</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>version: <span style="color:#666;font-style:italic">&#34;3&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>services:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>  microService:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>    image: ashley_docker:1.6
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>    container_name: ms01
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>    ports:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>      - <span style="color:#666;font-style:italic">&#34;6001:6001&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>    volumes:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>      - /app/microService:/data
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>    networks:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>      - my_net
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>    depends_on:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>      - redis
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>      - mysql
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>  redis:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>    image: redis:6.0.8
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>    ports:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>      - <span style="color:#666;font-style:italic">&#34;6379:6379&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>    volumes:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>      - /app/redis/redis.conf:/etc/redis/redis.conf
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>      - /app/redis/data:/data
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>    networks:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>      - my_net
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>    command: redis-server /etc/redis/redis.conf
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span>  mysql:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span>    image: mysql:5.7
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span>    environment:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span>      MYSQL_ROOT_PASSWORD: <span style="color:#666;font-style:italic">&#39;123456&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span>      MYSQL_ALLOW_EMPTY_PASSWORD: <span style="color:#666;font-style:italic">&#39;no&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span><span>      MYSQL_DATABASE: <span style="color:#666;font-style:italic">&#39;db2022&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span><span>      MYSQL_USER: <span style="color:#666;font-style:italic">&#39;ashley&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span><span>      MYSQL_PASSWORD: <span style="color:#666;font-style:italic">&#39;password&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span><span>    ports:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span><span>      - <span style="color:#666;font-style:italic">&#34;3306:3306&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span><span>    volumes:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span><span>      - /app/mysql/db:/var/lib/mysql
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span><span>      - /app/mysql/conf/my.cnf:/etc/my.cnf
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span><span>      - /app/mysql/init:/docker-entrypoint-initdb.d
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span><span>    networks:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span><span>      - my_net
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span><span>    command: --default-authentication-plugin=mysql_native_password <span style="color:#888;font-style:italic">#解决外部无法访问</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span><span>networks:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span><span>  my_net:
</span></span></code></pre></div><h2 id="docker轻量级可视化工具portainer">Docker轻量级可视化工具Portainer</h2>
<h3 id="是什么-3">是什么</h3>
<p><code>Portainer</code> 是一款轻量级的应用，它提供了图形化界面，用于方便地管理 <code>Docker</code> 环境，包括单机环境和集群环境。</p>
<h3 id="安装-1">安装</h3>
<h4 id="官网-1">官网</h4>
<ul>
<li><a href="https://www.portainer.io/">https://www.portainer.io/</a></li>
<li><a href="https://docs.portainer.io/start/install/server/docker/linux">https://docs.portainer.io/start/install/server/docker/linux</a></li>
</ul>
<h4 id="步骤-1">步骤</h4>
<ol>
<li><code>docker</code> 命令安装</li>
</ol>
<p>首先，创建用于 <code>Portainer Server</code> 存储数据库的卷：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker volume create portainer_data
</span></span></code></pre></div><p>然后，下载安装 <code>Portainer Server</code> 容器：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker run -d -p 8000:8000 -p 9000:9000 --name portainer --restart=always -v /var/run/docker.sock:/var/run/docker.sock -v portainer_data:/data portainer/portainer-ce:latest
</span></span></code></pre></div><ol>
<li>第一次登陆需创建 <code>admin</code>，访问地址：<code>xxx.xxx.xxx.xxx:9000</code></li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span><span style="">http://192.168.3.6:9000
</span></span></span></code></pre></div><p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/portainer-be-server-setup.png">
            <img class="mx-auto" alt="portainer-be-server-setup" src="https://blog.imw7.com/images/docker/portainer-be-server-setup.png" />
        </a>
    </p>
<ol>
<li>设置 <code>admin</code> 用户和密码后首次登陆</li>
</ol>
<p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/portainer-install-setup-wizard.png">
            <img class="mx-auto" alt="portainer-install-setup-wizard" src="https://blog.imw7.com/images/docker/portainer-install-setup-wizard.png" />
        </a>
    </p>
<ol>
<li>选择 <code>Get Started</code> 选项卡后本地 <code>docker</code> 详细信息展示</li>
</ol>
<p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/portainer_local.png">
            <img class="mx-auto" alt="portainer_local" src="https://blog.imw7.com/images/docker/portainer_local.png" />
        </a>
    </p>
<ol>
<li>上一步的图形展示，能想得起对应命令吗？</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker system df
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>TYPE            TOTAL     ACTIVE    SIZE      RECLAIMABLE
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>Images          12        2         4.168GB   3.577GB (85%)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>Containers      3         3         1.087kB   0B (0%)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>Local Volumes   35        1         1.482GB   1.481GB (99%)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span><span>Build Cache     0         0         0B        0B
</span></span></code></pre></div><h3 id="登陆并演示介绍常用操作案例">登陆并演示介绍常用操作案例</h3>
<h4 id="安装nginx">安装Nginx</h4>
<p>第1步：</p>
<p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/portainer_nginx.png">
            <img class="mx-auto" alt="portainer_nginx" src="https://blog.imw7.com/images/docker/portainer_nginx.png" />
        </a>
    </p>
<p>第2步：</p>
<p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/portainer_nginx2.png">
            <img class="mx-auto" alt="portainer_nginx2" src="https://blog.imw7.com/images/docker/portainer_nginx2.png" />
        </a>
    </p>
<p>第3步：</p>
<p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/portainer_nginx3.png">
            <img class="mx-auto" alt="portainer_nginx3" src="https://blog.imw7.com/images/docker/portainer_nginx3.png" />
        </a>
    </p>
<h2 id="docker容器监控之cadvisorinfluxdbgrafana">Docker容器监控之cAdvisor+InfluxDB+Grafana</h2>
<h3 id="原生命令">原生命令</h3>
<h4 id="操作">操作</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker ps
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>CONTAINER ID   IMAGE         COMMAND                  CREATED          STATUS          PORTS                                                  NAMES
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>c6ea2ba401f3   redis:6.0.8   <span style="color:#666;font-style:italic">&#34;docker-entrypoint.s…&#34;</span>   38 seconds ago   Up 37 seconds   0.0.0.0:6379-&gt;6379/tcp, :::6379-&gt;6379/tcp              confident_davinci
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>3c83a749a7d5   mysql:5.7     <span style="color:#666;font-style:italic">&#34;docker-entrypoint.s…&#34;</span>   2 minutes ago    Up 2 minutes    0.0.0.0:3306-&gt;3306/tcp, :::3306-&gt;3306/tcp, 33060/tcp   laughing_ardinghelli
</span></span></code></pre></div><p><code>docker stats</code> 命令的结果：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>CONTAINER ID   NAME                   CPU %     MEM USAGE / LIMIT    MEM %     NET I/O       BLOCK I/O     PIDS
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>c6ea2ba401f3   confident_davinci      0.00%     1000KiB / 7.472GiB   0.01%     4.06kB / 0B   279kB / 0B    1
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>3c83a749a7d5   laughing_ardinghelli   0.00%     832KiB / 7.472GiB    0.01%     4.28kB / 0B   8.19kB / 0B   1
</span></span></code></pre></div><h4 id="问题">问题</h4>
<p>通过 <code>docker stats</code> 命令可以很方便的看到当前宿主机上所有容器的 <code>CPU</code>，内存以及网络流量等数据，一般小公司够用了。</p>
<p>但是，<code>docker stats</code> 统计结果只能是当前宿主机的全部容器，数据资料是实时的，没有地方存储、没有健康指标过线预警等功能。</p>
<h3 id="是什么-4">是什么</h3>
<h4 id="容器监控3剑客">容器监控3剑客</h4>
<p><code>cAdvisor</code> 监控收集 + <code>InfluxDB</code> 存储数据 + <code>Grafana</code> 展示图标</p>
<p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/cig.png">
            <img class="mx-auto" alt="cig" src="https://blog.imw7.com/images/docker/cig.png" />
        </a>
    </p>
<h5 id="cadvisor">cAdvisor</h5>
<p><code>cAdvisor</code> 是一个容器资源监控工具，包括容器的内存，<code>CPU</code>，网络 <code>IO</code>，磁盘 <code>IO</code> 等监控，同时提供了一个 <code>WEB</code> 页面用于查看容器的实时运行状态。<code>cAdvisor</code> 默认存储2分钟的数据，而且只是针对单物理机。不过，<code>cAdvisor</code> 提供了很多数据集成接口，支持 <code>InfluxDB</code>，<code>Redis</code>，<code>Kafka</code>，<code>Elasticsearch</code> 等集成，可以加上对应配置将监控数据发往这些数据库存储起来。</p>
<p><code>cAdvisor</code> 功能主要有两点：</p>
<ul>
<li>展示 <code>Host</code> 和容器两个层次的监控数据。</li>
<li>展示历史变化数据。</li>
</ul>
<h5 id="influxdb">InfluxDB</h5>
<p><code>InfluxDB</code> 是用 <code>Go</code> 语言编写的一个开源分布式时序、事件和指标数据库，无需外部依赖。</p>
<p><code>cAdvisor</code> 默认只在本机保存最近2分钟的数据，为了持久化存储数据和统一收集展示监控数据，需要将数据存储到 <code>InfluxDB</code> 中。<code>InfluxDB</code> 是一个时序数据库，专门用于存储时序相关数据，很适合存储 <code>cAdvisor</code> 的数据。而且，<code>cAdvisor</code> 本身已经提供了 <code>InfluxDB</code> 的集成方法，启动容器时指定配置即可。</p>
<p><code>InfluxDB</code> 主要功能：</p>
<ul>
<li>基于时间序列，支持与时间有关的相关函数（如最大、最小、求和等）；</li>
<li>可度量性：可以实时对大量数据进行计算；</li>
<li>基于事件：支持任意的事件数据。</li>
</ul>
<h5 id="grafana">Grafana</h5>
<p><code>Grafana</code> 是一个开源的数据监控分析可视化平台，支持多种数据源配置（支持的数据源包括 <code>InfluxDB</code>，<code>MySQL</code>，<code>Elasticsearch</code>，<code>OpenTSDB</code>，<code>Graphite</code>等）和丰富的插件及模板功能，支持图标权限控制和报警。</p>
<p><code>Grafana</code> 主要特性：</p>
<ul>
<li>灵活丰富的图形化选项</li>
<li>可以混合多种风格</li>
<li>支持白天和夜间模式</li>
<li>多个数据源</li>
</ul>
<h5 id="总结">总结</h5>
<p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/cig_summary.png">
            <img class="mx-auto" alt="cig_summary" src="https://blog.imw7.com/images/docker/cig_summary.png" />
        </a>
    </p>
<h3 id="compose容器编排">compose容器编排</h3>
<h4 id="新建目录">新建目录</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ <span style="font-weight:bold;font-style:italic">cd</span> /myfile
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>$ mkdir cig
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>$ <span style="font-weight:bold;font-style:italic">cd</span> cig
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>$ <span style="font-weight:bold;font-style:italic">pwd</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>/myfile/cig
</span></span></code></pre></div><h4 id="新建3件套组合的-docker-composeyml">新建3件套组合的 docker-compose.yml</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>version: <span style="color:#666;font-style:italic">&#39;3.1&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>volumes:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>  grafana_data: {}
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>services:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>  influxdb:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>    image: tutum/influxdb:0.9
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>    restart: always
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>    environment:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>      - PRE_CREATE_DB=cadvisor
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>    ports:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>      - <span style="color:#666;font-style:italic">&#34;8083:8083&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>      - <span style="color:#666;font-style:italic">&#34;8086:8086&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>    volumes:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>      - ./data/influxdb:/data
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>  cadvisor:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>    image: google/cadvisor
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>    links:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>      - influxdb:influxsrv
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>    command: -storage_driver=influxdb -storage_driver_db=cadvisor -storage_driver_host=influxsrv:8086
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>    restart: always
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>    ports:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>      - <span style="color:#666;font-style:italic">&#34;8080:8080&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>    volumes:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>      - /:/rootfs:ro
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span>      - /var/run:/var/run:rw
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span>      - /sys:/sys:ro
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span>      - /var/lib/docker/:/var/lib/docker:ro
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span>  grafana:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span><span>    user: <span style="color:#666;font-style:italic">&#34;104&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span><span>    image: grafana/grafana
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span><span>    user: <span style="color:#666;font-style:italic">&#34;104&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span><span>    restart: always
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span><span>    links:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span><span>      - influxdb:influxsrv
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span><span>    ports:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span><span>      - <span style="color:#666;font-style:italic">&#34;3000:3000&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span><span>    volumes:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span><span>      - grafana_data:/var/lib/grafana
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span><span>    environment:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span><span>      - HTTP_USER=admin
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span><span>      - HTTP_PASS=admin
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span><span>      - INFLUXDB_HOST=influxsrv
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span><span>      - INFLUXDB_PORT=8086
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48</span><span>      - INFLUXDB_NAME=cadvisor
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49</span><span>      - INFLUXDB_USER=root
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50</span><span>      - INFLUXDB_PASS=root
</span></span></code></pre></div><h4 id="启动docker-compose文件">启动docker-compose文件</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker-compose up -d
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>[+] Running 3/3
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span> ⠿ Container cig-influxdb-1  Started                      0.4s
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span> ⠿ Container cig-cadvisor-1  Started                      1.2s
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span> ⠿ Container cig-grafana-1   Started                      1.1s
</span></span></code></pre></div><h4 id="查看三个服务容器是否启动">查看三个服务容器是否启动</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker ps
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>CONTAINER ID   IMAGE                 COMMAND                  CREATED        STATUS         PORTS                                                                                            NAMES
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>cbc0cbdf3ed3   grafana/grafana      <span style="color:#666;font-style:italic">&#34;/run.sh&#34;</span>                2 minutes ago   Up 2 minutes   0.0.0.0:3000-&gt;3000/tcp, :::3000-&gt;3000/tcp                                                  cig-grafana-1
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>b54a3397a0ce   google/cadvisor      <span style="color:#666;font-style:italic">&#34;/usr/bin/cadvisor -…&#34;</span>   2 minutes ago   Up 2 minutes   0.0.0.0:8080-&gt;8080/tcp, :::8080-&gt;8080/tcp                                                  cig-cadvisor-1
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>6d0afcf4350d   tutum/influxdb:0.9   <span style="color:#666;font-style:italic">&#34;/run.sh&#34;</span>                2 minutes ago   Up 2 minutes   0.0.0.0:8083-&gt;8083/tcp, :::8083-&gt;8083/tcp, 0.0.0.0:8086-&gt;8086/tcp, :::8086-&gt;8086/tcp       cig-influxdb-1
</span></span></code></pre></div><h4 id="测试">测试</h4>
<h5 id="浏览-cadvisor-收集服务httpip8080">浏览 <code>cAdvisor</code> <strong>收集</strong>服务，<code>http://ip:8080/</code></h5>
<p>第一次访问慢，请稍等。<code>cAdvisor</code> 也有基础的图形展现功能，这里主要用它来做数据采集。</p>
<p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/cadvisor.png">
            <img class="mx-auto" alt="cadvisor" src="https://blog.imw7.com/images/docker/cadvisor.png" />
        </a>
    </p>
<h5 id="浏览-influxdb-存储服务httpip8083">浏览 <code>InfluxDB</code> <strong>存储</strong>服务，<code>http://ip:8083/</code></h5>
<h5 id="浏览-grafana-展现服务httpip3000">浏览 <code>Grafana</code> <strong>展现</strong>服务，<code>http://ip:3000/</code></h5>
<p>用 <code>ip:3000</code> 的方式访问，默认账户密码均为 <code>admin</code>。</p>
<p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/grafana_login.png">
            <img class="mx-auto" alt="grafana_login" src="https://blog.imw7.com/images/docker/grafana_login.png" />
        </a>
    </p>
<p>配置步骤：</p>
<p>1、配置数据源</p>
<p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/grafana1.png">
            <img class="mx-auto" alt="grafana1" src="https://blog.imw7.com/images/docker/grafana1.png" />
        </a>
    </p>
<p>2、选择 <code>InfluxDB</code> 数据源</p>
<p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/grafana2.png">
            <img class="mx-auto" alt="grafana2" src="https://blog.imw7.com/images/docker/grafana2.png" />
        </a>
    </p>
<p>3、配置细节</p>
<p>① 填入 <code>Name</code> 和 <code>URL</code>：</p>
<p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/grafana3.png">
            <img class="mx-auto" alt="grafana3" src="https://blog.imw7.com/images/docker/grafana3.png" />
        </a>
    </p>
<p>② 填入数据，点击 <code>Save &amp; test</code> 按钮：</p>
<p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/grafana4.png">
            <img class="mx-auto" alt="grafana4" src="https://blog.imw7.com/images/docker/grafana4.png" />
        </a>
    </p>
<p>4、配置面板</p>
<p>① 创建仪表盘</p>
<p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/grafana5.png">
            <img class="mx-auto" alt="grafana5" src="https://blog.imw7.com/images/docker/grafana5.png" />
        </a>
    </p>
<p>② 选择新增面盘</p>
<p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/grafana6.png">
            <img class="mx-auto" alt="grafana6" src="https://blog.imw7.com/images/docker/grafana6.png" />
        </a>
    </p>
<p>③ 选择仪表盘样式</p>
<p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/grafana7.png">
            <img class="mx-auto" alt="grafana7" src="https://blog.imw7.com/images/docker/grafana7.png" />
        </a>
    </p>
<p>④ 选择 <code>Graph (old)</code> 作为仪表盘样式</p>
<p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/grafana8.png">
            <img class="mx-auto" alt="grafana8" src="https://blog.imw7.com/images/docker/grafana8.png" />
        </a>
    </p>
<p>⑤ 填写相应的数据</p>
<p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/grafana9.png">
            <img class="mx-auto" alt="grafana9" src="https://blog.imw7.com/images/docker/grafana9.png" />
        </a>
    </p>
<p>⑥ 完成</p>
<p>
        <a data-fancybox="gallery" href="https://blog.imw7.com/images/docker/grafana10.png">
            <img class="mx-auto" alt="grafana10" src="https://blog.imw7.com/images/docker/grafana10.png" />
        </a>
    </p>
<p>到这里 <code>cAdvisor</code> + <code>InfluxDB</code> + <code>Grafana</code> 容器监控系统就部署完成了。</p>
        </div>

        


        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="/post/docker_guide/">Docker简易指南</a></li>
        
        <li><a href="/post/about_docker/">Docker的安装与使用</a></li>
        
        <li><a href="/post/Go/makefile/">为Go项目编写Makefile</a></li>
        
        <li><a href="/post/Go/go_micro/">go-micro</a></li>
        
        <li><a href="/post/Go/viper_tutorial/">Go语言配置管理神器——Viper中文教程</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='/tags/Docker'>Docker</a></li>
                
                <li><a href='/tags/%E5%B8%B8%E7%94%A8%E7%BB%84%E4%BB%B6%E5%92%8C%E6%8A%80%E5%B7%A7'>常用组件和技巧</a></li>
                
            </ul>
            
        </div>
    </article>
    
    

    
    
    
    

</div>

                    <footer id="footer">
    <script type="text/javascript"
        async
        src="https://cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[\[','\]\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});

MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<style>
code.has-jax {
    font: inherit;
    font-size: 100%;
    background: inherit;
    border: inherit;
    color: #515151;
}
</style>

    <div>
        &copy; 2022 <a href="https://blog.imw7.com/">魏奇的博客 By 魏奇</a>
        
        | <a rel="nofollow" target="_blank" href="http://beian.miit.gov.cn/">蜀ICP备2022000811号-1</a>
        
    </div>
    <br />
    <div>
        <div class="github-badge">
            <a href="https://gohugo.io/" target="_black" rel="nofollow"><span class="badge-subject">Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
        </div>
        <div class="github-badge">
            <a href="https://www.flysnow.org/" target="_black"><span class="badge-subject">Design by</span><span class="badge-value bg-brightgreen">飞雪无情</span></a>
        </div>
        <div class="github-badge">
            <a href="https://github.com/flysnow-org/maupassant-hugo" target="_black"><span class="badge-subject">Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a>
        </div>
    </div>
</footer>


    
    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script><script src="//cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js"></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>
    <script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>




    <script src='/js/douban.js'></script>


                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='https://blog.imw7.com/search' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://blog.imw7.com/">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://blog.imw7.com/post/beego_guide/" title="Beego使用指南">Beego使用指南</a>
    </li>
    
    <li>
        <a href="https://blog.imw7.com/post/hugo_guide/" title="Hugo使用指南">Hugo使用指南</a>
    </li>
    
    <li>
        <a href="https://blog.imw7.com/post/docker_advanced/" title="Docker进阶指南">Docker进阶指南</a>
    </li>
    
    <li>
        <a href="https://blog.imw7.com/post/docker_guide/" title="Docker简易指南">Docker简易指南</a>
    </li>
    
    <li>
        <a href="https://blog.imw7.com/post/Go/fastdfs/" title="FastDFS">FastDFS</a>
    </li>
    
    <li>
        <a href="https://blog.imw7.com/post/mysql/" title="在CentOS7.x上安装MySQL8.0">在CentOS7.x上安装MySQL8.0</a>
    </li>
    
    <li>
        <a href="https://blog.imw7.com/post/redis_on_centos/" title="CentOS与Redis">CentOS与Redis</a>
    </li>
    
    <li>
        <a href="https://blog.imw7.com/post/ssh/" title="SSH使用指南">SSH使用指南</a>
    </li>
    
    <li>
        <a href="https://blog.imw7.com/post/http/" title="HTTP协议">HTTP协议</a>
    </li>
    
    <li>
        <a href="https://blog.imw7.com/post/Go/project_struct/" title="一般项目的结构">一般项目的结构</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title"><a href='/categories/'>分类</a></h3>
<ul class="widget-list">
    
    <li><a href="https://blog.imw7.com/categories/Beego/">Beego (1)</a></li>
    
    <li><a href="https://blog.imw7.com/categories/Docker/">Docker (3)</a></li>
    
    <li><a href="https://blog.imw7.com/categories/Go/">Go (53)</a></li>
    
    <li><a href="https://blog.imw7.com/categories/Hexo/">Hexo (1)</a></li>
    
    <li><a href="https://blog.imw7.com/categories/Hugo/">Hugo (1)</a></li>
    
    <li><a href="https://blog.imw7.com/categories/git/">git (1)</a></li>
    
    <li><a href="https://blog.imw7.com/categories/%E5%85%B6%E4%BB%96/">其他 (1)</a></li>
    
    <li><a href="https://blog.imw7.com/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8/">服务器 (3)</a></li>
    
    <li><a href="https://blog.imw7.com/categories/%E7%AE%97%E6%B3%95/">算法 (1)</a></li>
    
    <li><a href="https://blog.imw7.com/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络 (1)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags/'>标签</a></h3>
<div class="tagcloud">
    
    <a href="https://blog.imw7.com/tags/Bcrypt/">Bcrypt</a>
    
    <a href="https://blog.imw7.com/tags/Beego/">Beego</a>
    
    <a href="https://blog.imw7.com/tags/Cookie/">Cookie</a>
    
    <a href="https://blog.imw7.com/tags/Docker/">Docker</a>
    
    <a href="https://blog.imw7.com/tags/ES/">ES</a>
    
    <a href="https://blog.imw7.com/tags/Firefox/">Firefox</a>
    
    <a href="https://blog.imw7.com/tags/GMP/">GMP</a>
    
    <a href="https://blog.imw7.com/tags/HDMI/">HDMI</a>
    
    <a href="https://blog.imw7.com/tags/Hexo/">Hexo</a>
    
    <a href="https://blog.imw7.com/tags/Hugo/">Hugo</a>
    
    <a href="https://blog.imw7.com/tags/Kafka/">Kafka</a>
    
    <a href="https://blog.imw7.com/tags/Kibana/">Kibana</a>
    
    <a href="https://blog.imw7.com/tags/Linux/">Linux</a>
    
    <a href="https://blog.imw7.com/tags/MongoDB/">MongoDB</a>
    
    <a href="https://blog.imw7.com/tags/MySQL/">MySQL</a>
    
    <a href="https://blog.imw7.com/tags/NSQ/">NSQ</a>
    
    <a href="https://blog.imw7.com/tags/Redis/">Redis</a>
    
    <a href="https://blog.imw7.com/tags/Session/">Session</a>
    
    <a href="https://blog.imw7.com/tags/Ubuntu/">Ubuntu</a>
    
    <a href="https://blog.imw7.com/tags/VS-Code/">VS Code</a>
    
    <a href="https://blog.imw7.com/tags/Web%E5%BC%80%E5%8F%91/">Web开发</a>
    
    <a href="https://blog.imw7.com/tags/centos/">centos</a>
    
    <a href="https://blog.imw7.com/tags/channel/">channel</a>
    
    <a href="https://blog.imw7.com/tags/context/">context</a>
    
    <a href="https://blog.imw7.com/tags/etcd/">etcd</a>
    
    <a href="https://blog.imw7.com/tags/fastdfs/">fastdfs</a>
    
    <a href="https://blog.imw7.com/tags/flag/">flag</a>
    
    <a href="https://blog.imw7.com/tags/fmt/">fmt</a>
    
    <a href="https://blog.imw7.com/tags/gin/">gin</a>
    
    <a href="https://blog.imw7.com/tags/git/">git</a>
    
    <a href="https://blog.imw7.com/tags/go-micro/">go-micro</a>
    
    <a href="https://blog.imw7.com/tags/go-module/">go module</a>
    
    <a href="https://blog.imw7.com/tags/goroutine/">goroutine</a>
    
    <a href="https://blog.imw7.com/tags/grpc/">grpc</a>
    
    <a href="https://blog.imw7.com/tags/http/">http</a>
    
    <a href="https://blog.imw7.com/tags/interface/">interface</a>
    
    <a href="https://blog.imw7.com/tags/iota/">iota</a>
    
    <a href="https://blog.imw7.com/tags/jwt/">jwt</a>
    
    <a href="https://blog.imw7.com/tags/log/">log</a>
    
    <a href="https://blog.imw7.com/tags/logrus/">logrus</a>
    
    <a href="https://blog.imw7.com/tags/makefile/">makefile</a>
    
    <a href="https://blog.imw7.com/tags/map/">map</a>
    
    <a href="https://blog.imw7.com/tags/MySQL/">MySQL</a>
    
    <a href="https://blog.imw7.com/tags/net/http/">net/http</a>
    
    <a href="https://blog.imw7.com/tags/os.Args/">os.Args</a>
    
    <a href="https://blog.imw7.com/tags/package/">package</a>
    
    <a href="https://blog.imw7.com/tags/pprof/">pprof</a>
    
    <a href="https://blog.imw7.com/tags/protobuf/">protobuf</a>
    
    <a href="https://blog.imw7.com/tags/sarama/">sarama</a>
    
    <a href="https://blog.imw7.com/tags/sqlx/">sqlx</a>
    
    <a href="https://blog.imw7.com/tags/ssh/">ssh</a>
    
    <a href="https://blog.imw7.com/tags/strconv/">strconv</a>
    
    <a href="https://blog.imw7.com/tags/tailf/">tailf</a>
    
    <a href="https://blog.imw7.com/tags/template/">template</a>
    
    <a href="https://blog.imw7.com/tags/time/">time</a>
    
    <a href="https://blog.imw7.com/tags/viper/">viper</a>
    
    <a href="https://blog.imw7.com/tags/yilia/">yilia</a>
    
    <a href="https://blog.imw7.com/tags/%E4%B8%8A%E4%BC%A0/">上传</a>
    
    <a href="https://blog.imw7.com/tags/%E4%B8%8B%E8%BD%BD/">下载</a>
    
    <a href="https://blog.imw7.com/tags/%E4%BE%9D%E8%B5%96%E7%AE%A1%E7%90%86/">依赖管理</a>
    
    <a href="https://blog.imw7.com/tags/%E5%87%BD%E6%95%B0/">函数</a>
    
    <a href="https://blog.imw7.com/tags/%E5%88%87%E7%89%87/">切片</a>
    
    <a href="https://blog.imw7.com/tags/%E5%8F%8D%E5%B0%84/">反射</a>
    
    <a href="https://blog.imw7.com/tags/%E5%8F%98%E9%87%8F%E5%92%8C%E5%B8%B8%E9%87%8F/">变量和常量</a>
    
    <a href="https://blog.imw7.com/tags/%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/">基本数据类型</a>
    
    <a href="https://blog.imw7.com/tags/%E5%9F%BA%E7%A1%80/">基础</a>
    
    <a href="https://blog.imw7.com/tags/%E5%AF%86%E7%A0%81%E5%8A%A0%E5%AF%86/">密码加密</a>
    
    <a href="https://blog.imw7.com/tags/%E5%AF%BC%E5%85%A5%E6%9C%AC%E5%9C%B0%E5%8C%85/">导入本地包</a>
    
    <a href="https://blog.imw7.com/tags/%E5%B8%B8%E7%94%A8%E6%A1%86%E6%9E%B6%E5%92%8C%E7%BB%84%E4%BB%B6/">常用框架和组件</a>
    
    <a href="https://blog.imw7.com/tags/%E5%B8%B8%E7%94%A8%E7%BB%84%E4%BB%B6%E4%B8%8E%E6%8A%80%E5%B7%A7/">常用组件与技巧</a>
    
    <a href="https://blog.imw7.com/tags/%E5%B8%B8%E7%94%A8%E7%BB%84%E4%BB%B6%E5%92%8C%E6%8A%80%E5%B7%A7/">常用组件和技巧</a>
    
    <a href="https://blog.imw7.com/tags/%E5%B9%B6%E5%8F%91/">并发</a>
    
    <a href="https://blog.imw7.com/tags/%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87/">开发环境准备</a>
    
    <a href="https://blog.imw7.com/tags/%E5%BC%82%E6%88%96/">异或</a>
    
    <a href="https://blog.imw7.com/tags/%E6%8C%87%E9%92%88/">指针</a>
    
    <a href="https://blog.imw7.com/tags/%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95/">排序算法</a>
    
    <a href="https://blog.imw7.com/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a>
    
    <a href="https://blog.imw7.com/tags/%E6%95%B0%E7%BB%84/">数组</a>
    
    <a href="https://blog.imw7.com/tags/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C/">文件操作</a>
    
    <a href="https://blog.imw7.com/tags/%E6%A0%87%E5%87%86%E5%BA%93/">标准库</a>
    
    <a href="https://blog.imw7.com/tags/%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/">流程控制</a>
    
    <a href="https://blog.imw7.com/tags/%E6%B5%8B%E8%AF%95/">测试</a>
    
    <a href="https://blog.imw7.com/tags/%E7%B1%BB%E5%9E%8B%E6%96%AD%E8%A8%80/">类型断言</a>
    
    <a href="https://blog.imw7.com/tags/%E7%BB%93%E6%9E%84%E4%BD%93/">结构体</a>
    
    <a href="https://blog.imw7.com/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/">网络编程</a>
    
    <a href="https://blog.imw7.com/tags/%E8%B7%A8%E5%B9%B3%E5%8F%B0%E7%BC%96%E8%AF%91/">跨平台编译</a>
    
    <a href="https://blog.imw7.com/tags/%E8%BF%90%E7%AE%97%E7%AC%A6/">运算符</a>
    
    <a href="https://blog.imw7.com/tags/%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84/">项目结构</a>
    
</div>
    </section>

    
<section class="widget">
    <h3 class="widget-title">友情链接</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="https://blog.imw7.com/" title="魏奇的博客">魏奇的博客</a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="https://blog.imw7.com/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
</body>

</html>